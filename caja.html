<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manejo de Caja - Paris Laundry</title>
  <link rel="icon" href="./img/Paris Laundry 1.png" type="image/png">
  <link rel="stylesheet" href="./css/styles_caja.css">
  <link rel="stylesheet" href="./css/styles_menu.css">
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
  <script src="./js/menu - empleados.js" defer></script>
</head>

<body>


  <div class="MasterBox0">

    <laundry-menu></laundry-menu>


    <!-- Contenedor de inventario -->
    <div class="container_caja">

      <!-- Titulo -->
      <div class="panelCaja_tittle">
        <h2>Manejo de Caja</h2>
      </div>
      <!-- Titulo FIN -->


      <!-- body -->
      <div class="panelCaja_body">
        <!-- Botón para abrir el modal -->

        <div class="button-list">
          <div class="space_button">
            <button id="openModalInicialCaja"><img src="./img/icon/iniciar_caja1.png">Iniciar Caja</button>
            <button id="openModalButton"><img src="./img/icon/cuadre_caja1.png">Cuadre de Caja</button>
            <button id="openCierreCajaModal"><img src="./img/icon/cerrar_caja1.png">Cierre de Caja</button>
            <button id="openRetiroEmpleadoModal"><img src="./img/icon/retirar_dinero1.png">Retiro por Empleado</button>
          </div>
          <div class="space_button">
            <button id="openIngresarDineroModal"><img src="./img/icon/ingresar_efectivo2.png">Ingresar Efectivo</button>
            <button id="openRetirarDineroModal"><img src="./img/icon/retirar_efectivo2.png">Retirar Efectivo</button>
            <button id="openHistorialModal"><img src="./img/icon/historial1.png">Historial</button>
          </div>
        </div>



        <div style="display: inline-flex;justify-content: space-between;">
          <!-- Cuadro de Totales en Caja -->
          <div id="totalesCaja">
            <h2 style="margin-block-start: 7px;margin-block-end: 7px;">Totales de Caja</h2>

            <div id="cuadreCajaInfo"><img src="./img/icon/cuadre_caja1.png">
              <span>Ultimo Cuadre de Caja: <br><span id="cuadreCajaHora"></span></span>
            </div>
            <P>

            <div style="display: inline-flex;flex-direction: row;gap: 5px;">
              <p style="margin-block-start: 0px;margin-block-end: 0px;">
                <strong>Monto Inicial:</strong>
              </p>
              <div id="totalEnCaja">RD$0</div>
            </div>

            <div id="totalRecibido">Total Recibido: RD$0</div>
            <div id="totalCambio">Total Cambio: RD$0</div>

            <div style="display: inline-flex;flex-direction: column;">
              <div style="display: inline-flex;flex-direction: row;gap: 5px;">
                <p style="margin-block-start: 0px;margin-block-end: 0px;">
                  Total Gastado: </p>
                <div id="totalGastado">RD$0</div>
              </div>

              <div style="display: inline-flex;flex-direction: row;gap: 5px;">
                <p style="margin-block-start: 0px;margin-block-end: 0px;">
                  <strong>Total que Debe Haber en Caja:</strong>
                </p>
                <div id="totalDeberia">RD$0</div>
              </div>
            </div>


          </div>
          <!-- Cuadro de Totales en Caja FIN -->



          <!-- Cuadro Inicio y Cierre de Caja -->
          <div style="margin-top: 14px;">
            <div id="inicioCajaInfo" style="display: none;">
              <div style="display: inline-flex;flex-direction: column;align-items: center;">
                <h2 style="color: #549bff;">Caja Abierta</h2>
                <img src="./img/icon/iniciar_caja1.png">
                <span><span id="inicioCajaHora"></span></span>
              </div>
            </div>

            <div id="cierreCajaInfo" style="display: none;">
              <div style="display: inline-flex;flex-direction: column;align-items: center;">
                <h2>Caja Cerrada</h2>
                <img src="./img/icon/cerrar_caja1.png">
                <span><span id="cierreCajaHoraDisplay"></span></span>
              </div>
            </div>
          </div>
          <!-- Cuadro Inicio y Cierre de Caja FIN -->
        </div>



        <!-- Tabla para mostrar las facturas -->
        <h2>Facturas en efectivo generadas desde el inicio de la caja:</h2>
        <table id="facturasTable">
          <thead>
            <tr>
              <th id="NumeroTabla">No.</th>
              <th>ID</th>
              <th>Nombre del Cliente</th>
              <th>Teléfono del Cliente</th>
              <th>Método de Pago</th>
              <th>Monto Recibido</th>
              <th>Cambio</th>
              <th>Total</th>
              <th>Fecha y Hora</th>
            </tr>
          </thead>
          <tbody>
            <!-- Las filas de las facturas se agregarán aquí -->
          </tbody>
        </table>
        <!-- Tabla para mostrar las facturas FIN -->



        <!-- Nueva tabla para otras facturas -->
<h2>Otras facturas del día (no afectan la caja):</h2>
<table id="otrasFacturasTable">
  <thead>
    <tr>
      <th id="NumeroTabla">No.</th>
      <th>ID</th>
      <th>Nombre del Cliente</th>
      <th>Teléfono del Cliente</th>
      <th>Método de Pago</th>
      <th>Total</th>
      <th>Fecha y Hora</th>
    </tr>
  </thead>
  <tbody>
    <!-- Las filas de las otras facturas se agregarán aquí -->
  </tbody>
</table>
<!-- Nueva tabla para otras facturas FIN -->



      </div>

      <!-- Down -->
      <div class="panelCaja_down">
        <p>© Paris Laundry RD - 2025</p>
      </div>
      <!-- Down FIN -->


    </div>

    <!-- Modal para Cuadre de Caja -->
    <div id="cuadreModal" class="modal">
      <div class="modal-content">

        <div class="modal_caja_tittle">
          <span class="close">&times;</span>
          <h2>Cuadre de Caja</h2>
        </div>

        <div class="modal_caja_body">
          <div class="modal_caja_flex">
            <form id="cuadreForm">
              <div class="CashContainer">
                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/2000.jpg">
                  <label for="denomination2000_modal">Billetes de 2000:</label>
                  <input type="number" id="denomination2000_modal" placeholder="0">

                  <img src="./img/Money Icon/1000.jpg">
                  <label for="denomination1000_modal">Billetes de 1000:</label>
                  <input type="number" id="denomination1000_modal" placeholder="0">

                  <img src="./img/Money Icon/500.jpg">
                  <label for="denomination500_modal">Billetes de 500:</label>
                  <input type="number" id="denomination500_modal" placeholder="0">

                  <img src="./img/Money Icon/200.jpg">
                  <label for="denomination200_modal">Billetes de 200:</label>
                  <input type="number" id="denomination200_modal" placeholder="0">

                  <img src="./img/Money Icon/100.jpg">
                  <label for="denomination100_modal">Billetes de 100:</label>
                  <input type="number" id="denomination100_modal" placeholder="0">
                </div>

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/50.jpg">
                  <label for="denomination50_modal">Billetes de 50:</label>
                  <input type="number" id="denomination50_modal" placeholder="0">

                  <img src="./img/Money Icon/25.png">
                  <label for="denomination25_modal">Monedas de 25:</label>
                  <input type="number" id="denomination25_modal" placeholder="0">

                  <img src="./img/Money Icon/10.png">
                  <label for="denomination10_modal">Billetes de 10:</label>
                  <input type="number" id="denomination10_modal" placeholder="0">

                  <img src="./img/Money Icon/5.png">
                  <label for="denomination5_modal">Billetes de 5:</label>
                  <input type="number" id="denomination5_modal" placeholder="0">

                  <img src="./img/Money Icon/1.png">
                  <label for="denomination1_modal">Billetes de 1:</label>
                  <input type="number" id="denomination1_modal" placeholder="0">
                </div>
              </div>

          </div>
        </div>

        <div class="modal_caja_down">

          <div style="display: inline-flex;flex-direction: column;align-items: center;">
            <p>Total en Caja:</p>
            <div id="modalTotalDeberia">RD$0</div>
          </div>

                  <!-- Select para empleados -->
          <div class="empleadoYbtn">
            <div style="display: inline-flex;flex-direction: column;align-items: center;">
              <div id="modalStatusCuadre" style="color: rgb(255, 71, 71); margin-bottom: 4px;"></div>
              <!-- Nuevo div para el estado -->

              <div style="display: inline-flex;flex-direction: column;">
                <label for="empleadoSelectCuadre"></label>
                <select id="empleadoSelectCuadre" required style="padding: 8px;">
                  <option value="">Seleccione un empleado</option>
              </div>
              <!-- Las opciones se llenarán con JavaScript -->
              </select>
            </div>
          </div>
          <button type="submit">Validar Cuadre</button>
        </div>

        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total Contado:</p>
          <div id="modalTotalAmount">RD$0</div>
        </div>

        </form>
      </div>

    </div>
  </div>
  <!-- Modal para Cuadre de Caja FIN -->




  <!-- Modal para Iniciar Caja -->
  <div id="ModalInicialCaja" class="modal">
    <div class="modal-content">
      <div class="modal_caja_tittle">
        <span class="close">&times;</span>
        <h2>Iniciar Caja</h2>
      </div>

      <div class="modal_caja_body">
        <div class="modal_caja_flex">
          <!-- Formulario de solo lectura -->
          <form id="readOnlyForm" style="display: flex;">
            <div class="CashContainer_master">
              <div class="Casstittle">
                <h2>Efectivo en Caja</h2>
              </div>
              <div class="CashContainer">
                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/2000.jpg">
                  <label for="denomination2000_read">Billetes de 2000:</label>
                  <input type="number" id="denomination2000_read" placeholder="0" readonly>

                  <img src="./img/Money Icon/1000.jpg">
                  <label for="denomination1000_read">Billetes de 1000:</label>
                  <input type="number" id="denomination1000_read" placeholder="0" readonly>

                  <img src="./img/Money Icon/500.jpg">
                  <label for="denomination500_read">Billetes de 500:</label>
                  <input type="number" id="denomination500_read" placeholder="0" readonly>

                  <img src="./img/Money Icon/200.jpg">
                  <label for="denomination200_read">Billetes de 200:</label>
                  <input type="number" id="denomination200_read" placeholder="0" readonly>

                  <img src="./img/Money Icon/100.jpg">
                  <label for="denomination100_read">Billetes de 100:</label>
                  <input type="number" id="denomination100_read" placeholder="0" readonly>
                </div>

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/50.jpg">
                  <label for="denomination50_read">Billetes de 50:</label>
                  <input type="number" id="denomination50_read" placeholder="0" readonly>

                  <img src="./img/Money Icon/25.png">
                  <label for="denomination25_read">Monedas de 25:</label>
                  <input type="number" id="denomination25_read" placeholder="0" readonly>

                  <img src="./img/Money Icon/10.png">
                  <label for="denomination10_read">Monedas de 10:</label>
                  <input type="number" id="denomination10_read" placeholder="0" readonly>

                  <img src="./img/Money Icon/5.png">
                  <label for="denomination5_read">Monedas de 5:</label>
                  <input type="number" id="denomination5_read" placeholder="0" readonly>

                  <img src="./img/Money Icon/1.png">
                  <label for="denomination1_read">Monedas de 1:</label>
                  <input type="number" id="denomination1_read" placeholder="0" readonly>
                </div>
              </div>
            </div>
          </form>

          <!-- Formulario editable -->
          <form id="editForm" style="display: flex;">
            <div class="CashContainer_master">
              <div class="Casstittle">
                <h2>Efectivo Contado</h2>
              </div>


              <div class="CashContainer">
                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/2000.jpg">
                  <label for="denomination2000">Billetes de 2000:</label>
                  <input type="number" id="denomination2000" placeholder="0">

                  <img src="./img/Money Icon/1000.jpg">
                  <label for="denomination1000">Billetes de 1000:</label>
                  <input type="number" id="denomination1000" placeholder="0">

                  <img src="./img/Money Icon/500.jpg">
                  <label for="denomination500">Billetes de 500:</label>
                  <input type="number" id="denomination500" placeholder="0">

                  <img src="./img/Money Icon/200.jpg">
                  <label for="denomination200">Billetes de 200:</label>
                  <input type="number" id="denomination200" placeholder="0">

                  <img src="./img/Money Icon/100.jpg">
                  <label for="denomination100">Billetes de 100:</label>
                  <input type="number" id="denomination100" placeholder="0">
                </div>

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/50.jpg">
                  <label for="denomination50">Billetes de 50:</label>
                  <input type="number" id="denomination50" placeholder="0">

                  <img src="./img/Money Icon/25.png">
                  <label for="denomination25">Monedas de 25:</label>
                  <input type="number" id="denomination25" placeholder="0">

                  <img src="./img/Money Icon/10.png">
                  <label for="denomination10">Monedas de 10:</label>
                  <input type="number" id="denomination10" placeholder="0">

                  <img src="./img/Money Icon/5.png">
                  <label for="denomination5">Monedas de 5:</label>
                  <input type="number" id="denomination5" placeholder="0">

                  <img src="./img/Money Icon/1.png">
                  <label for="denomination1">Monedas de 1:</label>
                  <input type="number" id="denomination1" placeholder="0">
                </div>
              </div>
            </div>
        </div>
      </div>



      <div class="modal_caja_down">
        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total en Caja</p>
          <div id="totalAmount_read">RD$0</div>
        </div>

        <!-- Select para empleados -->
        <div class="empleadoYbtn">
          <div style="display: inline-flex;flex-direction: column;">
            <label for="empleadoSelectInicio"></label>
            <select id="empleadoSelectInicio" required>
              <option value="">Seleccione un empleado</option>
              <!-- Las opciones se llenarán con JavaScript -->
            </select>
          </div>
          <button type="submit">Iniciar Caja</button>
        </div>

        <div id="totalAmount">Total Contado: <span>RD$0</span></div>
      </div>
      </form>
    </div>
  </div>
  <!-- Modal para Iniciar Caja FIN -->


  <!-- Modal para Retirar Efectivo -->
  <div id="retirarDineroModal" class="modal">
    <div class="modal-content">

      <div class="modal_caja_tittle">
        <span class="close">&times;</span>
        <h2>Retirar Efectivo</h2>
      </div>

      <div class="modal_caja_body">
        <div class="modal_caja_flex">
          <!-- Primer formulario: Montos recuperados -->
          <form id="retirarDineroForm" style="display: flex;">

            <div class="CashContainer_master">

              <div class="Casstittle">
                <h2>Efectivo en Caja</h2>
              </div>

              <div class="CashContainer">
                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">

                  <img src="./img/Money Icon/2000.jpg">
                  <label for="denomination2000_retirar">Billetes de 2000:</label>
                  <input type="number" id="denomination2000_retirar" placeholder="0" readonly>

                  <img src="./img/Money Icon/1000.jpg">
                  <label for="denomination1000_retirar">Billetes de 1000:</label>
                  <input type="number" id="denomination1000_retirar" placeholder="0" readonly>

                  <img src="./img/Money Icon/500.jpg">
                  <label for="denomination500_retirar">Billetes de 500:</label>
                  <input type="number" id="denomination500_retirar" placeholder="0" readonly>

                  <img src="./img/Money Icon/200.jpg">
                  <label for="denomination200_retirar">Billetes de 200:</label>
                  <input type="number" id="denomination200_retirar" placeholder="0" readonly>

                  <img src="./img/Money Icon/100.jpg">
                  <label for="denomination100_retirar">Billetes de 100:</label>
                  <input type="number" id="denomination100_retirar" placeholder="0" readonly>
                </div>

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/50.jpg">
                  <label for="denomination50_retirar">Billetes de 50:</label>
                  <input type="number" id="denomination50_retirar" placeholder="0" readonly>

                  <img src="./img/Money Icon/25.png">
                  <label for="denomination25_retirar">Monedas de 25:</label>
                  <input type="number" id="denomination25_retirar" placeholder="0" readonly>

                  <img src="./img/Money Icon/10.png">
                  <label for="denomination10_retirar">Billetes de 10:</label>
                  <input type="number" id="denomination10_retirar" placeholder="0" readonly>

                  <img src="./img/Money Icon/5.png">
                  <label for="denomination5_retirar">Billetes de 5:</label>
                  <input type="number" id="denomination5_retirar" placeholder="0" readonly>

                  <img src="./img/Money Icon/1.png">
                  <label for="denomination1_retirar">Billetes de 1:</label>
                  <input type="number" id="denomination1_retirar" placeholder="0" readonly>
                </div>
              </div>
            </div>
          </form>

          <!-- Segundo formulario RETIRAR: Editable -->
          <form id="editarRetiroForm" style="display: flex;">

            <div class="CashContainer_master">

              <div class="Casstittle">
                <h2>Efectivo a Retirar</h2>
              </div>

              <div class="CashContainer">

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/2000.jpg">
                  <label for="denomination2000_edit">Billetes de 2000:</label>
                  <input type="number" id="denomination2000_edit" placeholder="0">

                  <img src="./img/Money Icon/1000.jpg">
                  <label for="denomination1000_edit">Billetes de 1000:</label>
                  <input type="number" id="denomination1000_edit" placeholder="0">

                  <img src="./img/Money Icon/500.jpg">
                  <label for="denomination500_edit">Billetes de 500:</label>
                  <input type="number" id="denomination500_edit" placeholder="0">

                  <img src="./img/Money Icon/200.jpg">
                  <label for="denomination200_edit">Billetes de 200:</label>
                  <input type="number" id="denomination200_edit" placeholder="0">

                  <img src="./img/Money Icon/100.jpg">
                  <label for="denomination100_edit">Billetes de 100:</label>
                  <input type="number" id="denomination100_edit" placeholder="0">
                </div>

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/50.jpg">
                  <label for="denomination50_edit">Billetes de 50:</label>
                  <input type="number" id="denomination50_edit" placeholder="0">

                  <img src="./img/Money Icon/25.png">
                  <label for="denomination25_edit">Monedas de 25:</label>
                  <input type="number" id="denomination25_edit" placeholder="0">

                  <img src="./img/Money Icon/10.png">
                  <label for="denomination10_edit">Billetes de 10:</label>
                  <input type="number" id="denomination10_edit" placeholder="0">

                  <img src="./img/Money Icon/5.png">
                  <label for="denomination5_edit">Billetes de 5:</label>
                  <input type="number" id="denomination5_edit" placeholder="0">

                  <img src="./img/Money Icon/1.png">
                  <label for="denomination1_edit">Billetes de 1:</label>
                  <input type="number" id="denomination1_edit" placeholder="0">
                </div>
              </div>

            </div>
        </div>
      </div>

      <div class="modal_caja_down">
        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total en Caja</p>
          <div id="modalTotalRetirar">RD$0</div>
        </div>


        <!-- Select para empleados -->
        <div class="empleadoYbtn">
          <div style="display: inline-flex;flex-direction: column;align-items: center;gap: 3px;">
            <div id="modalQuedariaEnCaja">Lo que quedaría en caja: RD$0</div> <!-- Nuevo div agregado -->

            <label for="empleadoSelectRetiro"></label>
            <select id="empleadoSelectRetiro" required>
              <option value="">Seleccione un empleado</option>
              <!-- Las opciones se llenarán con JavaScript -->
            </select>
          </div>

          <button type="submit">Aplicar Retiro</button>
        </div>

        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total a Retirar</p>
          <div id="totalRetirar">RD$0</div>
        </div>


        </form>
      </div>
    </div>
  </div>
  <!-- Modal para Retirar Efectivo FIN -->



  <!-- Modal para Ingresar Efectivo -->
  <div id="ingresarDineroModal" class="modal">
    <div class="modal-content">

      <div class="modal_caja_tittle">
        <span class="close">&times;</span>
        <h2>Ingresar Efectivo</h2>
      </div>

      <div class="modal_caja_body">
        <div class="modal_caja_flex">
          <!-- Formulario para mostrar los montos actuales -->
          <form id="currentAmountsForm" style="display: flex;">

            <div class="CashContainer_master">

              <div class="Casstittle">
                <h2>Efectivo en Caja</h2>
              </div>

              <div class="CashContainer">
                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/2000.jpg">
                  <label for="denomination2000_current">Billetes de 2000:</label>
                  <input type="number" id="denomination2000_current" readonly>

                  <img src="./img/Money Icon/1000.jpg">
                  <label for="denomination1000_current">Billetes de 1000:</label>
                  <input type="number" id="denomination1000_current" readonly>

                  <img src="./img/Money Icon/500.jpg">
                  <label for="denomination500_current">Billetes de 500:</label>
                  <input type="number" id="denomination500_current" readonly>

                  <img src="./img/Money Icon/200.jpg">
                  <label for="denomination200_current">Billetes de 200:</label>
                  <input type="number" id="denomination200_current" readonly>

                  <img src="./img/Money Icon/100.jpg">
                  <label for="denomination100_current">Billetes de 100:</label>
                  <input type="number" id="denomination100_current" readonly>
                </div>

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/50.jpg">
                  <label for="denomination50_current">Billetes de 50:</label>
                  <input type="number" id="denomination50_current" readonly>

                  <img src="./img/Money Icon/25.png">
                  <label for="denomination25_current">Monedas de 25:</label>
                  <input type="number" id="denomination25_current" readonly>

                  <img src="./img/Money Icon/10.png">
                  <label for="denomination10_current">Billetes de 10:</label>
                  <input type="number" id="denomination10_current" readonly>

                  <img src="./img/Money Icon/5.png">
                  <label for="denomination5_current">Billetes de 5:</label>
                  <input type="number" id="denomination5_current" readonly>

                  <img src="./img/Money Icon/1.png">
                  <label for="denomination1_current">Billetes de 1:</label>
                  <input type="number" id="denomination1_current" readonly>
                </div>
              </div>
            </div>
          </form>

          <!-- Formulario para ingresar dinero Editable-->
          <form id="ingresarDineroForm" style="display: flex;">

            <div class="CashContainer_master">

              <div class="Casstittle">
                <h2>Efectivo a Ingresar</h2>
              </div>

              <div class="CashContainer">

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/2000.jpg">
                  <label for="denomination2000_ingresar">Billetes de 2000:</label>
                  <input type="number" id="denomination2000_ingresar" placeholder="0">

                  <img src="./img/Money Icon/1000.jpg">
                  <label for="denomination1000_ingresar">Billetes de 1000:</label>
                  <input type="number" id="denomination1000_ingresar" placeholder="0">

                  <img src="./img/Money Icon/500.jpg">
                  <label for="denomination500_ingresar">Billetes de 500:</label>
                  <input type="number" id="denomination500_ingresar" placeholder="0">

                  <img src="./img/Money Icon/200.jpg">
                  <label for="denomination200_ingresar">Billetes de 200:</label>
                  <input type="number" id="denomination200_ingresar" placeholder="0">

                  <img src="./img/Money Icon/100.jpg">
                  <label for="denomination100_ingresar">Billetes de 100:</label>
                  <input type="number" id="denomination100_ingresar" placeholder="0">
                </div>

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/50.jpg">
                  <label for="denomination50_ingresar">Billetes de 50:</label>
                  <input type="number" id="denomination50_ingresar" placeholder="0">

                  <img src="./img/Money Icon/25.png">
                  <label for="denomination25_ingresar">Monedas de 25:</label>
                  <input type="number" id="denomination25_ingresar" placeholder="0">

                  <img src="./img/Money Icon/10.png">
                  <label for="denomination10_ingresar">Billetes de 10:</label>
                  <input type="number" id="denomination10_ingresar" placeholder="0">

                  <img src="./img/Money Icon/5.png">
                  <label for="denomination5_ingresar">Billetes de 5:</label>
                  <input type="number" id="denomination5_ingresar" placeholder="0">

                  <img src="./img/Money Icon/1.png">
                  <label for="denomination1_ingresar">Billetes de 1:</label>
                  <input type="number" id="denomination1_ingresar" placeholder="0">
                </div>
              </div>
            </div>
        </div>
      </div>

      <div class="modal_caja_down">
        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total en Caja</p>
          <div id="totalCurrentAmount">Total en Caja: RD$0</div>
        </div>


        <!-- Select para empleados -->
        <div class="empleadoYbtn">

          <div style="display: inline-flex;flex-direction: column;align-items: center;gap: 3px;">
            <div id="ReviewIngresoEnCaja">Lo que quedaría en caja: RD$0</div>


            <label for="empleadoSelectIngreso"></label>
            <select id="empleadoSelectIngreso" required>
              <option value="">Seleccione un empleado</option>
              <!-- Las opciones de empleados se llenarán con JavaScript -->
            </select>
          </div>

          <button type="submit">Aplicar Ingreso</button>
        </div>

        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total a Ingresar</p>
          <div id="modalTotalIngresar">RD$0</div>
        </div>


        </form>
      </div>
    </div>
  </div>
  <!-- Modal para Ingresar Efectivo FIN -->



  <!-- Modal para Cierre de Caja -->
  <div id="cierreCajaModal" class="modal">
    <div class="modal-content">

      <div class="modal_caja_tittle">
        <span class="close">&times;</span>
        <h2>Cierre de Caja</h2>
      </div>

      <div class="modal_caja_body">
        <div class="modal_caja_flex">

          <form id="cierreCajaForm">

            <div class="CashContainer">
              <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                <img src="./img/Money Icon/2000.jpg">
                <label for="denomination2000_cierre">Billetes de 2000:</label>
                <input type="number" id="denomination2000_cierre" placeholder="0" value="">

                <img src="./img/Money Icon/1000.jpg">
                <label for="denomination1000_cierre">Billetes de 1000:</label>
                <input type="number" id="denomination1000_cierre" placeholder="0" value="">


                <img src="./img/Money Icon/500.jpg">
                <label for="denomination500_cierre">Billetes de 500:</label>
                <input type="number" id="denomination500_cierre" placeholder="0" value="">


                <img src="./img/Money Icon/200.jpg">
                <label for="denomination200_cierre">Billetes de 200:</label>
                <input type="number" id="denomination200_cierre" placeholder="0" value="">

                <img src="./img/Money Icon/100.jpg">
                <label for="denomination100_cierre">Billetes de 100:</label>
                <input type="number" id="denomination100_cierre" placeholder="0" value="">
              </div>


              <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                <img src="./img/Money Icon/50.jpg">
                <label for="denomination50_cierre">Billetes de 50:</label>
                <input type="number" id="denomination50_cierre" placeholder="0" value="">

                <img src="./img/Money Icon/25.png">
                <label for="denomination25_cierre">Monedas de 25:</label>
                <input type="number" id="denomination25_cierre" placeholder="0" value="">

                <img src="./img/Money Icon/10.png">
                <label for="denomination10_cierre">Monedas de 10:</label>
                <input type="number" id="denomination10_cierre" placeholder="0" value="">

                <img src="./img/Money Icon/5.png">
                <label for="denomination5_cierre">Monedas de 5:</label>
                <input type="number" id="denomination5_cierre" placeholder="0" value="">

                <img src="./img/Money Icon/1.png">
                <label for="denomination1_cierre">Monedas de 1:</label>
                <input type="number" id="denomination1_cierre" placeholder="0" value="">
              </div>
            </div>

        </div>
      </div>

      <div class="modal_caja_down">

        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total en Caja:</p>
          <div id="modalTotalEnCaja">RD$0</div>
        </div>

        <!-- Select para empleados -->
        <div class="empleadoYbtn">
          <div style="display: inline-flex;flex-direction: column;align-items: center;">
            <div id="modalStatusCierre" style="color: rgb(255, 71, 71);margin-bottom: 4px;"></div>
            <!-- Div para mostrar el estado -->
             
            <label for="empleadoSelectCierre"></label>
            <select id="empleadoSelectCierre" required style="width: 100%; padding: 8px;">
              <option value="">Seleccione un empleado</option>
              <!-- Las opciones se llenarán con JavaScript -->
            </select>
          </div>

          <div style="display: inline-flex;flex-direction: column;align-items: center;">

            <button type="submit">Cierre de Caja</button>
          </div>
        </div>

        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total Contado:</p>
          <div id="modalTotalContado">RD$0</div>
        </div>

        </form>
      </div>

    </div>
  </div>
  </div>
  <!-- Modal para Cierre de Caja FIN -->



  <!-- Modal para Retiro por Empleado -->
  <div id="retiroEmpleadoModal" class="modal">
    <div class="modal-content">
      <div class="modal_caja_tittle">
        <span class="close">&times;</span>
        <h2>Retiro de Efectivo por el Empleado</h2>
      </div>

      <div class="modal_caja_body">
        <div class="modal_caja_flex" style="width: 70%;">
          <form id="retiroEmpleadoForm">
            <div class="CashContainer_master">

              <div class="Casstittle">
                <h2>Efectivo a Retirar</h2>
              </div>

              <div class="CashContainer">
                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/2000.jpg">
                  <label for="denomination2000_empleado">Billetes de 2000:</label>
                  <input type="number" id="denomination2000_empleado" placeholder="0">

                  <img src="./img/Money Icon/1000.jpg">
                  <label for="denomination1000_empleado">Billetes de 1000:</label>
                  <input type="number" id="denomination1000_empleado" placeholder="0">

                  <img src="./img/Money Icon/500.jpg">
                  <label for="denomination500_empleado">Billetes de 500:</label>
                  <input type="number" id="denomination500_empleado" placeholder="0">

                  <img src="./img/Money Icon/200.jpg">
                  <label for="denomination200_empleado">Billetes de 200:</label>
                  <input type="number" id="denomination200_empleado" placeholder="0">

                  <img src="./img/Money Icon/100.jpg">
                  <label for="denomination100_empleado">Billetes de 100:</label>
                  <input type="number" id="denomination100_empleado" placeholder="0">
                </div>

                <div style="display: inline-flex;flex-direction: column;align-items: center;margin-top: 10px;">
                  <img src="./img/Money Icon/50.jpg">
                  <label for="denomination50_empleado">Billetes de 50:</label>
                  <input type="number" id="denomination50_empleado" placeholder="0">

                  <img src="./img/Money Icon/25.png">
                  <label for="denomination25_empleado">Monedas de 25:</label>
                  <input type="number" id="denomination25_empleado" placeholder="0">

                  <img src="./img/Money Icon/10.png">
                  <label for="denomination10_empleado">Monedas de 10:</label>
                  <input type="number" id="denomination10_empleado" placeholder="0">

                  <img src="./img/Money Icon/5.png">
                  <label for="denomination5_empleado">Monedas de 5:</label>
                  <input type="number" id="denomination5_empleado" placeholder="0">

                  <img src="./img/Money Icon/1.png">
                  <label for="denomination1_empleado">Monedas de 1:</label>
                  <input type="number" id="denomination1_empleado" placeholder="0">
                </div>
              </div>
            </div>
          </form>
        </div>

        <div class="boxdetalles">
          <div class="retiro-comentario">
            <label for="empleadoSelect">Empleado:</label>
            <select id="empleadoSelect" required>
              <option value="">Seleccione un empleado</option>
              <!-- Las opciones se llenarán con JavaScript -->
            </select>
          </div>

          <div class="retiro-comentario">
            <label for="detallesGasto">Detalles del gasto:</label>
            <textarea id="detallesGasto" rows="4" style="width: 100%;" required
              placeholder="Describa el motivo del gasto"></textarea>
          </div>
        </div>


      </div>

      <div class="modal_caja_down">
        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total en Caja:</p>
          <div id="modalTotalDeberiaEmpleado">RD$0</div>
        </div>

        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <div id="modalQuedariaEnRetiroEmpleado" style="margin-bottom: 7px;">Lo que quedaría en caja: RD$0</div>
          <button type="button" id="confirmarRetiroEmpleado">Confirmar Retiro</button>
        </div>

        <div style="display: inline-flex;flex-direction: column;align-items: center;">
          <p>Total a Retirar:</p>
          <div id="totalRetiroEmpleado">RD$0</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal para Retiro por Empleado FIN -->



  <!-- Modal para Historial de Transacciones -->
  <div id="historialModal" class="modal">
    <div class="modal-content">
      <div class="modal_caja_tittle" style="background: #ffffff;">
        <span class="close">&times;</span>
        <h2 style="color: #000000;">Historial de Transacciones</h2>
      </div>

      <div class="modal_caja_body" style="background: #ffffff;display: block;padding: 15px 20px 20px 20px;">
        <div class="modal_caja_flex" style="display: inline-flex;flex-direction: column;">
          <ul id="historialList">
            <!-- Las transacciones se cargarán aquí como elementos li -->
          </ul>
          <button id="loadMoreButton" style="display: none;">Cargar más</button>
          <p id="noMoreRecords" style="display: none; text-align: center;">No hay más registros</p>

        </div>
      </div>
    </div>
  </div>



  </div>

  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDdG-CP2kO3v-zkkjD17Wj028QJvjp54qY",
      authDomain: "paris-laundry.firebaseapp.com",
      projectId: "paris-laundry",
      storageBucket: "paris-laundry.appspot.com",
      messagingSenderId: "1022712814457",
      appId: "1:1022712814457:web:7bddb47ed46bac22c32da8"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();


    // Manejo del modal "Ingresar Dinero"
    const ingresarDineroModal = document.getElementById("ingresarDineroModal");
    const btnIngresarDinero = document.getElementById("openIngresarDineroModal");
    const spanIngresarDinero = ingresarDineroModal.getElementsByClassName("close")[0];

    // Abrir el modal "Ingresar Dinero"
    btnIngresarDinero.onclick = function () {
      ingresarDineroModal.style.display = "block";
    };

    // Cerrar el modal "Ingresar Dinero"
    spanIngresarDinero.onclick = function () {
      ingresarDineroModal.style.display = "none";
    };

    // Cerrar el modal si se hace clic fuera de él
    window.onclick = function (event) {
      if (event.target == ingresarDineroModal) {
        ingresarDineroModal.style.display = "none";
      }
    };

    // Función para calcular el total a ingresar
    const calcularTotalIngresar = () => {
      const total = Array.from(document.querySelectorAll('#ingresarDineroForm input[type="number"]'))
        .reduce((acc, input) => acc + (parseInt(input.value) || 0) * parseInt(input.id.replace('denomination', '')) || 0, 0);

      document.getElementById('modalTotalIngresar').innerText = `RD$${total}`;
    };

    // Agregar eventos de entrada a cada campo del formulario de "Ingresar Dinero"
    document.querySelectorAll('#ingresarDineroForm input[type="number"]').forEach(input => {
      input.addEventListener('input', calcularTotalIngresar);
    });

    // Guardar los montos a ingresar en Firebase



    // Función mejorada para cargar empleados en el select de ingreso
    const loadEmpleadosIngreso = async () => {
      try {
        console.log("Cargando empleados..."); // Debug
        const empleadosSelect = document.getElementById('empleadoSelectIngreso');

        const querySnapshot = await db.collection("empleados").orderBy("nombre").get();

        console.log(`Encontrados ${querySnapshot.size} empleados`); // Debug

        if (querySnapshot.empty) {
          console.warn("No se encontraron empleados en la base de datos");
          return;
        }

        querySnapshot.forEach(doc => {
          const empleado = doc.data();
          console.log("Procesando empleado:", empleado); // Debug

          if (empleado.nombre) {
            const option = document.createElement('option');
            option.value = empleado.nombre;
            option.textContent = empleado.nombre;
            empleadosSelect.appendChild(option);
          }
        });

        console.log("Empleados cargados exitosamente"); // Debug
      } catch (error) {
        console.error("Error al cargar empleados:", error);
        alert("Error al cargar la lista de empleados. Recargue la página.");
      }
    };

    loadEmpleadosIngreso();


    // Modificar el evento de apertura del modal de ingreso
    btnIngresarDinero.onclick = async function () {
      ingresarDineroModal.style.display = "block";
      await loadCurrentAmounts();
      await loadEmpleadosIngreso(); // Cargar empleados al abrir el modal
      calcularReviewIngresoEnCaja();
    };




    // Modificar el manejador del formulario de ingreso para registrar en historial
    document.getElementById('ingresarDineroForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      // Validar empleado seleccionado
      const empleado = document.getElementById('empleadoSelectIngreso').value;
      if (!empleado) {
        alert("Por favor seleccione un empleado");
        return;
      }

      // Obtener los montos a ingresar del formulario
      const denominationsToDeposit = {
        2000: parseInt(document.getElementById('denomination2000_ingresar').value) || 0,
        1000: parseInt(document.getElementById('denomination1000_ingresar').value) || 0,
        500: parseInt(document.getElementById('denomination500_ingresar').value) || 0,
        200: parseInt(document.getElementById('denomination200_ingresar').value) || 0,
        100: parseInt(document.getElementById('denomination100_ingresar').value) || 0,
        50: parseInt(document.getElementById('denomination50_ingresar').value) || 0,
        25: parseInt(document.getElementById('denomination25_ingresar').value) || 0,
        10: parseInt(document.getElementById('denomination10_ingresar').value) || 0,
        5: parseInt(document.getElementById('denomination5_ingresar').value) || 0,
        1: parseInt(document.getElementById('denomination1_ingresar').value) || 0,
      };

      // Calcular el total a ingresar
      const totalIngresar = Object.keys(denominationsToDeposit).reduce((acc, key) =>
        acc + (denominationsToDeposit[key] * key), 0);

      try {
        const querySnapshot = await db.collection("caja").get();
        if (!querySnapshot.empty) {
          const doc = querySnapshot.docs[0];
          const currentDenominations = doc.data().denominations;

          // Sumar los montos a ingresar a las denominaciones actuales
          const updatedDenominations = {
            2000: currentDenominations[2000] + denominationsToDeposit[2000],
            1000: currentDenominations[1000] + denominationsToDeposit[1000],
            500: currentDenominations[500] + denominationsToDeposit[500],
            200: currentDenominations[200] + denominationsToDeposit[200],
            100: currentDenominations[100] + denominationsToDeposit[100],
            50: currentDenominations[50] + denominationsToDeposit[50],
            25: currentDenominations[25] + denominationsToDeposit[25],
            10: currentDenominations[10] + denominationsToDeposit[10],
            5: currentDenominations[5] + denominationsToDeposit[5],
            1: currentDenominations[1] + denominationsToDeposit[1],
          };

          // Calcular el nuevo total en caja
          const totalEnCaja = parseInt(document.getElementById('totalAmount_read').innerText.replace('RD$', '').trim()) || 0;
          const nuevoTotalEnCaja = totalEnCaja + totalIngresar;

          // Actualizar Firebase con las nuevas denominaciones y el nuevo total en caja
          await doc.ref.update({
            denominations: updatedDenominations,
            totalEnCaja: nuevoTotalEnCaja,
          });

          // Registrar en el historial de caja
          await db.collection("historialCaja").add({
            accion: "Ingreso de Efectivo Exitoso",
            empleado: empleado,
            monto: totalIngresar,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

          // Alertas después de la actualización
          alert("El ingreso a caja es correcto.");
          alert("Caja actualizada exitosamente.");
          location.reload(); // Recargar la página después de guardar
        } else {
          alert("No se encontraron datos en la colección 'caja'.");
        }
      } catch (error) {
        console.error("Error al actualizar los montos a ingresar:", error);
        alert("Error al actualizar los montos a ingresar. Intenta nuevamente.");
      }
    });

    // Prueba esta función en la consola para verificar los empleados
    async function testEmpleados() {
      try {
        const querySnapshot = await db.collection("empleados").get();
        console.log("Empleados encontrados:", querySnapshot.size);
        querySnapshot.forEach(doc => {
          console.log(doc.id, "=>", doc.data());
        });
      } catch (error) {
        console.error("Error al probar empleados:", error);
      }
    }
    testEmpleados();



    // Manejo del modal "Retirar Dinero"
    const retirarDineroModal = document.getElementById("retirarDineroModal");
    const btnRetirarDinero = document.getElementById("openRetirarDineroModal");
    const spanRetirarDinero = retirarDineroModal.getElementsByClassName("close")[0];

    // Abrir el modal "Retirar Dinero"
    btnRetirarDinero.onclick = function () {
      retirarDineroModal.style.display = "block";
      loadRetirarDineroData(); // Cargar datos de Firebase al abrir el modal
    };

    // Cerrar el modal "Retirar Dinero"
    spanRetirarDinero.onclick = function () {
      retirarDineroModal.style.display = "none";
    };

    // Cerrar el modal si se hace clic fuera de él
    window.onclick = function (event) {
      if (event.target == retirarDineroModal) {
        retirarDineroModal.style.display = "none";
      }
    };

    // Función para calcular y mostrar lo que quedaría en caja
    const calcularQuedariaEnCaja = () => {
      const totalEnCaja = parseInt(document.getElementById('totalAmount_read').innerText.replace('RD$', '').trim()) || 0;
      const totalRetirar = Array.from(document.querySelectorAll('#editarRetiroForm input[type="number"]'))
        .reduce((acc, input) => acc + (parseInt(input.value) || 0) * parseInt(input.id.replace('denomination', '')) || 0, 0);

      const quedariaEnCaja = totalEnCaja - totalRetirar;
      document.getElementById('modalQuedariaEnCaja').innerText = `Lo que quedaría en caja: RD$${quedariaEnCaja}`;
    };

    // Agregar eventos de entrada a cada campo del formulario de "Actualizar Montos a Retirar"
    document.querySelectorAll('#editarRetiroForm input[type="number"]').forEach(input => {
      input.addEventListener('input', calcularQuedariaEnCaja);
    });





    // Función para cargar los montos actuales de Firebase al abrir el modal
    const loadCurrentAmounts = async () => {
      const cajaSnapshot = await db.collection("caja").get();
      if (!cajaSnapshot.empty) {
        const cajaDoc = cajaSnapshot.docs[0].data();
        document.getElementById('denomination2000_current').value = cajaDoc.denominations[2000] || 0;
        document.getElementById('denomination1000_current').value = cajaDoc.denominations[1000] || 0;
        document.getElementById('denomination500_current').value = cajaDoc.denominations[500] || 0;
        document.getElementById('denomination200_current').value = cajaDoc.denominations[200] || 0;
        document.getElementById('denomination100_current').value = cajaDoc.denominations[100] || 0;
        document.getElementById('denomination50_current').value = cajaDoc.denominations[50] || 0;
        document.getElementById('denomination25_current').value = cajaDoc.denominations[25] || 0;
        document.getElementById('denomination10_current').value = cajaDoc.denominations[10] || 0;
        document.getElementById('denomination5_current').value = cajaDoc.denominations[5] || 0;
        document.getElementById('denomination1_current').value = cajaDoc.denominations[1] || 0;

        // Calcular y mostrar el total actual en caja
        const totalEnCaja = Object.keys(cajaDoc.denominations).reduce((acc, key) => {
          return acc + (cajaDoc.denominations[key] * key);
        }, 0);
        document.getElementById('totalCurrentAmount').innerText = `RD$${totalEnCaja}`;
      }
    };

    // Función para calcular lo que habría en caja después de agregar el dinero
    const calcularReviewIngresoEnCaja = () => {
      const totalEnCaja = parseInt(document.getElementById('totalCurrentAmount').innerText.replace('RD$', '').trim()) || 0;
      const totalIngresar = Array.from(document.querySelectorAll('#ingresarDineroForm input[type="number"]'))
        .reduce((acc, input) => acc + (parseInt(input.value) || 0) * parseInt(input.id.replace('denomination', '')) || 0, 0);

      const quedariaEnCaja = totalEnCaja + totalIngresar;
      document.getElementById('ReviewIngresoEnCaja').innerText = `Lo que quedaría en caja: RD$${quedariaEnCaja}`;
    };

    // Agregar eventos de entrada a cada campo del formulario de "Ingresar Dinero"
    document.querySelectorAll('#ingresarDineroForm input[type="number"]').forEach(input => {
      input.addEventListener('input', calcularReviewIngresoEnCaja);
    });

    // Abrir el modal "Ingresar Dinero" y cargar los montos actuales
    btnIngresarDinero.onclick = async function () {
      await loadCurrentAmounts(); // Cargar datos de Firebase al abrir el modal
      ingresarDineroModal.style.display = "block";
      calcularReviewIngresoEnCaja(); // Calcular lo que quedaría en caja al abrir el modal
    };




    // Función para verificar si el valor ingresado es mayor que la cantidad disponible
    const verificarCantidad = () => {
      // Obtener los valores de los campos del primer formulario (montos recuperados)
      const cantidadDisponible = {
        2000: parseInt(document.getElementById('denomination2000_retirar').value) || 0,
        1000: parseInt(document.getElementById('denomination1000_retirar').value) || 0,
        500: parseInt(document.getElementById('denomination500_retirar').value) || 0,
        200: parseInt(document.getElementById('denomination200_retirar').value) || 0,
        100: parseInt(document.getElementById('denomination100_retirar').value) || 0,
        50: parseInt(document.getElementById('denomination50_retirar').value) || 0,
        25: parseInt(document.getElementById('denomination25_retirar').value) || 0,
        10: parseInt(document.getElementById('denomination10_retirar').value) || 0,
        5: parseInt(document.getElementById('denomination5_retirar').value) || 0,
        1: parseInt(document.getElementById('denomination1_retirar').value) || 0,
      };

      // Obtener los campos del segundo formulario (montos a retirar)
      const camposRetiro = document.querySelectorAll('#editarRetiroForm input[type="number"]');

      camposRetiro.forEach(input => {
        const denominacion = input.id.replace('denomination', '').replace('_edit', '');
        const valorIngresado = parseInt(input.value) || 0;

        if (valorIngresado > cantidadDisponible[denominacion]) {
          input.style.color = 'red'; // Cambiar el color del texto a rojo
        } else {
          input.style.color = ''; // Restaurar el color original
        }
      });
    };

    // Agregar eventos de entrada a cada campo del segundo formulario
    document.querySelectorAll('#editarRetiroForm input[type="number"]').forEach(input => {
      input.addEventListener('input', verificarCantidad);
    });

    // Llamar a la función al cargar el modal para verificar los valores iniciales
    const loadRetirarDineroData = async () => {
      const cajaSnapshot = await db.collection("caja").get();
      if (!cajaSnapshot.empty) {
        const cajaDoc = cajaSnapshot.docs[0].data();
        document.getElementById('denomination2000_retirar').value = cajaDoc.denominations[2000] || 0;
        document.getElementById('denomination1000_retirar').value = cajaDoc.denominations[1000] || 0;
        document.getElementById('denomination500_retirar').value = cajaDoc.denominations[500] || 0;
        document.getElementById('denomination200_retirar').value = cajaDoc.denominations[200] || 0;
        document.getElementById('denomination100_retirar').value = cajaDoc.denominations[100] || 0;
        document.getElementById('denomination50_retirar').value = cajaDoc.denominations[50] || 0;
        document.getElementById('denomination25_retirar').value = cajaDoc.denominations[25] || 0;
        document.getElementById('denomination10_retirar').value = cajaDoc.denominations[10] || 0;
        document.getElementById('denomination5_retirar').value = cajaDoc.denominations[5] || 0;
        document.getElementById('denomination1_retirar').value = cajaDoc.denominations[1] || 0;

        // Actualizar el total en el modal
        document.getElementById('modalTotalRetirar').innerText = `RD$${cajaDoc.totalEnCaja || 0}`;
        calcularQuedariaEnCaja(); // Calcular lo que quedaría en caja al cargar los datos
        verificarCantidad(); // Verificar las cantidades al cargar los datos
      }
    };





    // Función para calcular y mostrar lo que quedaría en caja en el modal de Retiro por Empleado
    const calcularQuedariaEnRetiroEmpleado = () => {
      // Obtener el total que debería haber en caja
      const totalDeberia = parseInt(document.getElementById('totalDeberia').innerText.replace('RD$', '').trim()) || 0;

      // Calcular el total a retirar
      const totalRetirar = Array.from(document.querySelectorAll('#retiroEmpleadoForm input[type="number"]'))
        .reduce((acc, input) => acc + (parseInt(input.value) || 0) * parseInt(input.id.replace('denomination', '').replace('_empleado', '')) || 0, 0);

      // Calcular lo que quedaría en caja
      const quedariaEnCaja = totalDeberia - totalRetirar;
      document.getElementById('modalQuedariaEnRetiroEmpleado').innerText = `Lo que quedaría en caja: RD$${quedariaEnCaja}`;
    };

    // Agregar eventos de entrada a cada campo del formulario de "Retiro por Empleado"
    document.querySelectorAll('#retiroEmpleadoForm input[type="number"]').forEach(input => {
      input.addEventListener('input', calcularQuedariaEnRetiroEmpleado);
    });




    // Actualizar el total en tiempo real al cambiar los valores de los campos
    document.querySelectorAll('#editarRetiroForm input[type="number"]').forEach(input => {
      input.addEventListener('input', async () => {
        const cajaSnapshot = await db.collection("caja").get();
        if (!cajaSnapshot.empty) {
          const cajaDoc = cajaSnapshot.docs[0].data();
          document.getElementById('modalTotalRetirar').innerText = `RD$${cajaDoc.totalEnCaja || 0}`;
        }
      });
    });




    // Función para cargar empleados en el select de retiro
    const loadEmpleadosRetiro = async () => {
      try {
        const empleadosSelect = document.getElementById('empleadoSelectRetiro');
        empleadosSelect.innerHTML = '<option value="">Seleccione un empleado</option>';

        const querySnapshot = await db.collection("empleados").orderBy("nombre").get();

        querySnapshot.forEach(doc => {
          const empleado = doc.data();
          if (empleado.nombre) {
            const option = document.createElement('option');
            option.value = empleado.nombre;
            option.textContent = empleado.nombre;
            empleadosSelect.appendChild(option);
          }
        });
      } catch (error) {
        console.error("Error al cargar empleados:", error);
      }
    };

    // Modificar el evento de apertura del modal de retiro
    btnRetirarDinero.onclick = async function () {
      retirarDineroModal.style.display = "block";
      loadRetirarDineroData(); // Cargar datos de Firebase al abrir el modal
      await loadEmpleadosRetiro(); // Cargar empleados al abrir el modal
    };

    // Modificar el manejador del formulario de retiro para registrar en historial
    document.getElementById('editarRetiroForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      // Validar empleado seleccionado
      const empleado = document.getElementById('empleadoSelectRetiro').value;
      if (!empleado) {
        alert("Por favor seleccione un empleado");
        return;
      }

      // Obtener los montos a retirar del formulario
      const denominationsToWithdraw = {
        2000: parseInt(document.getElementById('denomination2000_edit').value) || 0,
        1000: parseInt(document.getElementById('denomination1000_edit').value) || 0,
        500: parseInt(document.getElementById('denomination500_edit').value) || 0,
        200: parseInt(document.getElementById('denomination200_edit').value) || 0,
        100: parseInt(document.getElementById('denomination100_edit').value) || 0,
        50: parseInt(document.getElementById('denomination50_edit').value) || 0,
        25: parseInt(document.getElementById('denomination25_edit').value) || 0,
        10: parseInt(document.getElementById('denomination10_edit').value) || 0,
        5: parseInt(document.getElementById('denomination5_edit').value) || 0,
        1: parseInt(document.getElementById('denomination1_edit').value) || 0,
      };

      try {
        const querySnapshot = await db.collection("caja").get();
        if (!querySnapshot.empty) {
          const doc = querySnapshot.docs[0];
          const currentDenominations = doc.data().denominations;

          // Validar que no se intente retirar más de lo que hay
          for (const key in denominationsToWithdraw) {
            if (denominationsToWithdraw[key] > currentDenominations[key]) {
              alert(`No puedes retirar más de lo que hay en ${key}.`);
              return; // Salir si se intenta retirar más de lo disponible
            }
          }

          // Restar los montos a retirar de las denominaciones actuales
          const updatedDenominations = {
            2000: currentDenominations[2000] - denominationsToWithdraw[2000],
            1000: currentDenominations[1000] - denominationsToWithdraw[1000],
            500: currentDenominations[500] - denominationsToWithdraw[500],
            200: currentDenominations[200] - denominationsToWithdraw[200],
            100: currentDenominations[100] - denominationsToWithdraw[100],
            50: currentDenominations[50] - denominationsToWithdraw[50],
            25: currentDenominations[25] - denominationsToWithdraw[25],
            10: currentDenominations[10] - denominationsToWithdraw[10],
            5: currentDenominations[5] - denominationsToWithdraw[5],
            1: currentDenominations[1] - denominationsToWithdraw[1],
          };

          // Calcular el nuevo total en caja
          const totalEnCaja = parseInt(document.getElementById('totalAmount_read').innerText.replace('RD$', '').trim()) || 0;
          const totalRetirar = Object.keys(denominationsToWithdraw).reduce((acc, key) => acc + (denominationsToWithdraw[key] * key), 0);
          const nuevoTotalEnCaja = totalEnCaja - totalRetirar;

          // Actualizar Firebase con las nuevas denominaciones y el nuevo total en caja
          await doc.ref.update({
            denominations: updatedDenominations,
            totalEnCaja: nuevoTotalEnCaja,
          });

          // Registrar en el historial de caja
          await db.collection("historialCaja").add({
            accion: "Retiro de Efectivo Exitoso",
            empleado: empleado,
            monto: totalRetirar,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

          // Alertas después de la actualización
          alert("El retiro de efectivo es correcto.");
          alert("Caja actualizada exitosamente.");
          location.reload(); // Recargar la página después de guardar
        } else {
          alert("No se encontraron datos en la colección 'caja'.");
        }
      } catch (error) {
        console.error("Error al actualizar los montos a retirar:", error);
        alert("Error al actualizar los montos a retirar. Intenta nuevamente.");
      }
    });



    // Función para calcular y mostrar el total a retirar
    const calcularTotalRetirar = () => {
      const total = Array.from(document.querySelectorAll('#editarRetiroForm input[type="number"]'))
        .reduce((acc, input) => acc + (parseInt(input.value) || 0) * parseInt(input.id.replace('denomination', '')) || 0, 0);

      document.getElementById('totalRetirar').innerText = `RD$${total}`;
    };

    // Agregar eventos de entrada a cada campo del formulario de "Actualizar Montos a Retirar"
    document.querySelectorAll('#editarRetiroForm input[type="number"]').forEach(input => {
      input.addEventListener('input', calcularTotalRetirar);
    });
    // Función para calcular y mostrar el total a retirar FIN






    // Función para calcular el total
    const calculateTotal = () => {
      const denominations = {
        2000: parseInt(document.getElementById('denomination2000').value) || 0,
        1000: parseInt(document.getElementById('denomination1000').value) || 0,
        500: parseInt(document.getElementById('denomination500').value) || 0,
        200: parseInt(document.getElementById('denomination200').value) || 0,
        100: parseInt(document.getElementById('denomination100').value) || 0,
        50: parseInt(document.getElementById('denomination50').value) || 0,
        25: parseInt(document.getElementById('denomination25').value) || 0,
        10: parseInt(document.getElementById('denomination10').value) || 0,
        5: parseInt(document.getElementById('denomination5').value) || 0,
        1: parseInt(document.getElementById('denomination1').value) || 0,
      };

      // Calcular el total
      const total = (denominations[2000] * 2000) +
        (denominations[1000] * 1000) +
        (denominations[500] * 500) +
        (denominations[200] * 200) +
        (denominations[100] * 100) +
        (denominations[50] * 50) +
        (denominations[25] * 25) +
        (denominations[10] * 10) +
        (denominations[5] * 5) +
        (denominations[1] * 1);

      // Mostrar el total en la interfaz
      document.getElementById('totalAmount').innerHTML = `Total Contado: <span>RD$${total}</span>`;
    };

    // Modificar la función updateTotals para incluir el gasto del empleado
    const updateTotals = async () => {
  try {
    // Obtener el total en caja desde la base de datos
    const cajaSnapshot = await db.collection("caja").get();
    let totalEnCaja = 0;
    let gastoEmpleado = 0;

    if (!cajaSnapshot.empty) {
      const cajaDoc = cajaSnapshot.docs[0].data();
      totalEnCaja = cajaDoc.totalEnCaja || 0;
      gastoEmpleado = cajaDoc.GastoEmpleado || 0;
    }

    let totalRecibido = 0;
    let totalCambio = 0;

    // Obtener las facturas
    const facturas = document.querySelectorAll('#facturasTable tbody tr');
    facturas.forEach(factura => {
      // Cambiar los índices de 4,5 a 5,6 por la nueva columna No.
      const montoRecibido = parseInt(factura.cells[5].innerText) || 0; // Ahora es columna 5 (antes 4)
      const cambio = parseInt(factura.cells[6].innerText) || 0;        // Ahora es columna 6 (antes 5)
      totalRecibido += montoRecibido;
      totalCambio += cambio;
    });

    const totalDeberia = totalEnCaja + totalRecibido - totalCambio - gastoEmpleado;

    // Actualizar los totales en el HTML
    document.getElementById('totalEnCaja').innerText = `RD$${totalEnCaja}`;
    document.getElementById('totalRecibido').innerText = `Total Recibido: RD$${totalRecibido}`;
    document.getElementById('totalCambio').innerText = `Total Cambio: RD$${totalCambio}`;
    document.getElementById('totalGastado').innerText = `RD$${gastoEmpleado}`;
    document.getElementById('totalDeberia').innerText = `RD$${totalDeberia}`;
  } catch (error) {
    console.error("Error al actualizar los totales:", error);
  }
};

    // Agregar eventos de entrada a cada campo editable
    document.querySelectorAll('#editForm input[type="number"]').forEach(input => {
      input.addEventListener('input', calculateTotal);
    });

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Obtener empleado seleccionado - AÑADIR ESTA VALIDACIÓN
      const empleado = document.getElementById('empleadoSelectInicio').value;
      if (!empleado) {
        alert("Por favor seleccione un empleado");
        return;
      }


      // Obtener valores de los inputs
      const denominations = {
        2000: parseInt(document.getElementById('denomination2000').value) || 0,
        1000: parseInt(document.getElementById('denomination1000').value) || 0,
        500: parseInt(document.getElementById('denomination500').value) || 0,
        200: parseInt(document.getElementById('denomination200').value) || 0,
        100: parseInt(document.getElementById('denomination100').value) || 0,
        50: parseInt(document.getElementById('denomination50').value) || 0,
        25: parseInt(document.getElementById('denomination25').value) || 0,
        10: parseInt(document.getElementById('denomination10').value) || 0,
        5: parseInt(document.getElementById('denomination5').value) || 0,
        1: parseInt(document.getElementById('denomination1').value) || 0,
      };

      // Calcular el total
      const total = (denominations[2000] * 2000) +
        (denominations[1000] * 1000) +
        (denominations[500] * 500) +
        (denominations[200] * 200) +
        (denominations[100] * 100) +
        (denominations[50] * 50) +
        (denominations[25] * 25) +
        (denominations[10] * 10) +
        (denominations[5] * 5) +
        (denominations[1] * 1);

      // Obtener los valores de las denominaciones en modo solo lectura
      const readOnlyDenominations = {
        2000: parseInt(document.getElementById('denomination2000_read').value) || 0,
        1000: parseInt(document.getElementById('denomination1000_read').value) || 0,
        500: parseInt(document.getElementById('denomination500_read').value) || 0,
        200: parseInt(document.getElementById('denomination200_read').value) || 0,
        100: parseInt(document.getElementById('denomination100_read').value) || 0,
        50: parseInt(document.getElementById('denomination50_read').value) || 0,
        25: parseInt(document.getElementById('denomination25_read').value) || 0,
        10: parseInt(document.getElementById('denomination10_read').value) || 0,
        5: parseInt(document.getElementById('denomination5_read').value) || 0,
        1: parseInt(document.getElementById('denomination1_read').value) || 0,
      };

      // Validar si las denominaciones y el total coinciden
      const denominationsMatch = Object.keys(denominations).every(key => denominations[key] === readOnlyDenominations[key]);
      const totalReadOnly = parseInt(document.getElementById('totalAmount_read').innerText.replace('RD$', '').trim()) || 0;

      if (!denominationsMatch || total !== totalReadOnly) {
        alert("Las denominaciones o el total no coinciden con los datos de caja. Por favor, verifica los montos.");
        return; // No continuar con el guardado
      }

      // Guardar o actualizar en Firebase
      try {
        const querySnapshot = await db.collection("caja").get();
        if (!querySnapshot.empty) {
          // Si ya existe un documento, actualizarlo
          const doc = querySnapshot.docs[0];
          await doc.ref.update({
            denominations: denominations,
            totalEnCaja: total,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            inicioCajaHora: firebase.firestore.FieldValue.serverTimestamp()
          });

          // AÑADIR ESTO: Registrar en el historial de caja
          await db.collection("historialCaja").add({
            accion: "Inicio de Caja Exitoso",
            empleado: empleado,
            monto: total,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // Cambiado de 'fecha' a 'timestamp'
          });

          alert("Caja actualizada exitosamente.");
        } else {
          // Si no existe, crear uno nuevo
          await db.collection("caja").add({
            denominations: denominations,
            totalEnCaja: total,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            inicioCajaHora: firebase.firestore.FieldValue.serverTimestamp()
          });

          // AÑADIR ESTO: Registrar en el historial de caja
          await db.collection("historialCaja").add({
            accion: "Inicio de Caja Exitoso",
            empleado: empleado,
            monto: total,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // Cambiado de 'fecha' a 'timestamp'
          });

          alert("Caja guardada exitosamente.");
        }

        location.reload();

      } catch (error) {
        console.error("Error al guardar la caja:", error);
        alert("Error al guardar la caja. Intenta nuevamente.");
      }
    });

    // Cargar datos de la caja al iniciar
    const loadCashData = async () => {
      const querySnapshot = await db.collection("caja").get();
      if (!querySnapshot.empty) {
        const doc = querySnapshot.docs[0].data();
        document.getElementById('denomination2000_read').value = doc.denominations[2000] || '';
        document.getElementById('denomination1000_read').value = doc.denominations[1000] || '';
        document.getElementById('denomination500_read').value = doc.denominations[500] || '';
        document.getElementById('denomination200_read').value = doc.denominations[200] || '';
        document.getElementById('denomination100_read').value = doc.denominations[100] || '';
        document.getElementById('denomination50_read').value = doc.denominations[50] || '';
        document.getElementById('denomination25_read').value = doc.denominations[25] || '';
        document.getElementById('denomination10_read').value = doc.denominations[10] || '';
        document.getElementById('denomination5_read').value = doc.denominations[5] || '';
        document.getElementById('denomination1_read').value = doc.denominations[1] || '';
        document.getElementById('totalAmount_read').innerText = `RD$${doc.totalEnCaja || 0}`; // Cambiado aquí




        // Limpiar el formulario editable
        document.getElementById('denomination2000').value = '';
        document.getElementById('denomination1000').value = '';
        document.getElementById('denomination500').value = '';
        document.getElementById('denomination200').value = '';
        document.getElementById('denomination100').value = '';
        document.getElementById('denomination50').value = '';
        document.getElementById('denomination25').value = '';
        document.getElementById('denomination10').value = '';
        document.getElementById('denomination5').value = '';
        document.getElementById('denomination1').value = '';
      }
    };

  // Cargar las facturas en tiempo real
// Cargar las facturas en tiempo real
const loadFacturasRealTime = async () => {
  try {
    // Obtener el timestamp de la colección "caja"
    const cajaSnapshot = await db.collection("caja").get();
    if (!cajaSnapshot.empty) {
      const cajaDoc = cajaSnapshot.docs[0].data();
      const cajaTimestamp = cajaDoc.timestamp.toDate(); // Convertir a objeto Date

      // Obtener las facturas generadas después del timestamp de la caja
      db.collection("facturas")
        .where("timestamp", ">", cajaTimestamp)
        .orderBy("timestamp") // Asegúrate de que los documentos estén ordenados por timestamp
        .onSnapshot((snapshot) => {
          const facturasTableBody = document.getElementById("facturasTable").getElementsByTagName("tbody")[0];
          const otrasFacturasTableBody = document.getElementById("otrasFacturasTable").getElementsByTagName("tbody")[0];
          
          // Limpiar las tablas antes de agregar nuevas filas
          facturasTableBody.innerHTML = "";
          otrasFacturasTableBody.innerHTML = "";

          let contadorEfectivo = 1;
          let contadorOtras = 1;

          snapshot.forEach(doc => {
            const factura = doc.data();
            const rowData = {
              id: factura.id,
              clientName: factura.clientName,
              clientPhone: factura.clientPhone,
              paymentMethod: factura.paymentMethod,
              amountReceived: factura.amountReceived || 0,
              changeAmount: factura.changeAmount || 0,
              total: factura.total,
              timestamp: factura.timestamp.toDate()
            };

            // Formatear el timestamp en formato de 12 horas
            const options = { hour: 'numeric', minute: 'numeric', hour12: true, year: 'numeric', month: 'numeric', day: 'numeric' };
            const fechaFormateada = rowData.timestamp.toLocaleString('es-ES', options);

            if (factura.paymentMethod === "Efectivo") {
              // Agregar a la tabla de facturas en efectivo
              const row = facturasTableBody.insertRow();
              row.insertCell(0).innerText = contadorEfectivo++;
              row.insertCell(1).innerText = rowData.id;
              row.insertCell(2).innerText = rowData.clientName;
              row.insertCell(3).innerText = rowData.clientPhone;
              row.insertCell(4).innerText = rowData.paymentMethod;
              row.insertCell(5).innerText = rowData.amountReceived;
              row.insertCell(6).innerText = rowData.changeAmount;
              row.insertCell(7).innerText = rowData.total;
              row.insertCell(8).innerText = fechaFormateada;
            } else if (factura.paymentMethod === "Transferencia" || factura.paymentMethod === "Tarjeta de Crédito") {
              // Agregar a la tabla de otras facturas
              const row = otrasFacturasTableBody.insertRow();
              row.insertCell(0).innerText = contadorOtras++;
              row.insertCell(1).innerText = rowData.id;
              row.insertCell(2).innerText = rowData.clientName;
              row.insertCell(3).innerText = rowData.clientPhone;
              row.insertCell(4).innerText = rowData.paymentMethod;
              row.insertCell(5).innerText = rowData.total;
              row.insertCell(6).innerText = fechaFormateada;
            }
          });
          updateTotals(); // Llamar a la función para actualizar los totales
        });
    }
  } catch (error) {
    console.error("Error al cargar las facturas:", error);
  }
};

    // Cargar los datos de la caja y las facturas al inicio
    loadCashData();
    loadFacturasRealTime();



    // Manejo del modal cuadre 
    const modal = document.getElementById("cuadreModal");
    const btn = document.getElementById("openModalButton");
    const span = document.getElementsByClassName("close")[0];

    // Abrir el modal
    btn.onclick = function () {
      modal.style.display = "block";
      // Actualizar el total que debe haber en caja en el modal
      const totalDeberia = document.getElementById('totalDeberia').innerText.replace('RD$', '').trim();
      document.getElementById('modalTotalDeberia').innerText = `RD$${totalDeberia}`;
    };

    // Cerrar el modal
    span.onclick = function () {
      modal.style.display = "none";
    };

    // Cerrar el modal si se hace clic fuera de él
    window.onclick = function (event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };
    // Manejo del modal cuadre FIN

    // Función para calcular el total en el modal de Cuadre de Caja
    const calcularTotalCuadre = () => {
      const denominations = {
        2000: parseInt(document.getElementById('denomination2000_modal').value) || 0,
        1000: parseInt(document.getElementById('denomination1000_modal').value) || 0,
        500: parseInt(document.getElementById('denomination500_modal').value) || 0,
        200: parseInt(document.getElementById('denomination200_modal').value) || 0,
        100: parseInt(document.getElementById('denomination100_modal').value) || 0,
        50: parseInt(document.getElementById('denomination50_modal').value) || 0,
        25: parseInt(document.getElementById('denomination25_modal').value) || 0,
        10: parseInt(document.getElementById('denomination10_modal').value) || 0,
        5: parseInt(document.getElementById('denomination5_modal').value) || 0,
        1: parseInt(document.getElementById('denomination1_modal').value) || 0,
      };

      const total = (denominations[2000] * 2000) +
        (denominations[1000] * 1000) +
        (denominations[500] * 500) +
        (denominations[200] * 200) +
        (denominations[100] * 100) +
        (denominations[50] * 50) +
        (denominations[25] * 25) +
        (denominations[10] * 10) +
        (denominations[5] * 5) +
        (denominations[1] * 1);

      document.getElementById('modalTotalAmount').innerText = `RD$${total}`;
      return total;
    };

    // Función para actualizar el estado del cuadre
    const actualizarEstadoCuadre = () => {
      const totalContado = calcularTotalCuadre();
      const totalDeberia = parseInt(document.getElementById('modalTotalDeberia').innerText.replace('RD$', '').trim()) || 0;
      const statusDiv = document.getElementById('modalStatusCuadre');

      if (totalContado === totalDeberia) {
        statusDiv.innerText = "¡Correcto!";
        statusDiv.style.color = "#3ad33a"; // Verde
      } else if (totalContado < totalDeberia) {
        const falta = totalDeberia - totalContado;
        statusDiv.innerText = `Falta: RD$${falta}`;
        statusDiv.style.color = "#ff4747"; // Rojo
      } else {
        const sobra = totalContado - totalDeberia;
        statusDiv.innerText = `Sobra: RD$${sobra}`;
        statusDiv.style.color = "#ffcc00"; // Amarillo
      }
    };

    // Agregar eventos de entrada a cada campo del formulario de "Cuadre de Caja"
    document.querySelectorAll('#cuadreForm input[type="number"]').forEach(input => {
      input.addEventListener('input', actualizarEstadoCuadre);
    });

    // Manejo del evento de envío del formulario de cuadre
    document.getElementById('cuadreForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const totalContado = calcularTotalCuadre();
      const totalDeberia = parseInt(document.getElementById('modalTotalDeberia').innerText.replace('RD$', '').trim()) || 0;

      // Aquí puedes agregar la lógica para guardar el cuadre en Firebase
    });






    // Manejo del modal "ModalInicialCaja"
    const modalInicial = document.getElementById("ModalInicialCaja");
    const btnInicial = document.getElementById("openModalInicialCaja");
    const spanInicial = modalInicial.getElementsByClassName("close")[0];

    // Abrir el modal "ModalInicialCaja"
    btnInicial.onclick = function () {
      modalInicial.style.display = "block";
    };

    // Cerrar el modal "ModalInicialCaja"
    spanInicial.onclick = function () {
      modalInicial.style.display = "none";
    };

    // Cerrar el modal si se hace clic fuera de él
    window.onclick = function (event) {
      if (event.target == modalInicial) {
        modalInicial.style.display = "none";
      }
    };
    // Manejo del modal "ModalInicialCaja" FIN


    // Calcular total y validar en tiempo real
    const updateModalTotalAndStatus = () => {
      const denominations = {
        2000: parseInt(document.getElementById('denomination2000_modal').value) || 0,
        1000: parseInt(document.getElementById('denomination1000_modal').value) || 0,
        500: parseInt(document.getElementById('denomination500_modal').value) || 0,
        200: parseInt(document.getElementById('denomination200_modal').value) || 0,
        100: parseInt(document.getElementById('denomination100_modal').value) || 0,
        50: parseInt(document.getElementById('denomination50_modal').value) || 0,
        25: parseInt(document.getElementById('denomination25_modal').value) || 0,
        10: parseInt(document.getElementById('denomination10_modal').value) || 0,
        5: parseInt(document.getElementById('denomination5_modal').value) || 0,
        1: parseInt(document.getElementById('denomination1_modal').value) || 0,
      };

      // Calcular el total
      const total = (denominations[2000] * 2000) +
        (denominations[1000] * 1000) +
        (denominations[500] * 500) +
        (denominations[200] * 200) +
        (denominations[100] * 100) +
        (denominations[50] * 50) +
        (denominations[25] * 25) +
        (denominations[10] * 10) +
        (denominations[5] * 5) +
        (denominations[1] * 1);

      document.getElementById('modalTotalAmount').innerText = `RD$${total}`;

      // Obtener el total que debe haber en caja
      const totalDeberia = parseInt(document.getElementById('totalDeberia').innerText.replace('RD$', '').trim()) || 0;

      // Validar si el total coincide
      const statusDiv = document.getElementById('modalStatus');
      if (total === totalDeberia) {
        statusDiv.innerText = "¡Correcto!";
        statusDiv.style.color = "#3ad33a";
      } else {
        const falta = totalDeberia - total;
        statusDiv.innerText = `Falta: RD$${falta}`;
        statusDiv.style.color = "#ff4747";
      }
    };

    // Función para actualizar el total que debe haber en caja en el modal
    const updateModalTotalDeberia = () => {
      const totalDeberia = parseInt(document.getElementById('totalDeberia').innerText.replace('RD$', '').trim()) || 0;
      document.getElementById('modalTotalDeberia').innerText = `RD$${totalDeberia}`;
    };

    // Agregar eventos de entrada a cada campo del modal
    document.querySelectorAll('#cuadreForm input[type="number"]').forEach(input => {
      input.addEventListener('input', () => {
        updateModalTotalAndStatus(); // Actualizar el total y el estado
        updateModalTotalDeberia(); // Actualizar el total que debe haber en caja
      });
    });





    // Agregar el evento de envío al formulario de cuadre
    document.getElementById('cuadreForm').addEventListener('submit', async function (e) {
      e.preventDefault(); // Prevenir el comportamiento por defecto del formulario

      // Obtener el total contado
      const totalContado = parseInt(document.getElementById('modalTotalAmount').innerText.replace('RD$', '').trim()) || 0;

      // Obtener el total que debe haber en caja
      const totalDeberia = parseInt(document.getElementById('modalTotalDeberia').innerText.replace('RD$', '').trim()) || 0;

      // Validar que los totales coincidan
      if (totalContado !== totalDeberia) {
        alert("El total contado no coincide con el total que debe haber en caja.");
        return; // Salir si no coinciden
      }

      try {
        // Actualizar solo el campo cuadreCajaHora en Firebase
        const cajaRef = db.collection("caja");
        const snapshot = await cajaRef.get();

        if (!snapshot.empty) {
          const doc = snapshot.docs[0];

          // Actualizar solo el campo cuadreCajaHora
          await doc.ref.update({
            cuadreCajaHora: firebase.firestore.FieldValue.serverTimestamp()
          });

          // Registrar en historial
          await db.collection("historialCaja").add({
            accion: "Cuadre de Caja Exitoso",
            empleado: document.getElementById('empleadoSelectCuadre').value,
            monto: totalContado,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

          alert("Cuadre de caja registrado exitosamente.");
          location.reload(); // Recargar la página
        } else {
          alert("No se encontró registro de caja. Realice primero un inicio de caja.");
        }
      } catch (error) {
        console.error("Error al cuadrar caja:", error);
        alert("Error al procesar el cuadre. Intente nuevamente.");
      }
    });





    // Manejo del modal "Cierre de Caja"
    const cierreCajaModal = document.getElementById("cierreCajaModal");
    const btnCierreCaja = document.getElementById("openCierreCajaModal");
    const spanCierreCaja = cierreCajaModal.getElementsByClassName("close")[0];

    // Abrir el modal "Cierre de Caja"
    btnCierreCaja.onclick = function () {
      cierreCajaModal.style.display = "block";
      loadTotalEnCaja(); // Cargar el total que debe haber en caja desde Firebase
    };

    // Cerrar el modal "Cierre de Caja"
    spanCierreCaja.onclick = function () {
      cierreCajaModal.style.display = "none";
    };

    // Cerrar el modal si se hace clic fuera de él
    window.onclick = function (event) {
      if (event.target == cierreCajaModal) {
        cierreCajaModal.style.display = "none";
      }
    };

    // Función para cargar el total que debe haber en caja desde Firebase
    const loadTotalEnCaja = async () => {
      try {
        const querySnapshot = await db.collection("caja").get();
        if (!querySnapshot.empty) {
          const doc = querySnapshot.docs[0].data();
          const totalDeberia = parseInt(document.getElementById('totalDeberia').innerText.replace('RD$', '').trim()) || 0;
          document.getElementById('modalTotalEnCaja').innerText = `RD$${totalDeberia}`;
        }
      } catch (error) {
        console.error("Error al cargar el total en caja:", error);
      }
    };

    // Función para calcular el total en tiempo real
    const calcularTotalCierre = () => {
      const denominations = {
        2000: parseInt(document.getElementById('denomination2000_cierre').value) || 0,
        1000: parseInt(document.getElementById('denomination1000_cierre').value) || 0,
        500: parseInt(document.getElementById('denomination500_cierre').value) || 0,
        200: parseInt(document.getElementById('denomination200_cierre').value) || 0,
        100: parseInt(document.getElementById('denomination100_cierre').value) || 0,
        50: parseInt(document.getElementById('denomination50_cierre').value) || 0,
        25: parseInt(document.getElementById('denomination25_cierre').value) || 0,
        10: parseInt(document.getElementById('denomination10_cierre').value) || 0,
        5: parseInt(document.getElementById('denomination5_cierre').value) || 0,
        1: parseInt(document.getElementById('denomination1_cierre').value) || 0,
      };

      // Calcular el total
      const total = (denominations[2000] * 2000) +
        (denominations[1000] * 1000) +
        (denominations[500] * 500) +
        (denominations[200] * 200) +
        (denominations[100] * 100) +
        (denominations[50] * 50) +
        (denominations[25] * 25) +
        (denominations[10] * 10) +
        (denominations[5] * 5) +
        (denominations[1] * 1);

      document.getElementById('modalTotalContado').innerText = `RD$${total}`;
      actualizarEstado(total); // Llamar a la función para actualizar el estado
    };

    // Función para actualizar el estado en el modal
    const actualizarEstado = (totalContado) => {
      const totalEnCaja = parseInt(document.getElementById('modalTotalEnCaja').innerText.replace('RD$', '').trim()) || 0;
      const statusDiv = document.getElementById('modalStatusCierre');

      if (totalContado === totalEnCaja) {
        statusDiv.innerText = "¡Correcto!";
        statusDiv.style.color = "#3ad33a"; // Verde
      } else {
        const diferencia = totalEnCaja - totalContado;
        if (diferencia > 0) {
          statusDiv.innerText = `Falta: RD$${diferencia}`;
          statusDiv.style.color = "#ff4747"; // Rojo si falta
        } else {
          statusDiv.innerText = `Sobra: RD$${Math.abs(diferencia)}`;
          statusDiv.style.color = "#ffcc00"; // Amarillo si sobra
        }
      }
    };

    // Agregar eventos de entrada a cada campo de denominación
    document.querySelectorAll('#cierreCajaForm input[type="number"]').forEach(input => {
      input.addEventListener('input', calcularTotalCierre); // Calcular el total al cambiar el valor
    });

    // Manejo del formulario de cierre de caja
    document.getElementById('cierreCajaForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      // 1. Validar empleado seleccionado
      const empleado = document.getElementById('empleadoSelectCierre').value;
      if (!empleado) {
        alert("Por favor seleccione un empleado");
        return;
      }

      // 2. Obtener denominaciones del formulario (SOLO PARA CAJA)
      const denominations = {
        2000: parseInt(document.getElementById('denomination2000_cierre').value) || 0,
        1000: parseInt(document.getElementById('denomination1000_cierre').value) || 0,
        500: parseInt(document.getElementById('denomination500_cierre').value) || 0,
        200: parseInt(document.getElementById('denomination200_cierre').value) || 0,
        100: parseInt(document.getElementById('denomination100_cierre').value) || 0,
        50: parseInt(document.getElementById('denomination50_cierre').value) || 0,
        25: parseInt(document.getElementById('denomination25_cierre').value) || 0,
        10: parseInt(document.getElementById('denomination10_cierre').value) || 0,
        5: parseInt(document.getElementById('denomination5_cierre').value) || 0,
        1: parseInt(document.getElementById('denomination1_cierre').value) || 0,
      };

      // 3. Calcular total contado
      const totalContado = Object.entries(denominations).reduce((total, [denominacion, cantidad]) => {
        return total + (parseInt(denominacion) * cantidad);
      }, 0);

      // 4. Validar coincidencia con total en caja
      const totalEnCaja = parseInt(document.getElementById('modalTotalEnCaja').innerText.replace('RD$', '').trim()) || 0;

      if (totalContado !== totalEnCaja) {
        alert(`El total contado (RD$${totalContado}) no coincide con el total en caja (RD$${totalEnCaja})`);
        return;
      }

      try {
        const cajaRef = db.collection("caja");
        const snapshot = await cajaRef.get();

        if (!snapshot.empty) {
          const doc = snapshot.docs[0];

          // 5. Actualizar SOLO en colección "caja" (con denominaciones)
          await doc.ref.update({
            denominations: denominations, // Enviar denominaciones solo aquí
            totalEnCaja: totalContado,
            cierreCajaHora: firebase.firestore.FieldValue.serverTimestamp(),
            GastoEmpleado: 0, // Reiniciar gasto
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

          // 6. Registrar en "historialCaja" (SIN DENOMINACIONES)
          await db.collection("historialCaja").add({
            accion: "Cierre de Caja Exitoso",
            empleado: empleado,
            monto: totalContado, // Solo el monto total
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
            // NO incluir denominaciones aquí
          });

          alert("Cierre de caja registrado exitosamente");
          location.reload();
        } else {
          alert("Error: No existe un registro de caja activo");
        }
      } catch (error) {
        console.error("Error al cerrar caja:", error);
        alert("Error al procesar el cierre. Intente nuevamente.");
      }
    });
    // Manejo del formulario de cierre de caja FIN





    // Función para mostrar la hora y fecha del inicio y cierre de caja
    const mostrarHorasCaja = async () => {
      const querySnapshot = await db.collection("caja").get();
      if (!querySnapshot.empty) {
        const doc = querySnapshot.docs[0].data();

        const inicioCajaHora = doc.inicioCajaHora ? doc.inicioCajaHora.toDate() : null; // Convertir a objeto Date
        const cierreCajaHora = doc.cierreCajaHora ? doc.cierreCajaHora.toDate() : null; // Convertir a objeto Date

        // Mostrar la hora y fecha del inicio de caja
        if (inicioCajaHora) {
          const options = { hour: 'numeric', minute: 'numeric', hour12: true };
          const timeStringInicio = inicioCajaHora.toLocaleString('es-ES', options);

          const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
          const dateStringInicio = inicioCajaHora.toLocaleString('es-ES', dateOptions);

          document.getElementById('inicioCajaHora').innerText = `${timeStringInicio} - ${dateStringInicio}`;
        }

        // Mostrar la hora y fecha del cierre de caja
        if (cierreCajaHora) {
          const options = { hour: 'numeric', minute: 'numeric', hour12: true };
          const timeStringCierre = cierreCajaHora.toLocaleString('es-ES', options);

          const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
          const dateStringCierre = cierreCajaHora.toLocaleString('es-ES', dateOptions);

          document.getElementById('cierreCajaHoraDisplay').innerText = `${timeStringCierre} - ${dateStringCierre}`;
        }

        // Comparar y mostrar solo el más reciente
        if (inicioCajaHora && cierreCajaHora) {
          if (cierreCajaHora > inicioCajaHora) {
            document.getElementById('cierreCajaInfo').style.display = 'block';
            document.getElementById('inicioCajaInfo').style.display = 'none';
          } else {
            document.getElementById('inicioCajaInfo').style.display = 'block';
            document.getElementById('cierreCajaInfo').style.display = 'none';
          }
        } else if (inicioCajaHora) {
          document.getElementById('inicioCajaInfo').style.display = 'block';
          document.getElementById('cierreCajaInfo').style.display = 'none';
        } else if (cierreCajaHora) {
          document.getElementById('cierreCajaInfo').style.display = 'block';
          document.getElementById('inicioCajaInfo').style.display = 'none';
        } else {
          // Si no hay ninguno, ocultar ambos
          document.getElementById('inicioCajaInfo').style.display = 'none';
          document.getElementById('cierreCajaInfo').style.display = 'none';
        }
      }
    };

    // Llamar a la función para mostrar las horas de caja al cargar la página
    mostrarHorasCaja();




    // Función para mostrar la hora y fecha del cuadre de caja
    const mostrarCuadreCaja = async () => {
      const querySnapshot = await db.collection("caja").get();
      if (!querySnapshot.empty) {
        const doc = querySnapshot.docs[0].data();

        const cuadreCajaHora = doc.cuadreCajaHora ? doc.cuadreCajaHora.toDate() : null; // Convertir a objeto Date

        // Mostrar la hora y fecha del cuadre de caja
        if (cuadreCajaHora) {
          const options = { hour: 'numeric', minute: 'numeric', hour12: true };
          const timeStringCuadre = cuadreCajaHora.toLocaleString('es-ES', options);

          const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
          const dateStringCuadre = cuadreCajaHora.toLocaleString('es-ES', dateOptions);

          document.getElementById('cuadreCajaHora').innerText = `${timeStringCuadre} - ${dateStringCuadre}`;
        }
      }
    };

    // Llamar a la función para mostrar la hora del cuadre de caja al cargar la página
    mostrarCuadreCaja();






    // Manejo del modal "Retiro por Empleado"
    const retiroEmpleadoModal = document.getElementById("retiroEmpleadoModal");
    const btnRetiroEmpleado = document.getElementById("openRetiroEmpleadoModal");
    const spanRetiroEmpleado = retiroEmpleadoModal.getElementsByClassName("close")[0];

    // Abrir el modal "Retiro por Empleado"
    btnRetiroEmpleado.onclick = function () {
      retiroEmpleadoModal.style.display = "block";
      // Mostrar el total que debe haber en caja
      const totalDeberia = document.getElementById('totalDeberia').innerText;
      document.getElementById('modalTotalDeberiaEmpleado').innerText = totalDeberia;
    };

    // Cerrar el modal "Retiro por Empleado"
    spanRetiroEmpleado.onclick = function () {
      retiroEmpleadoModal.style.display = "none";
    };

    // Cerrar el modal si se hace clic fuera de él
    window.onclick = function (event) {
      if (event.target == retiroEmpleadoModal) {
        retiroEmpleadoModal.style.display = "none";
      }
    };

    // Función para calcular el total a retirar en tiempo real
    const calcularTotalRetiroEmpleado = () => {
      const total = Array.from(document.querySelectorAll('#retiroEmpleadoForm input[type="number"]'))
        .reduce((acc, input) => acc + (parseInt(input.value) || 0) * parseInt(input.id.replace('denomination', '').replace('_empleado', '')) || 0, 0);

      document.getElementById('totalRetiroEmpleado').innerText = `RD$${total}`;
    };

    // Agregar eventos de entrada a cada campo del formulario
    document.querySelectorAll('#retiroEmpleadoForm input[type="number"]').forEach(input => {
      input.addEventListener('input', calcularTotalRetiroEmpleado);
    });

    // Función para cargar el total gastado desde Firebase
    const loadTotalGastado = async () => {
      try {
        const querySnapshot = await db.collection("caja").get();
        if (!querySnapshot.empty) {
          const doc = querySnapshot.docs[0].data();
          const gastoEmpleado = doc.GastoEmpleado || 0;
          document.getElementById('totalGastado').innerText = `RD$${gastoEmpleado}`;

          // Actualizar el total que debe haber en caja restando el gasto
          const totalDeberiaOriginal = parseInt(document.getElementById('totalDeberia').innerText.replace('RD$', '').trim()) || 0;
          const nuevoTotalDeberia = totalDeberiaOriginal - gastoEmpleado;
          document.getElementById('totalDeberia').innerText = `RD$${nuevoTotalDeberia}`;
        }
      } catch (error) {
        console.error("Error al cargar el total gastado:", error);
      }
    };

    // Llamar a la función al cargar la página
    loadTotalGastado();




    // Función para cargar empleados en el select de inicio de caja
    const loadEmpleadosInicioCaja = async () => {
      try {
        const empleadosSelect = document.getElementById('empleadoSelectInicio');
        empleadosSelect.innerHTML = '<option value="">Seleccione un empleado</option>';

        const querySnapshot = await db.collection("empleados").orderBy("nombre").get();

        if (querySnapshot.empty) {
          console.warn("No se encontraron empleados en la base de datos");
          return;
        }

        querySnapshot.forEach(doc => {
          const empleado = doc.data();
          if (empleado.nombre) {
            const option = document.createElement('option');
            option.value = empleado.nombre;
            option.textContent = empleado.nombre;
            empleadosSelect.appendChild(option);
          }
        });

      } catch (error) {
        console.error("Error al cargar empleados:", error);
        alert("Error al cargar la lista de empleados. Recargue la página.");
      }
    };

    // Modificar el evento de apertura del modal para Iniciar Caja
    btnInicial.onclick = async function () {
      // Verificar si la caja ya está abierta
      const inicioCajaInfo = document.getElementById('inicioCajaInfo');
      if (inicioCajaInfo.style.display === 'block') {
        alert("La caja ya está iniciada");
        btnInicial.style.cursor = 'not-allowed';
        return;
      }

      modalInicial.style.display = "block";
      await loadEmpleadosInicioCaja();
    };





    const loadEmpleados = async () => {
      try {
        const empleadosSelect = document.getElementById('empleadoSelect');
        empleadosSelect.innerHTML = '<option value="">Seleccione un empleado</option>';

        const querySnapshot = await db.collection("empleados").orderBy("nombre").get();

        if (querySnapshot.empty) {
          console.warn("No se encontraron empleados en la base de datos");
          return;
        }

        querySnapshot.forEach(doc => {
          const empleado = doc.data();
          if (empleado.nombre) {
            const option = document.createElement('option');
            option.value = empleado.nombre;
            option.textContent = empleado.nombre;
            empleadosSelect.appendChild(option);
          }
        });

      } catch (error) {
        console.error("Error al cargar empleados:", error);
        alert("Error al cargar la lista de empleados. Recargue la página.");
      }
    };



    // Función para cargar empleados en el select de cuadre
    const loadEmpleadosCuadre = async () => {
      try {
        const empleadosSelect = document.getElementById('empleadoSelectCuadre');
        empleadosSelect.innerHTML = '<option value="">Seleccione un empleado</option>';

        const querySnapshot = await db.collection("empleados").orderBy("nombre").get();

        querySnapshot.forEach(doc => {
          const empleado = doc.data();
          if (empleado.nombre) {
            const option = document.createElement('option');
            option.value = empleado.nombre;
            option.textContent = empleado.nombre;
            empleadosSelect.appendChild(option);
          }
        });
      } catch (error) {
        console.error("Error al cargar empleados:", error);
      }
    };

    // Modificar el evento de apertura del modal de cuadre
    btn.onclick = async function () {
      modal.style.display = "block";
      // Actualizar el total que debe haber en caja en el modal
      const totalDeberia = document.getElementById('totalDeberia').innerText.replace('RD$', '').trim();
      document.getElementById('modalTotalDeberia').innerText = `RD$${totalDeberia}`;

      // Cargar los empleados
      await loadEmpleadosCuadre();
    };





    // Función para cargar empleados en el select de cierre
    const loadEmpleadosCierre = async () => {
      try {
        const empleadosSelect = document.getElementById('empleadoSelectCierre');
        empleadosSelect.innerHTML = '<option value="">Seleccione un empleado</option>';

        const querySnapshot = await db.collection("empleados").orderBy("nombre").get();

        querySnapshot.forEach(doc => {
          const empleado = doc.data();
          if (empleado.nombre) {
            const option = document.createElement('option');
            option.value = empleado.nombre;
            option.textContent = empleado.nombre;
            empleadosSelect.appendChild(option);
          }
        });
      } catch (error) {
        console.error("Error al cargar empleados:", error);
      }
    };


    // Modificar el evento de apertura del modal para Cierre de Caja
    btnCierreCaja.onclick = async function () {
      // Verificar si la caja está cerrada
      const cierreCajaInfo = document.getElementById('cierreCajaInfo');
      if (cierreCajaInfo.style.display === 'block') {
        alert("La caja ya está cerrada");
        btnCierreCaja.style.cursor = 'not-allowed';
        return;
      }

      cierreCajaModal.style.display = "block";
      await loadEmpleadosCierre();
      loadTotalEnCaja();
    };


    // Función para actualizar el estado de los botones
    const actualizarEstadoBotones = () => {
      const inicioCajaInfo = document.getElementById('inicioCajaInfo');
      const cierreCajaInfo = document.getElementById('cierreCajaInfo');

      // Botón Iniciar Caja
      if (inicioCajaInfo.style.display === 'block') {
        document.getElementById('openModalInicialCaja').disabled = true;
        document.getElementById('openModalInicialCaja').style.cursor = 'not-allowed';
      } else {
        document.getElementById('openModalInicialCaja').disabled = false;
        document.getElementById('openModalInicialCaja').style.cursor = 'pointer';
      }

      // Botón Cierre de Caja
      if (cierreCajaInfo.style.display === 'block') {
        document.getElementById('openCierreCajaModal').disabled = true;
        document.getElementById('openCierreCajaModal').style.cursor = 'not-allowed';
      } else {
        document.getElementById('openCierreCajaModal').disabled = false;
        document.getElementById('openCierreCajaModal').style.cursor = 'pointer';
      }
    };

    // Llamar a esta función cuando se cargue la página y después de cualquier cambio de estado
    document.addEventListener('DOMContentLoaded', () => {
      actualizarEstadoBotones();
      mostrarHorasCaja(); // Esta función ya existe en tu código
    });

    // También llamarla después de cualquier operación que cambie el estado de la caja
    // Por ejemplo, después de iniciar o cerrar caja


    // Función para generar ID basado en timestamp (formato: tgeDDMMYY-HHMMSS)
    const generarIdTimestamp = () => {
      const now = new Date();

      // Obtener componentes de fecha (DDMMYY)
      const day = String(now.getDate()).padStart(2, '0');       // Día (01-31)
      const month = String(now.getMonth() + 1).padStart(2, '0'); // Mes (01-12)
      const year = now.getFullYear().toString().slice(-2);      // Año (2 dígitos)

      // Obtener componentes de hora (HHMMSS)
      const hours = String(now.getHours()).padStart(2, '0');    // Hora (00-23)
      const minutes = String(now.getMinutes()).padStart(2, '0'); // Minutos (00-59)
      const seconds = String(now.getSeconds()).padStart(2, '0'); // Segundos (00-59)

      // Formar el ID (tge + DDMMYY-HHMMSS)
      return `tge${day}${month}${year}-${hours}${minutes}${seconds}`;
    };

    // Ejemplo de IDs generados:
    // tge260325-163240 (26/marzo/2025 a las 16:32:40)
    // tge010425-092015 (1/abril/2025 a las 09:20:15)


    // Modificar el manejador del botón de confirmar retiro para validar campos
    document.getElementById('confirmarRetiroEmpleado').addEventListener('click', async function () {
      const totalRetiro = parseInt(document.getElementById('totalRetiroEmpleado').innerText.replace('RD$', '').trim()) || 0;
      const empleado = document.getElementById('empleadoSelect').value;
      const detalles = document.getElementById('detallesGasto').value;

      // Validaciones básicas
      if (totalRetiro <= 0) {
        alert("Por favor ingrese un monto válido para retirar.");
        return;
      }

      if (!empleado) {
        alert("Por favor seleccione un empleado.");
        return;
      }

      if (!detalles || detalles.trim() === "") {
        alert("Por favor describa el motivo del gasto.");
        return;
      }

      try {
        // Verificar que el monto no exceda el disponible
        const cajaSnapshot = await db.collection("caja").get();
        if (cajaSnapshot.empty) {
          alert("No se encontraron datos en la colección 'caja'.");
          return;
        }

        const cajaDoc = cajaSnapshot.docs[0].data();
        const totalDisponible = cajaDoc.totalEnCaja || 0;

        if (totalRetiro > totalDisponible) {
          alert(`No hay suficiente efectivo en caja. Disponible: RD$${totalDisponible}`);
          return;
        }

        // Registrar en el historial de caja
        await db.collection("historialCaja").add({
          accion: "Retiro de Efectivo por Empleado",
          empleado: empleado,
          monto: totalRetiro,
          detalles: detalles,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Actualizar el gasto del empleado en la caja
        const currentGasto = cajaDoc.GastoEmpleado || 0;
        await cajaSnapshot.docs[0].ref.update({
          GastoEmpleado: currentGasto + totalRetiro
        });

        alert("Retiro por empleado registrado exitosamente.");
        location.reload();

      } catch (error) {
        console.error("Error al registrar el retiro por empleado:", error);
        alert("Error al registrar el retiro. Intenta nuevamente.");
      }
    });




    // Modificar el evento de apertura del modal de retiro por empleado
    btnRetiroEmpleado.onclick = async function () {
      retiroEmpleadoModal.style.display = "block";
      // Mostrar el total que debe haber en caja
      const totalDeberia = document.getElementById('totalDeberia').innerText;
      document.getElementById('modalTotalDeberiaEmpleado').innerText = totalDeberia;
      calcularQuedariaEnRetiroEmpleado(); // Calcular lo que quedaría en caja al abrir el modal
      // Cargar los empleados
      await loadEmpleados();
    };











    // Manejo del modal Historial
    const historialModal = document.getElementById("historialModal");
    const btnHistorial = document.getElementById("openHistorialModal");
    const spanHistorial = historialModal.getElementsByClassName("close")[0];

    // Abrir el modal Historial
    btnHistorial.onclick = async function () {
      historialModal.style.display = "block";
      await cargarHistorial();
    };

    // Cerrar el modal Historial
    spanHistorial.onclick = function () {
      historialModal.style.display = "none";
    };

    // Cerrar el modal si se hace clic fuera de él
    window.onclick = function (event) {
      if (event.target == historialModal) {
        historialModal.style.display = "none";
      }
    };




    // Función para cargar el historial desde Firebase
    // Variables para la paginación
    let lastVisible = null;
    const limit = 10;

    // Función para cargar el historial con paginación
    const cargarHistorial = async (loadMore = false) => {
      try {
        const historialList = document.getElementById("historialList");
        const loadMoreButton = document.getElementById("loadMoreButton");
        const noMoreRecords = document.getElementById("noMoreRecords");

        if (!loadMore) {
          // Primera carga, reiniciar variables
          historialList.innerHTML = "";
          lastVisible = null;
          loadMoreButton.style.display = "none";
          noMoreRecords.style.display = "none";
        }

        let query = db.collection("historialCaja")
          .orderBy("timestamp", "desc")
          .limit(limit);

        if (loadMore && lastVisible) {
          query = query.startAfter(lastVisible);
        }

        const querySnapshot = await query.get();

        if (querySnapshot.empty && !loadMore) {
          const li = document.createElement("li");
          li.innerText = "No hay transacciones registradas";
          historialList.appendChild(li);
          return;
        }

        if (!querySnapshot.empty) {
          lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];

          querySnapshot.forEach(doc => {
            const transaccion = doc.data();
            const li = document.createElement("li");

            // Asignar la categoría según la acción
            let categoria;
            switch (transaccion.accion) {
              case "Inicio de Caja Exitoso":
                categoria = "inicio";
                break;
              case "Cierre de Caja Exitoso":
                categoria = "cierre";
                break;
              case "Cuadre de Caja Exitoso":
                categoria = "cuadre";
                break;
              case "Retiro de Efectivo por Empleado":
                categoria = "retiro-empleado";
                break;
              case "Ingreso de Efectivo Exitoso":
                categoria = "ingreso";
                break;
              case "Retiro de Efectivo Exitoso":
                categoria = "retiro";
                break;
              default:
                categoria = "otro";
            }

            li.setAttribute("data-categoria", categoria);

            const fecha = transaccion.timestamp.toDate();
            const opcionesFecha = {
              timeZone: 'America/Santo_Domingo',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            };
            const fechaFormateada = fecha.toLocaleString('es-DO', opcionesFecha);

            let contenidoHTML = `
          <div class="accion">Acción: ${transaccion.accion || 'No especificada'}</div>
          <div class="fecha"><strong>Fecha:</strong> ${fechaFormateada}</div>
          <div class="empleado"><strong>Empleado:</strong> ${transaccion.empleado || 'No especificado'}</div>
          <div class="monto">Monto: RD$${transaccion.monto || 0}</div>
        `;

            if (transaccion.accion === "Retiro de Efectivo por Empleado" && transaccion.detalles) {
              contenidoHTML += `<div class="detalles"><strong>Detalles:</strong> ${transaccion.detalles}</div>`;
            }

            li.innerHTML = contenidoHTML;
            historialList.appendChild(li);
          });

          // Mostrar u ocultar botón según si hay más registros
          if (querySnapshot.size === limit) {
            loadMoreButton.style.display = "block";
            noMoreRecords.style.display = "none";
          } else {
            loadMoreButton.style.display = "none";
            noMoreRecords.style.display = "block";
          }
        } else if (loadMore) {
          loadMoreButton.style.display = "none";
          noMoreRecords.style.display = "block";
        }
      } catch (error) {
        console.error("Error al cargar el historial:", error);
        alert("Error al cargar el historial. Intente nuevamente.");
      }
    };

    // Evento para el botón Cargar más
    document.getElementById("loadMoreButton").addEventListener("click", () => {
      cargarHistorial(true);
    });

    // Modificar el evento de apertura del modal
    btnHistorial.onclick = async function () {
      historialModal.style.display = "block";
      await cargarHistorial(false); // Cargar primeros 10 registros
    };

  </script>


</body>

</html>

<!-- 20 -->
