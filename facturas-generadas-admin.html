<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Facturas - Paris Laundry</title>
  <link rel="icon" href="./img/Paris Laundry 1.png" type="image/png">
  <link rel="stylesheet" href="./css/styles_facturas.css">
  <link rel="stylesheet" href="./css/styles_menu.css">
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
  <script src="./js/menu.js" defer></script>
</head>

<body>

  <div class="MasterBox0">

    <laundry-menu></laundry-menu>

    <div class="container_facturas">

      <div class="panelFacturas_tittle">
        <h2>Lista de Facturas</h2>
        <button class="button" id="historyButton"><img src="./img/icon/historial1.png">Historial</button>
      </div>

      <div class="panelFacturas_body">
        <div class="box_btns_facturas">
          <button class="button" id="pendingInvoicesButton"><img src="./img/icon/atencion1.png">Facturas con Pago
            Pendiente <div class="facturas-count" id="facturasCountPendienteDup">0</div></button>
          <button class="button" id="paidInvoicesButton"><img src="./img/icon/lavando2.gif">Facturas - En Proceso de
            Lavado <div class="facturas-count" id="facturasCountPagadoDup">0</div></button>
          <button class="button" id="readyInvoicesButton"><img src="./img/icon/check1.png">Facturas Pagadas - Listo <div
              class="facturas-count" id="facturasCountPagadoListoDup">0</div></button>
          <button class="button" id="deliveredInvoicesButton"><img src="./img/icon/hamper_color.png">Facturas
            Entregadas</button>
        </div>


        <div class="table_search_master">
          <h2 id="invoiceTitle" class="title pending">Facturas con Pago Pendiente</h2>

          <div class="box_search-container">
            <div class="search-container">
              <input type="text" id="searchInput" placeholder="Buscar por ID, Nombre, Tel√©fono o monto..." />
              <div class="cantidad-img"><img src="./img/icon/buscar3.png"></div>
            </div>
          </div>

          <div class="transaction-table-container">
            <table id="invoicesTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre del Cliente</th>
                  <th>N√∫mero de Tel√©fono</th>
                  <th>Monto</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="invoicesBody">
                <!-- Las facturas se cargar√°n aqu√≠ -->
              </tbody>
            </table>
            <div id="noInvoicesMessage" class="no-invoices hidden">No hay facturas aqu√≠</div>
            <!-- Contenedor para el bot√≥n de cargar m√°s -->
            <div class="load-more-container" id="loadMoreContainer" style="display: none;">
              <button id="loadMoreInvoicesBtn" class="load-more-btn">Cargar m√°s</button>
              <div class="no-more-records" id="noMoreInvoices">No hay m√°s registros</div>
            </div>
          </div>
        </div>


      </div>

      <div class="panelFacturas_down">
        <footer-content></footer-content>
      </div>
    </div>

  </div>

  <!-- Modal para mostrar detalles de la factura -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">

      <div class="modal_preview_factura_tittle">
        <span class="close" id="closeModal">&times;</span>
        <h2>Detalles de la Factura</h2>
      </div>

      <div class="modal_preview_factura_body">
        <div id="modalInvoiceDetails"></div>
        <div id="paymentDetails" style="display: none;">
          <strong>Monto Recibido:</strong> <span id="amountReceivedDisplay"></span><br>
          <strong>Cambio:</strong> <span id="changeDisplay"></span><br>
        </div>
      </div>

      <div class="modal_preview_factura_down">
        <!-- Secci√≥n de Abono (se mostrar√° solo para facturas con abono) -->
        <div id="abonoSection" style="display: none;">
          <div class="payment-method-abono">
            <h3>Pagar Abono</h3>


            <div class="payment-options-abono">
              <div class="payment-option-abono" data-method="efectivo">Efectivo</div>
              <div class="payment-option-abono" data-method="transferencia">Transferencia</div>
              <div class="payment-option-abono" data-method="tarjeta">Tarjeta de Cr√©dito</div>
            </div>

            <div id="montoPendienteAbono" class="abono-pendiente"></div>

            <div id="efectivoInputAbono" style="display: inline-flex;justify-content: space-evenly;width: 100%;box-sizing: border-box;padding: 0px 22px;font-size: 21px;">
              <label>Monto Recibido:</label>
              <div>
                <div class="input-container">
                  <span class="prefix">RD$</span>
                  <input type="text" id="amountReceivedAbono" placeholder="0" maxlength="6"
                    oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);">
                </div>
                <div id="changeAmountAbono" style="margin-top: 5px;"></div>
              </div>

            </div>


          </div>
        </div>

        <div class="payment-method-container" id="paymentMethodContainer">
          <h2 style="text-align: center;margin-block-start: 5px;margin-block-end: 5px;">M√©todo de Pago:</h2>
          <div class="button-metodo-pago">
            <button id="cashPayment" class="payment-button" value="Efectivo">Efectivo <span>üíµ</span></button>
            <button id="transferPayment" class="payment-button" value="Transferencia">Transferencia
              <span>üì≤</span></button>
            <button id="cardPayment" class="payment-button" value="Tarjeta de Cr√©dito">Tarjeta de <span>Cr√©dito
                üí≥</span></button>
          </div>

          <div class="cashPaymentOptions_master">
            <div class="cube-montos">
              <div class="cube-form-flex">
                <div>
                  <label>Total a Pagar:</label>
                </div>
                <div>
                  <span id="totalToPay" style="color: #189dff;font-weight: bold;">RD$0.00</span>
                </div>
              </div>

              <div id="cashPaymentOptions" class="hidden">
                <div class="cube-form-flex">
                  <div>
                    <label>Monto Recibido:</label>
                  </div>
                  <div>
                    <div class="input-container">
                      <span class="prefix">RD$</span>
                      <input type="text" id="amountReceived" placeholder="0" maxlength="6"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);">
                    </div>
                  </div>
                </div>

                <div class="cube-form-flex">
                  <div>
                    <label>Cambio:</label>
                  </div>
                  <div>
                    <span id="changeAmount" style="font-weight: bold;color: #f96dd3;">RD$0.00</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="Cube_button_pagado">
          <select id="employeeSelect" required>
            <option value="">Seleccionar Empleado</option>
            <!-- Las opciones de empleados se llenar√°n din√°micamente -->
          </select>

          <button id="pagarAbonoBtn" class="btn-pagar-abono" disabled style="display: none;">PAGAR ABONO</button>
          <button id="markAsPaidButton" class="disabled" style="display: none;">Marcar Como Pagado</button>
          <button id="markAsReadyButton" style="display: none;">Marcar como Listo</button>
          <button id="markAsDeliveredButton" style="display: none;">Marcar como Entregado</button>
        </div>
      </div>
    </div>
  </div>

  <!-- El resto del c√≥digo HTML permanece igual -->

  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal_preview_factura_tittle">
        <span class="close" id="closeHistoryModal">&times;</span>
        <h2>Historial de Estados</h2>
      </div>
      <div id="modal_historial" class="modal_preview_factura_body">
        <ul id="historyList">
          <!-- Los elementos de historial se llenar√°n din√°micamente -->
        </ul>
        <div class="load-more-container">
          <button id="loadMoreBtn" class="load-more-btn">Cargar m√°s</button>
          <div class="no-more-records" id="noMoreRecords">No hay m√°s registros</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDdG-CP2kO3v-zkkjD17Wj028QJvjp54qY",
      authDomain: "paris-laundry.firebaseapp.com",
      projectId: "paris-laundry",
      storageBucket: "paris-laundry.appspot.com",
      messagingSenderId: "1022712814457",
      appId: "1:1022712814457:web:7bddb47ed46bac22c32da8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const invoicesBody = document.getElementById("invoicesBody");
    const invoiceModal = document.getElementById("invoiceModal");
    const modalInvoiceDetails = document.getElementById("modalInvoiceDetails");
    const closeModal = document.getElementById("closeModal");
    const markAsPaidButton = document.getElementById("markAsPaidButton");
    const markAsReadyButton = document.getElementById("markAsReadyButton");
    const markAsDeliveredButton = document.getElementById("markAsDeliveredButton");
    const paymentDetails = document.getElementById("paymentDetails");
    const amountReceivedDisplay = document.getElementById("amountReceivedDisplay");
    const changeDisplay = document.getElementById("changeDisplay");
    const searchInput = document.getElementById("searchInput");
    const invoiceTitle = document.getElementById("invoiceTitle");
    const totalToPay = document.getElementById("totalToPay");
    const amountReceivedInput = document.getElementById("amountReceived");
    const changeAmount = document.getElementById("changeAmount");
    const cashPaymentOptions = document.getElementById("cashPaymentOptions");
    const paymentButtons = document.querySelectorAll(".payment-button");
    const loadMoreInvoicesBtn = document.getElementById("loadMoreInvoicesBtn");
    const noMoreInvoices = document.getElementById("noMoreInvoices");
    const loadMoreContainer = document.getElementById("loadMoreContainer");

    // Obtener referencias a los nuevos elementos del abono
    const abonoSection = document.getElementById("abonoSection");
    const montoPendienteAbono = document.getElementById("montoPendienteAbono");
    const pagarAbonoBtn = document.getElementById("pagarAbonoBtn");
    const amountReceivedAbono = document.getElementById("amountReceivedAbono");
    const changeAmountAbono = document.getElementById("changeAmountAbono");
    const efectivoInputAbono = document.getElementById("efectivoInputAbono");
    const paymentOptionsAbono = document.querySelectorAll(".payment-option-abono");

    // Variables para controlar el m√©todo de pago seleccionado para el abono
    let selectedPaymentMethodAbono = null;
    let currentPendingAmount = 0;


    let currentInvoiceId = null;
    let currentInvoiceData = null;
    let invoices = [];
    let lastInvoiceDoc = null;
    let isSearching = false;
    let currentStatus = "pago pendiente";
    let unsubscribe = null;

    // Funci√≥n para formatear n√∫meros con separadores de miles
    function formatNumberWithCommas(number) {
      return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    const loadEmployees = async () => {
      const employeesSnapshot = await db.collection("empleados").get();
      const employeeSelect = document.getElementById("employeeSelect");

      employeesSnapshot.forEach(doc => {
        const employee = doc.data();
        const option = document.createElement("option");
        option.value = employee.nombre;
        option.textContent = employee.nombre;
        employeeSelect.appendChild(option);
      });
    };

    loadEmployees();

    // Funci√≥n para cargar facturas con paginaci√≥n
    const loadInvoices = async (status, loadMore = false) => {
      currentStatus = status;

      if (!loadMore) {
        // Si es una carga nueva, reiniciamos
        invoices = [];
        invoicesBody.innerHTML = "";
        lastInvoiceDoc = null;
        loadMoreContainer.style.display = "none";
        noMoreInvoices.style.display = "none";
      }

      try {
        let query = db.collection("facturas")
          .where("status", "==", status)
          .orderBy("timestamp", "desc")
          .limit(15);

        if (loadMore && lastInvoiceDoc) {
          query = query.startAfter(lastInvoiceDoc);
        }

        const snapshot = await query.get();

        if (snapshot.empty) {
          if (loadMore) {
            // No hay m√°s facturas para cargar
            noMoreInvoices.style.display = "inline-flex";
            loadMoreInvoicesBtn.style.display = "none";
          } else {
            // No hay facturas en absoluto
            document.getElementById("noInvoicesMessage").classList.remove("hidden");
          }
          return;
        }

        // Ocultar mensaje de no hay facturas si estamos cargando m√°s
        document.getElementById("noInvoicesMessage").classList.add("hidden");

        // Guardamos el √∫ltimo documento para la paginaci√≥n
        lastInvoiceDoc = snapshot.docs[snapshot.docs.length - 1];

        // Procesamos los nuevos documentos
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.timestamp instanceof firebase.firestore.Timestamp) {
            // Verificar que la factura no exista ya en el array
            if (!invoices.some(invoice => invoice.id === doc.id)) {
              invoices.push({ id: doc.id, ...data });
            }
          }
        });

        // Mostrar u ocultar el bot√≥n de cargar m√°s
        if (snapshot.docs.length === 15 && status === "pagado entregado") {
          loadMoreContainer.style.display = "block";
          loadMoreInvoicesBtn.style.display = "inline-flex";
          noMoreInvoices.style.display = "none";
        } else if (loadMore) {
          // Si estamos cargando m√°s y no llegamos al l√≠mite, ocultar el bot√≥n
          loadMoreInvoicesBtn.style.display = "none";
          noMoreInvoices.style.display = "inline-flex";
        }

        // Renderizar las facturas
        renderInvoices();
        updateTitleAndBackground(status);
      } catch (error) {
        console.error("Error al cargar facturas:", error);
        alert("Error al cargar facturas. Intente nuevamente.");
      }
    };


    // Funci√≥n para renderizar las facturas en la tabla
    const renderInvoices = () => {
      // Siempre limpiar el cuerpo de la tabla antes de renderizar
      invoicesBody.innerHTML = "";

      invoices.forEach((invoice) => {
        const row = document.createElement("tr");
        const formattedDate = invoice.timestamp.toDate().toLocaleString('es-ES', {
          timeZone: 'America/Santo_Domingo',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });

        const formattedTotal = `RD$${formatNumberWithCommas(invoice.total.toFixed(2))}`;

        // Verificar si es un abono
        const abonoText = invoice.abonoFact === "yes" ? '<span style="color: red; margin-left: 5px;">Abono</span>' : '';

        row.innerHTML = `
                <td>${invoice.id}</td>
                <td>${invoice.clientName}${abonoText}</td>
                <td>${invoice.clientPhone}</td>
                <td>${formattedTotal}</td>
                <td>${formattedDate}</td>
            `;
        row.addEventListener("click", () => {
          currentInvoiceId = invoice.id;
          currentInvoiceData = invoice;
          showInvoiceDetails(invoice);
        });
        invoicesBody.appendChild(row);
      });
    };

    // Evento para el bot√≥n de cargar m√°s facturas
    loadMoreInvoicesBtn.addEventListener("click", () => {
      loadInvoices(currentStatus, true);
    });

    const updateTitleAndBackground = (status) => {
      switch (status) {
        case "pago pendiente":
          invoiceTitle.textContent = "Facturas con Pago Pendiente";
          invoiceTitle.className = "title pending";
          break;
        case "pagado":
          invoiceTitle.textContent = "Facturas Pagadas - En Proceso de Lavado";
          invoiceTitle.className = "title paid";
          break;
        case "pagado listo":
          invoiceTitle.textContent = "Facturas Pagadas - Listo";
          invoiceTitle.className = "title ready";
          break;
        case "pagado entregado":
          invoiceTitle.textContent = "Facturas Entregadas";
          invoiceTitle.className = "title delivered";
          break;
      }
    };

    const showInvoiceDetails = (data) => {
      // Resetear el select de empleados
      document.getElementById("employeeSelect").value = "";
      const services = data.selectedServices.map(service => `<div>${service.name} (Peso: ${service.weight} lbs) - RD$${service.price}</div>`).join("");
      const otherServices = data.otrosServicios.map(service => `<div>${service.name}: ${service.count} - RD$${(service.count * service.price).toFixed(2)}</div>`).join("");
      const products = data.selectedProducts.map(product => `<div>${product.name} (Cantidad: ${product.quantity}) - RD$${(product.quantity * product.price).toFixed(2)}</div>`).join("");
      const delivery = data.deliveryOption[0].name + " - RD$" + data.deliveryOption[0].price;

      // Verificar si es un abono (sin importar el status)
      const isAbono = data.abonoFact === "yes";

      // Calcular saldo pendiente si es abono
      currentPendingAmount = isAbono && data.amountReceived
        ? (data.total - data.amountReceived)
        : 0;

      const formattedDate = data.timestamp.toDate().toLocaleString('es-ES', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: 'numeric',
        minute: 'numeric',
        hour12: true
      });

      // Construir el HTML para los detalles del pago
      let paymentDetailsHTML = '';
      if (isAbono && data.amountReceived) {
        paymentDetailsHTML = `
          <strong>Total Factura:</strong> RD$${data.total.toFixed(2)}<br>
          <strong>Abono Recibido:</strong> RD$${data.amountReceived.toFixed(2)}<br>
          <strong>Saldo Pendiente:</strong> RD$${currentPendingAmount.toFixed(2)}<br>
      `;
      } else {
        paymentDetailsHTML = `
          <strong>Total:</strong> RD$${data.total.toFixed(2)}<br>
      `;
      }

      modalInvoiceDetails.innerHTML = `
      <strong>ID:</strong> ${data.id}<br>
      <strong>Fecha:</strong> ${formattedDate}</p>
      <strong>Cliente:</strong> ${data.clientName}${isAbono ? '<span style="color: red;"> (Abono)</span>' : ''}<br>
      <strong>N√∫mero:</strong> ${data.clientPhone}<br>
      <strong>Servicios de Hamper:</strong><br>${services || "Ninguno"}<br>
      <strong>Otros Servicios:</strong><br>${otherServices || "Ninguno"}<br>
      <strong>Productos Adicionales:</strong><br>${products || "Ninguno"}<br>
      <strong>Opci√≥n de Delivery:</strong> ${delivery}<p>
      ${paymentDetailsHTML}
      <strong>Estado:</strong> ${data.status}<br>
      <strong>M√©todo de Pago:</strong> ${data.paymentMethod || "No especificado"}<br>
  `;

// En la funci√≥n showInvoiceDetails
if (data.abonoFact === "yes") {
  abonoSection.style.display = "block";
  pagarAbonoBtn.style.display = "block";
  currentPendingAmount = data.amountReceived ? 
                       (data.total - data.amountReceived) : 
                       data.total;
  montoPendienteAbono.textContent = `Monto pendiente: RD$${currentPendingAmount.toFixed(2)}`;

        // Resetear la selecci√≥n de m√©todo de pago del abono
        paymentOptionsAbono.forEach(opt => opt.classList.remove("selected"));
        selectedPaymentMethodAbono = null;
        amountReceivedAbono.value = "";
        changeAmountAbono.innerHTML = "";
        pagarAbonoBtn.disabled = true;
        efectivoInputAbono.style.display = "none";
      } else {
        abonoSection.style.display = "none";
        pagarAbonoBtn.style.display = "none"; // Ocultar bot√≥n si no es abono

      }

      // Resto del c√≥digo (manejo de estados y botones)...
      if (data.paymentMethod === "Efectivo" && data.amountReceived) {
        if (!isAbono) {
          amountReceivedDisplay.textContent = `RD$${data.amountReceived.toFixed(2)}`;
          const change = data.amountReceived - data.total;
          changeDisplay.textContent = `RD$${change.toFixed(2)}`;
          paymentDetails.style.display = "block";
        } else {
          paymentDetails.style.display = "none";
        }
      } else {
        paymentDetails.style.display = "none";
      }

      totalToPay.textContent = `RD$${data.total.toFixed(2)}`;

      // Resto de la l√≥gica de estados (pago pendiente, pagado, listo, entregado)...
      if (data.status === "pago pendiente") {
        document.querySelector(".modal_preview_factura_down").style.display = "block";
        markAsPaidButton.style.display = "block";
        markAsReadyButton.style.display = "none";
        markAsDeliveredButton.style.display = "none";
        resetPaymentModal();
        document.getElementById("paymentMethodContainer").style.display = isAbono ? "none" : "block";
      } else if (data.status === "pagado") {
        document.querySelector(".modal_preview_factura_down").style.display = "block";
        markAsPaidButton.style.display = "none";
        markAsReadyButton.style.display = "block";
        markAsDeliveredButton.style.display = "none";
        document.getElementById("paymentMethodContainer").style.display = "none";
      } else if (data.status === "pagado listo") {
        document.querySelector(".modal_preview_factura_down").style.display = "block";
        markAsPaidButton.style.display = "none";
        markAsReadyButton.style.display = "none";
        markAsDeliveredButton.style.display = "block";

        // Disable the button if it's an abono invoice
        if (data.abonoFact === "yes") {
          markAsDeliveredButton.disabled = true;
          markAsDeliveredButton.title = "No se puede entregar sin pagar el abono restante";
          markAsDeliveredButton.style.opacity = "0.5";
          markAsDeliveredButton.style.cursor = "not-allowed";
        } else {
          markAsDeliveredButton.disabled = false;
          markAsDeliveredButton.title = "";
          markAsDeliveredButton.style.opacity = "1";
          markAsDeliveredButton.style.cursor = "pointer";
        }

        document.getElementById("paymentMethodContainer").style.display = "none";
      } else {
        document.querySelector(".modal_preview_factura_down").style.display = "none";
      }

      invoiceModal.style.display = "block";
    };

    const resetPaymentModal = () => {
      paymentButtons.forEach(button => {
        button.classList.remove("active");
      });

      amountReceivedInput.value = "";
      changeAmount.textContent = "RD$0.00";
      cashPaymentOptions.classList.add("hidden");
      markAsPaidButton.classList.add("disabled");
    };

    paymentButtons.forEach(button => {
      button.addEventListener("click", (event) => {
        paymentButtons.forEach(btn => {
          btn.classList.remove("active");
        });

        event.target.classList.add("active");

        if (event.target.value === "Efectivo") {
          cashPaymentOptions.classList.remove("hidden");
        } else {
          cashPaymentOptions.classList.add("hidden");
        }

        markAsPaidButton.classList.remove("disabled");
      });
    });

    amountReceivedInput.addEventListener("input", () => {
      const total = parseFloat(currentInvoiceData.total);
      const amountReceived = parseFloat(amountReceivedInput.value) || 0;
      const change = amountReceived - total;

      changeAmount.textContent = `RD$${change.toFixed(2)}`;

      if (document.querySelector(".payment-button.active").value === "Efectivo") {
        if (amountReceived >= total) {
          markAsPaidButton.classList.remove("disabled");
        } else {
          markAsPaidButton.classList.add("disabled");
        }
      }
    });

    closeModal.onclick = () => {
      // Resetear el select de empleados al cerrar el modal
      document.getElementById("employeeSelect").value = "";
      invoiceModal.style.display = "none";
    };

    markAsPaidButton.onclick = async () => {
      if (currentInvoiceId) {
        const selectedEmployee = document.getElementById("employeeSelect").value;

        if (!selectedEmployee) {
          alert("Por favor seleccione un empleado.");
          return;
        }

        try {
          const selectedPaymentMethod = document.querySelector(".payment-button.active")?.value;

          if (!selectedPaymentMethod) {
            alert("Por favor seleccione un m√©todo de pago");
            return;
          }

          let amountReceived = 0;
          let change = 0;

          if (selectedPaymentMethod === "Efectivo") {
            amountReceived = parseFloat(amountReceivedInput.value) || 0;
            const total = parseFloat(currentInvoiceData.total);

            if (amountReceived < total) {
              alert("El monto recibido debe ser mayor o igual al total a pagar");
              return;
            }

            change = amountReceived - total;
          }

          const querySnapshot = await db.collection("facturas").where("id", "==", currentInvoiceId).get();
          if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];

            await doc.ref.update({
              status: "pagado",
              paymentMethod: selectedPaymentMethod,
              amountReceived: amountReceived,
              changeAmount: change
            });

            await db.collection("historialFacturasGeneradas").add({
              empleado: selectedEmployee,
              id: currentInvoiceId,
              nombreCliente: currentInvoiceData.clientName,
              numeroTelefono: currentInvoiceData.clientPhone,
              monto: currentInvoiceData.total,
              fecha: new Date(),
              cambioStatus: "Pago Pendiente a Pagado"
            });

            loadInvoices("pago pendiente");
            invoiceModal.style.display = "none";
            alert("Factura marcada como pagada exitosamente");
          } else {
            console.error("No existe el documento con el campo 'id':", currentInvoiceId);
            alert("No se pudo encontrar la factura para actualizar.");
          }
        } catch (error) {
          console.error("Error al actualizar el estado:", error);
          alert("No se pudo marcar la factura como pagada. Intenta nuevamente.");
        }
      }
    };

    markAsReadyButton.onclick = async () => {
      if (currentInvoiceId) {
        const selectedEmployee = document.getElementById("employeeSelect").value;

        if (!selectedEmployee) {
          alert("Por favor seleccione un empleado.");
          return;
        }

        try {
          const querySnapshot = await db.collection("facturas").where("id", "==", currentInvoiceId).get();
          if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];

            await doc.ref.update({
              status: "pagado listo"
            });

            await db.collection("historialFacturasGeneradas").add({
              empleado: selectedEmployee,
              id: currentInvoiceId,
              nombreCliente: currentInvoiceData.clientName,
              numeroTelefono: currentInvoiceData.clientPhone,
              monto: currentInvoiceData.total,
              fecha: new Date(),
              cambioStatus: "Pagado a Pagado Listo"
            });

            loadInvoices("pagado");
            invoiceModal.style.display = "none";
            alert("Factura marcada como lista exitosamente");
          } else {
            console.error("No existe el documento con el campo 'id':", currentInvoiceId);
            alert("No se pudo encontrar la factura para actualizar.");
          }
        } catch (error) {
          console.error("Error al actualizar el estado:", error);
          alert("No se pudo marcar la factura como lista. Intenta nuevamente.");
        }
      }
    };

    markAsDeliveredButton.onclick = async () => {
      if (currentInvoiceId) {
        // Check if it's an abono invoice in "pagado listo" status
        if (currentInvoiceData.abonoFact === "yes" && currentInvoiceData.status === "pagado listo") {
          alert("No se puede entregar una ropa sin antes pagar el ABONO RESTANTE");
          return;
        }

        const selectedEmployee = document.getElementById("employeeSelect").value;

        if (!selectedEmployee) {
          alert("Por favor seleccione un empleado.");
          return;
        }

        try {
          const querySnapshot = await db.collection("facturas").where("id", "==", currentInvoiceId).get();
          if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];

            await doc.ref.update({
              status: "pagado entregado"
            });

            await db.collection("historialFacturasGeneradas").add({
              empleado: selectedEmployee,
              id: currentInvoiceId,
              nombreCliente: currentInvoiceData.clientName,
              numeroTelefono: currentInvoiceData.clientPhone,
              monto: currentInvoiceData.total,
              fecha: new Date(),
              cambioStatus: "Pagado Listo a Pagado Entregado"
            });

            loadInvoices("pagado listo");
            invoiceModal.style.display = "none";
            alert("Factura marcada como entregada exitosamente");
          } else {
            console.error("No existe el documento con el campo 'id':", currentInvoiceId);
            alert("No se pudo encontrar la factura para actualizar.");
          }
        } catch (error) {
          console.error("Error al actualizar el estado:", error);
          alert("No se pudo marcar la factura como entregada. Intenta nuevamente.");
        }
      }
    };

    document.getElementById("pendingInvoicesButton").onclick = () => {
      currentStatus = "pago pendiente"; // Forzar el estado primero
      updateTitleAndBackground(currentStatus); // Actualizar UI inmediatamente
      loadInvoices("pago pendiente");
    };

    // Hacer lo mismo para los otros botones
    document.getElementById("paidInvoicesButton").onclick = () => {
      currentStatus = "pagado";
      updateTitleAndBackground(currentStatus);
      loadInvoices("pagado");
    };

    document.getElementById("readyInvoicesButton").onclick = () => {
      currentStatus = "pagado listo";
      updateTitleAndBackground(currentStatus);
      loadInvoices("pagado listo");
    };

    document.getElementById("deliveredInvoicesButton").onclick = () => {
      currentStatus = "pagado entregado";
      updateTitleAndBackground(currentStatus);
      loadInvoices("pagado entregado");
    };

    // Cargar facturas pendientes al inicio
    loadInvoices("pago pendiente");

    // Variables para la paginaci√≥n del historial
    let lastHistoryDoc = null;
    let historyData = [];
    const historyList = document.getElementById("historyList");
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const noMoreRecords = document.getElementById("noMoreRecords");

    const loadHistory = async (loadMore = false) => {
      try {
        if (!loadMore) {
          historyList.innerHTML = "";
          lastHistoryDoc = null;
          historyData = [];
          loadMoreBtn.style.display = "block";
          noMoreRecords.style.display = "none";
        }

        let query = db.collection("historialFacturasGeneradas")
          .orderBy("fecha", "desc")
          .limit(10);

        if (lastHistoryDoc) {
          query = query.startAfter(lastHistoryDoc);
        }

        const snapshot = await query.get();

        if (snapshot.empty) {
          if (loadMore) {
            loadMoreBtn.style.display = "none";
            noMoreRecords.style.display = "block";
          } else {
            historyList.innerHTML = "<li>No hay registros de historial</li>";
            loadMoreBtn.style.display = "none";
          }
          return;
        }

        lastHistoryDoc = snapshot.docs[snapshot.docs.length - 1];

        snapshot.forEach(doc => {
          const data = doc.data();
          historyData.push({ id: doc.id, ...data });
        });

        renderHistoryItems();

      } catch (error) {
        console.error("Error al cargar el historial:", error);
        alert("Error al cargar el historial. Intente nuevamente.");
      }
    };

    const renderHistoryItems = () => {
  if (historyData.length <= 10) {
    historyList.innerHTML = "";
  }

  historyData.forEach(data => {
    const listItem = document.createElement("li");
    const formattedAmount = `RD$${formatNumberWithCommas(data.monto.toFixed(2))}`;

    // Verificar si es un pago de abono
    const isAbonoPayment = data.cambioStatus === "Abono Pagado";

    const formattedDate = data.fecha.toDate().toLocaleString('es-ES', {
      timeZone: 'America/Santo_Domingo',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: 'numeric',
      minute: 'numeric',
      hour12: true
    });

    listItem.innerHTML = `
      <strong>Empleado que realiz√≥ el cambio:</strong> ${data.empleado}<br>
      <strong>ID de Factura:</strong> ${data.id}<br>
      <strong>Cliente:</strong> ${data.nombreCliente}<br>
      <strong>Tel√©fono:</strong> ${data.numeroTelefono}<br>
      <strong>Total:</strong> ${formattedAmount}<br>
      <strong>Fecha y hora del cambio:</strong> ${formattedDate}<br>
      <strong>Cambio de Estado:</strong>
    `;

    if (isAbonoPayment) {
      // Calcular el monto del abono (lo que realmente se pag√≥ en este pago)
      const montoAbonoPagado = data.amountReceivedAbonoFire || 
                              (data.amountReceived - (data.monto - data.amountReceived));
      
      const metodoPago = data.paymentMethod || "M√©todo no especificado";
      const montoAbono = montoAbonoPagado ? 
                        `RD$${montoAbonoPagado.toFixed(2)}` : 
                        "Monto no especificado";
      
      const abonoStatusSpan = document.createElement("span");
      abonoStatusSpan.textContent = `Abono Pagado, ${metodoPago}, ${montoAbono}`;
      abonoStatusSpan.className = "status-pagado";
      listItem.appendChild(abonoStatusSpan);
    } else {
      // Mantener el formato original para otros tipos de cambios
      let previousStatusSpan = document.createElement("span");
      let newStatusSpan = document.createElement("span");
      let previousStatusText = "";
      let newStatusText = "";
      let previousStatusClass = "";
      let newStatusClass = "";

      switch (data.cambioStatus) {
        case "Pago Pendiente a Pagado":
          previousStatusText = "Pago Pendiente";
          previousStatusClass = "status-pago-pendiente";
          newStatusText = "Pagado";
          newStatusClass = "status-pagado";
          break;
        case "Pagado a Pagado Listo":
          previousStatusText = "Pagado";
          previousStatusClass = "status-pagado";
          newStatusText = "Pagado Listo";
          newStatusClass = "status-pagado-listo";
          break;
        case "Pagado Listo a Pagado Entregado":
          previousStatusText = "Pagado Listo";
          previousStatusClass = "status-pagado-listo";
          newStatusText = "Pagado Entregado";
          newStatusClass = "status-pagado-entregado";
          break;
        default:
          previousStatusText = data.cambioStatus || "Estado Desconocido";
          previousStatusClass = "";
          newStatusText = "";
          newStatusClass = "";
          break;
      }

      if (newStatusText) {
        previousStatusSpan.textContent = previousStatusText;
        previousStatusSpan.className = previousStatusClass;
        newStatusSpan.textContent = newStatusText;
        newStatusSpan.className = newStatusClass;

        listItem.appendChild(previousStatusSpan);
        listItem.appendChild(document.createTextNode(" a "));
        listItem.appendChild(newStatusSpan);
      } else {
        listItem.appendChild(document.createTextNode(previousStatusText));
      }
    }

    historyList.appendChild(listItem);
  });
};




    // Event listeners para los m√©todos de pago del abono
    paymentOptionsAbono.forEach(option => {
      option.addEventListener("click", () => {
        paymentOptionsAbono.forEach(opt => opt.classList.remove("selected"));
        option.classList.add("selected");
        selectedPaymentMethodAbono = option.getAttribute("data-method");

        if (selectedPaymentMethodAbono === "efectivo") {
          efectivoInputAbono.style.display = "inline-flex";
          validateAbonoPayment();
        } else {
          efectivoInputAbono.style.display = "none";
          pagarAbonoBtn.disabled = false;
        }
      });
    });

    // Validar el monto ingresado para el abono en efectivo
    amountReceivedAbono.addEventListener("input", validateAbonoPayment);



    // Validar el monto ingresado para el abono en efectivo
    amountReceivedAbono.addEventListener("input", () => {
      validateAbonoPayment();
    });

    function validateAbonoPayment() {
  if (selectedPaymentMethodAbono === "efectivo") {
    const amountReceived = parseFloat(amountReceivedAbono.value) || 0;
    const change = amountReceived - currentPendingAmount;

    if (amountReceived > 0) {
      changeAmountAbono.innerHTML = `<strong>Cambio:</strong> RD$${change.toFixed(2)}`;
      pagarAbonoBtn.disabled = amountReceived < currentPendingAmount;
    } else {
      changeAmountAbono.innerHTML = "";
      pagarAbonoBtn.disabled = true;
    }
  } else {
    pagarAbonoBtn.disabled = false;
  }
}


 // Agregar evento de clic al bot√≥n de "PAGAR ABONO"
 pagarAbonoBtn.addEventListener("click", async () => {
  if (currentInvoiceId) {
    const selectedEmployee = document.getElementById("employeeSelect").value;

    if (!selectedEmployee) {
      alert("Por favor seleccione un empleado.");
      return;
    }

    try {
      const selectedPaymentMethod = selectedPaymentMethodAbono;

      if (!selectedPaymentMethod) {
        alert("Por favor seleccione un m√©todo de pago");
        return;
      }

      let amountReceived = 0;
      let changeAmount = 0;

      if (selectedPaymentMethod === "efectivo") {
        amountReceived = parseFloat(amountReceivedAbono.value) || 0;
        const total = parseFloat(currentPendingAmount);
        changeAmount = amountReceived - total;

        if (amountReceived < total) {
          alert("El monto recibido debe ser mayor o igual al monto pendiente");
          return;
        }
      }

      const querySnapshot = await db.collection("facturas").where("id", "==", currentInvoiceId).get();
      if (!querySnapshot.empty) {
        const doc = querySnapshot.docs[0];
        const invoiceData = doc.data();
        
        // Verificar si el m√©todo de pago original es Transferencia o Tarjeta de Cr√©dito
        const originalPaymentMethod = invoiceData.paymentMethod;
        const isOriginalMethodCardOrTransfer = originalPaymentMethod === "Transferencia" || 
                                             originalPaymentMethod === "Tarjeta de Cr√©dito";
        
        // Verificar si el m√©todo de pago del abono es Efectivo
        const isAbonoCash = selectedPaymentMethod === "efectivo";
        
        // Verificar si es un d√≠a diferente
        const originalTimestamp = invoiceData.timestamp.toDate();
        const currentTimestamp = new Date();
        const isDifferentDay = originalTimestamp.toDateString() !== currentTimestamp.toDateString();

        // Preparar los datos a actualizar
        const updateData = {
          abonoFact: "no", // Cambiamos el abonoFact a "no" porque ya se pag√≥ completo
          amountReceivedAbonoFire: amountReceived,
          changeAmountAbonoFire: changeAmount,
          amountReceived: firebase.firestore.FieldValue.increment(amountReceived),
          changeAmount: firebase.firestore.FieldValue.increment(changeAmount),
        };

        // Solo actualizar paymentMethod si el m√©todo de pago es efectivo
        // o si no hay un paymentMethod definido previamente
        if (selectedPaymentMethod === "efectivo" || !invoiceData.paymentMethod) {
          updateData.paymentMethod = getFullPaymentMethodName(selectedPaymentMethod);
        }

        // Condici√≥n 1: Si m√©todo original fue Transferencia/Tarjeta y el abono es en Efectivo
        // O Condici√≥n 2: Si es un d√≠a diferente
        if ((isOriginalMethodCardOrTransfer && isAbonoCash) || isDifferentDay) {
          updateData.abonoFact2do = "yes";
          
          // Si es un d√≠a diferente, tambi√©n actualizamos el timestamp
          if (isDifferentDay) {
            updateData.timestamp = firebase.firestore.FieldValue.serverTimestamp();
          }
        }

        await doc.ref.update(updateData);

        // Crear el mensaje espec√≠fico para el historial de abonos
        const metodoPago = getFullPaymentMethodName(selectedPaymentMethod);
        const mensajeAbono = `Pago de abono, ${metodoPago}, RD$${currentPendingAmount.toFixed(2)}`;

// Dentro del evento click del bot√≥n "PAGAR ABONO"
const montoAbonoPagado = currentPendingAmount; // Este es el monto que estaba pendiente

await db.collection("historialFacturasGeneradas").add({
  empleado: selectedEmployee,
  id: currentInvoiceId,
  nombreCliente: currentInvoiceData.clientName,
  numeroTelefono: currentInvoiceData.clientPhone,
  monto: currentInvoiceData.total,
  fecha: new Date(),
  cambioStatus: "Abono Pagado",
  paymentMethod: getFullPaymentMethodName(selectedPaymentMethod),
  amountReceivedAbonoFire: montoAbonoPagado // Guardamos el monto pendiente que se pag√≥
});

// Actualizar la factura principal
await doc.ref.update({
  abonoFact: "no",
  amountReceivedAbonoFire: montoAbonoPagado,
  amountReceived: firebase.firestore.FieldValue.increment(montoAbonoPagado),
  changeAmount: firebase.firestore.FieldValue.increment(changeAmount),
  paymentMethod: selectedPaymentMethod === "efectivo" ? 
                getFullPaymentMethodName(selectedPaymentMethod) : 
                invoiceData.paymentMethod
});

        // Obtener los datos actualizados de la factura
        const updatedDoc = await doc.ref.get();
        currentInvoiceData = updatedDoc.data();

        // Actualizar la vista del modal con los nuevos datos
        showInvoiceDetails(currentInvoiceData);

        // Mostrar mensaje de √©xito sin cerrar el modal
        alert("Abono pagado completamente. La factura ha sido actualizada.");

        // Actualizar la tabla de facturas sin recargar la p√°gina
        loadInvoices(currentStatus);

      } else {
        console.error("No existe el documento con el campo 'id':", currentInvoiceId);
        alert("No se pudo encontrar la factura para actualizar.");
      }
    } catch (error) {
      console.error("Error al actualizar el estado:", error);
      alert("No se pudo marcar el abono como pagado. Intenta nuevamente.");
    }
  }
});

    // Funci√≥n auxiliar para obtener el nombre completo del m√©todo de pago
    function getFullPaymentMethodName(method) {
      switch (method) {
        case "efectivo": return "Efectivo";
        case "transferencia": return "Transferencia";
        case "tarjeta": return "Tarjeta de Cr√©dito";
        default: return method;
      }
    }

    loadMoreBtn.addEventListener("click", () => {
      loadHistory(true);
    });

    historyButton.onclick = () => {
      loadHistory();
      historyModal.style.display = "block";
    };

    closeHistoryModal.onclick = () => {
      historyModal.style.display = "none";
    };

    // Configuraci√≥n de Firebase y otras funciones permanecen iguales hasta la funci√≥n de b√∫squeda

    // Funci√≥n para resaltar el texto coincidente en los resultados
    function highlightText(text, searchTerm) {
      if (!searchTerm) return text;

      const regex = new RegExp(`(${searchTerm})`, 'gi');
      return text.replace(regex, '<span class="highlight">$1</span>');
    }

    // Funci√≥n para buscar facturas modificada
    searchInput.addEventListener("input", () => {
      const searchTerm = searchInput.value.toLowerCase().trim();
      invoicesBody.innerHTML = "";

      if (searchTerm === "") {
        // Si la b√∫squeda est√° vac√≠a, mostrar todas las facturas nuevamente
        renderInvoices();
        // Mostrar el bot√≥n de cargar m√°s si corresponde
        if (currentStatus === "pagado entregado" && invoices.length >= 15) {
          loadMoreContainer.style.display = "block";
        }
        return;
      }





      const filteredInvoices = invoices.filter(invoice =>
        invoice.id.toLowerCase().includes(searchTerm) ||
        invoice.clientName.toLowerCase().includes(searchTerm) ||
        invoice.clientPhone.toLowerCase().includes(searchTerm) ||
        `RD$${invoice.total.toFixed(2)}`.includes(searchTerm)
      );

      if (filteredInvoices.length === 0) {
        document.getElementById("noInvoicesMessage").classList.remove("hidden");
        loadMoreContainer.style.display = "none";
      } else {
        document.getElementById("noInvoicesMessage").classList.add("hidden");
        filteredInvoices.forEach((invoice) => {
          const row = document.createElement("tr");
          const formattedDate = invoice.timestamp.toDate().toLocaleString('es-ES', {
            timeZone: 'America/Santo_Domingo',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });

          const formattedTotal = `RD$${formatNumberWithCommas(invoice.total.toFixed(2))}`;

          // Aplicar resaltado a los campos que coincidan
          const highlightedId = highlightText(invoice.id, searchTerm);
          const highlightedName = highlightText(invoice.clientName, searchTerm);
          const highlightedPhone = highlightText(invoice.clientPhone, searchTerm);
          const highlightedTotal = highlightText(formattedTotal, searchTerm);
          const highlightedDate = highlightText(formattedDate, searchTerm);

          row.innerHTML = `
                    <td>${highlightedId}</td>
                    <td>${highlightedName}</td>
                    <td>${highlightedPhone}</td>
                    <td>${highlightedTotal}</td>
                    <td>${highlightedDate}</td>
                `;
          row.addEventListener("click", () => {
            currentInvoiceId = invoice.id;
            currentInvoiceData = invoice;
            showInvoiceDetails(invoice);
          });
          invoicesBody.appendChild(row);
        });

        // Ocultar el bot√≥n de cargar m√°s durante la b√∫squeda
        loadMoreContainer.style.display = "none";
      }
    });

    // Limpiar listener al salir
    window.addEventListener("beforeunload", () => {
      if (unsubscribe) {
        unsubscribe();
      }
    });
  </script>

</body>

</html>

<!-- 70 -->