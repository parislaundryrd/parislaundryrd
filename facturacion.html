<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Facturaci√≥n - Laundry</title>
  <link rel="icon" href="./img/Paris Laundry 1.png" type="image/png">
  <link rel="stylesheet" href="./css/styles_facturacion.css">
  <link rel="stylesheet" href="./css/styles_menu.css">
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
  <script src="./js/app.js"></script>
  <script src="./js/menu.js" defer></script>
</head>


<body>


  <div class="MasterBox0" style="display: none;">

    <laundry-menu></laundry-menu>

    <div class="MasterBox">


      <!-- Panel Preview de Factura -->
      <div class="container_previewfactura">
        <div id="invoiceResult">
          <div class="previewfactura_tittle">
            <h2>Factura Generada</h2>
          </div>

          <div class="previewfactura_body">
            <p id="invoiceDetails">
              <strong>Cliente:</strong> <br>
              <strong>Tel√©fono:</strong> <br>
              <strong>Direcci√≥n:</strong> <br>

              <strong><br>Delivery:</strong>
              <br><span style="display: flex; justify-content: space-between;"><span>Sin
                  delivery:</span><span>RD$0</span></span><br>

              <span
                style="display: flex; justify-content: space-between;"><strong>Total:</strong><strong>RD$0.00</strong></span>
            </p>
          </div>

          <div class="previewfactura_down">

            <div class="previewfactura_down_space">
              <div class="seleccionempeados">
                <label for="categoria">Empleado que Atiende:</label>
                <select id="empleado" required>
                  <option value="" disabled selected>Selecciona</option>
                </select>
              </div>

              <button id="processInvoice">Procesar Factura</button>
              <ul id="invoiceList" class="invoice-list hidden"></ul>
            </div>

            <div class="panelfacturacion_down_RWD">
              <footer-content></footer-content>
            </div>

          </div>
        </div>

        <!-- Panel Preview de Factura FIN -->

        <!-- Panel Logo -->
        <!-- <div class="cube-logo">
          <div class="Logo-Paris-Laundry"></div>
        </div> -->

      </div>

      <!-- Panel Logo FIN -->

      <!-- Panel Facturacion -->
      <div class="container_formfactura">
        <div class="panelfacturacion_tittle">
          <h2>Panel de Facturaci√≥n</h2>
          <a href="javascript:void(0)" onclick="confirmarLimpiarFactura()" id="limpiarFactura1"><img
              src="./img/icon/refrescar1.png">Limpiar Factura</a>
          <a href="javascript:void(0)" onclick="window.open(window.location.href, '_blank');" id="a√±adirFactura1"><img
              src="./img/icon/mas2.png">A√±adir Factura</a>

          <a href="javascript:void(0)" onclick="confirmarLimpiarFactura()" id="limpiarFactura2"><img
              src="./img/icon/refrescar1.png">Factura</a>
          <a href="javascript:void(0)" onclick="window.open(window.location.href, '_blank');" id="a√±adirFactura2"><img
              src="./img/icon/mas2.png">Factura</a>
        </div>

        <div class="panelfacturacion_body">
          <form id="billingForm">

            <div class="nombre_div_telefono">
              <div>
                <label for="nombreCliente">Nombre del Cliente:</label>
                <div class="input-numeroContacto">
                  <input type="text" id="clientName" placeholder="Nombre y Apellido" required maxlength="40">
                  <div class="cantidad-img"><img src="./img/icon/nombre_1.png"></div>
                </div>
              </div>
              <div>
                <label for="numeroCliente">Tel√©fono del Cliente:</label>
                <div class="input-numeroContacto">
                  <input type="tel" id="clientPhone" placeholder="Tel√©fono" required maxlength="12"
                    oninput="formatPhoneNumber(this)">

                  <div class="cantidad-img"><img src="./img/icon/phone_1.png"></div>
                </div>
              </div>
            </div>
            <div>
              <label for="direccionCliente">Direcci√≥n del Cliente:</label>
              <div class="input-numeroContacto">
                <input type="text" id="clientAddress" placeholder="Direcci√≥n" required maxlength="100">
                <div class="cantidad-img"><img src="./img/icon/direccion_1.png"></div>
              </div>
            </div>

            <div class="hamper-master">
              <h2>A√±adir Hamper:</h2>
              <div id="serviceSelection" class="button-list"></div>
              <div id="hamperContainer"></div>
            </div>

            <div class="hamper-master">
              <h2>A√±adir Otros Servicios:</h2>
              <div id="otrosServiciosContainer" class="button-list"></div>
              <div id="otrosServiciosDisplay"></div>
            </div>

            <h2>A√±adir Productos Adicionales:</h2>
            <div class="product-list">
              <div class="product-header">
                <div>Producto</div>
                <div id="detalles-hidden">Detalles</div>
                <div>Precio (RD$)</div>
              </div>
              <div id="productSelection"></div>
            </div>

            <h2>Opciones de Delivery:</h2>
            <div id="deliverySelection" class="button-list"></div>
          </form>
        </div>

        <div class="panelfacturacion_down">
          <footer-content></footer-content>
        </div>
      </div>

      <!-- Panel Facturacion FIN -->
    </div>

    <!-- Modal Preview Factura -->
    <div id="confirmationModal" class="modal hidden">
      <div class="modal-content">

        <!-- Modal_preview_factura_tittle -->
        <div class="modal_preview_factura_tittle">
          <span class="close-button">&times;</span>
          <h2 style="text-align: center;">Confirmaci√≥n de Factura</h2>
        </div>
        <!-- Modal_preview_factura_tittle FIN -->

        <!-- Modal_preview_factura_body -->
        <div class="modal_preview_factura_body">
          <div id="modalInvoiceDetails"></div>
        </div>
        <!-- Modal_preview_factura_body FIN -->

        <!-- Modal_preview_factura_Down -->
        <div class="modal_preview_factura_down">
          <h2 style="text-align: center;margin-block-start: 5px;margin-block-end: 5px;">M√©todo de Pago:</h2>

          <div class="button-metodo-pago">
            <button id="cashPayment" class="payment-button" value="Efectivo">Efectivo <span>üíµ</span></button>
            <button id="transferPayment" class="payment-button" value="Transferencia">Transferencia
              <span>üì≤</span></button>
            <button id="cardPayment" class="payment-button" value="Tarjeta de Cr√©dito">Tarjeta de <span>Cr√©dito
                üí≥</span></button>
          </div>


          <div class="cashPaymentOptions_master">

            <div class="cube-montos">
              <div class="cube-form-flex">
                <div>
                  <label>Total a Pagar:</label>
                </div>
                <div>
                  <span id="totalToPay" style="color: #189dff;font-weight: bold;">RD$0.00</span>
                </div>
              </div>

              <div id="cashPaymentOptions" class="hidden">

                <div class="cube-form-flex">
                  <div>
                    <label>Monto Recibido:</label>
                  </div>
                  <div>
                    <div class="input-container">
                      <span class="prefix">RD$</span>
                      <input type="text" id="amountReceived" placeholder="0" maxlength="6"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);">
                    </div>
                  </div>
                </div>

                <div class="cube-form-flex">
                  <div>
                    <label>Cambio:</label>
                  </div>
                  <div>
                    <span id="changeAmount" style="font-weight: bold;color: #f96dd3;">RD$0.00</span>
                  </div>
                </div>
              </div>
            </div>


            <!-- A√±ade JUSTO DESPU√âS: -->
            <div id="abonobox_master">
              <div style="display: inline-flex;height: 35px;">
                <label style="cursor: pointer;display: inline-flex;align-items: center;gap: 5px;">
                  <input type="checkbox" id="pagarConAbonoCheckbox" style="height: 20px;width: 20px;cursor: pointer;">
                  Pagar con Abono:
                </label>
              </div>

              <div id="transferCardPaymentOptions">

                <div class="cube-form-flex" style="font-size: 25px;">
                  <div>
                    <label></label>
                  </div>
                  <div>
                    <div class="input-container">
                      <span class="prefix">RD$</span>
                      <input type="text" id="partialAmount" placeholder="0" maxlength="6"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);">
                    </div>
                  </div>
                </div>

              </div>


            </div>







            <div class="Cube_button_pagado">
              <!-- <button id="printInvoice">Imprimir Factura</button> -->
              <button id="pendingPayment"><img src="./img/icon/atencion1.png">Pago Pendiente</button>
              <button id="partialPayment"><img src="./img/icon/abono1.png">Abono</button>
              <button id="paid" class="disabled"><img src="./img/icon/check1.png">Pago Recibido</button>
            </div>

          </div>
          <!-- Modal_preview_factura_Down FIN -->

        </div>
      </div>
    </div>
    <!-- Modal Preview Factura FIN -->



    <!-- Modal para Factura Procesada -->
    <div id="processedInvoiceModal" class="modal hidden">

      <div class="modal-content">

        <!-- Modal_factura_processed_tittle -->
        <div class="factura_processed_tittle">
          <span class="close-button" onclick="closeProcessedInvoiceModal()">&times;</span>
          <h2>Factura Exitosa</h2>
        </div>
        <!-- Modal_factura_processed_tittle FIN -->

        <!-- Modal_factura_processed_body -->
        <div id="processedInvoiceDetails"></div>
        <!-- Modal_factura_processed_body FIN -->

        <!-- Modal_factura_processed_down -->
        <div class="factura_processed_down">
          <div class="container_factura_processed_down">
            <div class="container_flex_factura_processed_down">
              <p>¬°Factura procesada y guardada con √©xito!</p>

              <div style="display: inline-flex;width: 100%;flex-direction: row;justify-content: space-between;">
                <button id="printInvoiceButton"><img src="./img/icon/imprimir1.png">Imprimir</button>
                <span id="invoiceIdDisplay"></span>
                <button id="readyButton" onclick="closeProcessedInvoiceModal()"><img
                    src="./img/icon/check2.png">Listo</button>
              </div>

            </div>
          </div>
        </div>
        <!-- Modal_factura_processed_down FIN -->

      </div>
    </div>
    <!-- Modal para Factura Procesada FIN -->


  </div>
  </div>


  <script>


    const serviceSelection = document.getElementById("serviceSelection");
    const deliverySelection = document.getElementById("deliverySelection");
    const productSelection = document.getElementById("productSelection");
    const hamperContainer = document.getElementById("hamperContainer");
    const otrosServiciosContainer = document.getElementById("otrosServiciosContainer");
    const otrosServiciosDisplay = document.getElementById("otrosServiciosDisplay");

    let hampers = [];
    let otrosServicios = [];


    function confirmarLimpiarFactura() {
      if (confirm("¬øSeguro que deseas limpiar esta factura?")) {
        location.reload(); // Refresca la p√°gina
      }
    }

    // Cargar servicios, productos y empleados
    const loadServices = () => {
      db.collection("servicio").onSnapshot((snapshot) => {
        serviceSelection.innerHTML = "";
        otrosServiciosContainer.innerHTML = "";
        hamperContainer.innerHTML = "";
        otrosServiciosDisplay.innerHTML = "";

        const hampersArray = [];
        const otrosServiciosArray = [];

        snapshot.forEach((doc) => {
          const data = doc.data();

          if (data.tipo === "hamper") {
            hampersArray.push({ id: doc.id, ...data });
          }

          if (data.tipo === "otroservicio") {
            otrosServiciosArray.push({ id: doc.id, ...data });
          }
        });

        // Ordenar hampers por OrdenNumHamper
        hampersArray.sort((a, b) => a.OrdenNumHamper - b.OrdenNumHamper);

        // Ordenar otros servicios por OrdenNumServicio
        otrosServiciosArray.sort((a, b) => a.OrdenNumServicio - b.OrdenNumServicio);

        // Mostrar hampers ordenados
        hampersArray.forEach((data) => {
          const button = document.createElement("button");
          button.type = "button";
          button.innerHTML = `
        <div><img src="${data.icon}" alt="${data.nombre}"></div>
        <div>${data.nombre}<br> <strong>RD$${data.precio}</strong></div>
      `;
          button.dataset.value = data.precio;
          button.dataset.name = data.nombre;
          button.dataset.librasmin = data.librasmin;
          button.dataset.librasmax = data.librasmax;
          button.dataset.preciolibras = data.preciolibras;
          button.addEventListener("click", () => {
            addHamper(data);
          });
          serviceSelection.appendChild(button);
        });

        // Mostrar otros servicios ordenados
        otrosServiciosArray.forEach((data) => {
          const button = document.createElement("button");
          button.type = "button";
          button.innerHTML = `
        <div><img src="${data.icon}" alt="${data.nombre}"></div>
        <div>${data.nombre}<br> <strong>RD$${data.precio}</strong></div>
      `;
          button.dataset.value = data.precio;
          button.dataset.name = data.nombre;
          button.dataset.icon = data.icon;
          button.addEventListener("click", () => {
            addOtherService(data, button);
          });
          otrosServiciosContainer.appendChild(button);
        });
      });
    };

    const addOtherService = (data, button) => {
      const existingService = otrosServiciosDisplay.querySelector(`div[data-name="${data.nombre}"]`);

      if (existingService) {
        otrosServiciosDisplay.removeChild(existingService);
        button.classList.remove("active");
        otrosServicios = otrosServicios.filter(service => service.name !== data.nombre);
      } else {
        const serviceDiv = document.createElement("div");
        serviceDiv.classList.add("otro-servicio");
        serviceDiv.dataset.name = data.nombre;
        serviceDiv.innerHTML = `
  <h3>${data.nombre} RD$${data.precio}</h3>
  <img src="./img/icon/${data.icon}" alt="${data.nombre}">
  <h5>Cantidad</h5>
  <div id="itemWeight">
      <button id="btnmenosmas" type="button" class="decreaseItem">-</button>
      <input type="number" class="itemInput" value="1" min="1" max="100" placeholder="0">
      <button id="btnmenosmas" type="button" class="increaseItem">+</button>
  </div>
  <p class="itemTotalDisplay">Total: RD$${data.precio}</p>
  <button type="button" class="removeOtherService">X</button>
`;

        otrosServiciosDisplay.appendChild(serviceDiv);
        button.classList.add("active");

        otrosServicios.push({
          name: data.nombre,
          price: parseFloat(data.precio),
          input: serviceDiv.querySelector(".itemInput"),
          consumo: data.consumo || [] // Almacenar el array "consumo"
        });

        // Aumentar la cantidad
        serviceDiv.querySelector(".increaseItem").addEventListener("click", () => {
          const inputField = serviceDiv.querySelector(".itemInput");
          inputField.value = Math.min(100, parseInt(inputField.value) + 1);
          updateItemPrice(serviceDiv, data.precio);
        });

        // Disminuir la cantidad
        serviceDiv.querySelector(".decreaseItem").addEventListener("click", () => {
          const inputField = serviceDiv.querySelector(".itemInput");
          inputField.value = Math.max(1, parseInt(inputField.value) - 1);
          updateItemPrice(serviceDiv, data.precio);
        });

        // Evento para el campo de entrada
        serviceDiv.querySelector(".itemInput").addEventListener("input", () => {
          const inputField = serviceDiv.querySelector(".itemInput");
          // No establecer un valor por defecto si el campo est√° vac√≠o
          if (inputField.value === "") {
            // No hacer nada, dejar el campo vac√≠o
          } else {
            // Asegurarse de que el valor sea un n√∫mero v√°lido
            const value = parseInt(inputField.value);
            if (isNaN(value) || value < 1) {
              inputField.value = 1; // Establecer a 1 si el valor es inv√°lido
            }
          }
          updateItemPrice(serviceDiv, data.precio);
        });


        const removeButton = serviceDiv.querySelector(".removeOtherService");
        removeButton.addEventListener("click", () => {
          otrosServiciosDisplay.removeChild(serviceDiv);
          button.classList.remove("active");
          otrosServicios = otrosServicios.filter(service => service.name !== data.nombre);
          updateInvoicePreview();
        });
      }

      updateInvoicePreview();
    };

    const updateItemPrice = (itemDiv, price) => {
      const count = parseInt(itemDiv.querySelector(".itemInput").value) || 0;
      const totalItem = count * price;
      itemDiv.querySelector(".itemTotalDisplay").textContent = `Total: RD$${totalItem}`;
      updateInvoicePreview();
    };

    const addHamper = (data) => {
      // Verifica si ya hay 30 hampers
      if (hampers.length >= 30) {
        alert("No puedes agregar m√°s de 30 hampers por factura.");
        return;
      }

      const hamperDiv = document.createElement("div");
      hamperDiv.classList.add("hamper");
      hamperDiv.innerHTML = `
    <h3>${data.nombre}</h3>
    <img src="${data.icon}" alt="${data.nombre}">
    <h5>Cantidad de Libras</h5>
    <div id="hamperWeight">
      <button id="btnmenosmas" type="button" class="decreaseWeight">-</button>
      <input type="number" class="weightInput" value="1" min="1" max="100" placeholder="0">
      <button id="btnmenosmas" type="button" class="increaseWeight">+</button>
    </div>
    <p class="priceDisplay">Precio: RD$0</p>
    <button id="cerrarhamper" type="button" class="removeHamper">X</button>
  `;

      hamperContainer.appendChild(hamperDiv);
      const newHamper = {
        data: data,
        weightInput: hamperDiv.querySelector(".weightInput"),
        priceDisplay: hamperDiv.querySelector(".priceDisplay"),
        consumo: data.consumo || []
      };
      hampers.push(newHamper);

      // Event listeners para los botones de incremento/decremento
      hamperDiv.querySelector(".increaseWeight").addEventListener("click", () => {
        newHamper.weightInput.value = Math.min(100, parseInt(newHamper.weightInput.value) + 1);
        calculatePrice(hamperDiv);
        updateInvoicePreview();
      });

      hamperDiv.querySelector(".decreaseWeight").addEventListener("click", () => {
        newHamper.weightInput.value = Math.max(1, parseInt(newHamper.weightInput.value) - 1);
        calculatePrice(hamperDiv);
        updateInvoicePreview();
      });

      hamperDiv.querySelector(".removeHamper").addEventListener("click", () => {
        hamperContainer.removeChild(hamperDiv);
        hampers = hampers.filter(h => h !== newHamper);
        updateInvoicePreview();
      });

      // Funci√≥n de redondeo
      const handleRounding = () => {
        let value = parseFloat(newHamper.weightInput.value);
        if (!isNaN(value)) {
          if (value >= 1) {
            if (value % 1 >= 0.5) {
              newHamper.weightInput.value = Math.ceil(value);
            } else {
              newHamper.weightInput.value = Math.floor(value);
            }
          } else {
            newHamper.weightInput.value = 1;
          }
        } else {
          newHamper.weightInput.value = 1;
        }
        calculatePrice(hamperDiv);
        updateInvoicePreview();
      };

      // Event listeners para el input
      newHamper.weightInput.addEventListener("blur", handleRounding);
      newHamper.weightInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.keyCode === 13) {
          e.preventDefault(); // Prevenir comportamiento por defecto
          handleRounding();
          newHamper.weightInput.blur();
        }
      });

      calculatePrice(hamperDiv);
      updateInvoicePreview();
    };

    const calculatePrice = (hamperDiv) => {
      const weight = parseInt(hamperDiv.querySelector(".weightInput").value) || 0;
      const data = hampers.find(h => h.weightInput === hamperDiv.querySelector(".weightInput")).data;

      const librasMin = parseInt(data.librasmin) || 0;
      const librasMax = parseInt(data.librasmax) || 0;
      const precioBase = parseFloat(data.precio) || 0;
      const precioPorLibraAdicional = parseFloat(data.preciolibras) || 0;

      let totalPrice = 0;

      if (weight < librasMin) {
        totalPrice = weight * precioPorLibraAdicional;
      } else if (weight >= librasMin && weight <= librasMax) {
        totalPrice = precioBase;
      } else {
        const additionalWeight = weight - librasMax;
        totalPrice = precioBase + (additionalWeight * precioPorLibraAdicional);
      }

      hamperDiv.querySelector(".priceDisplay").textContent = `Precio: RD$${totalPrice.toFixed(2)}`;
    };



    let itbisPercentage; // Sin valor por defecto
    let asumirPor; // Variable para almacenar qui√©n asume el ITBIS

    const loadITBISPercentage = () => {
      console.log("Cargando porcentaje de ITBIS...");
      db.collection("impuestos").limit(1).get()
        .then((snapshot) => {
          if (!snapshot.empty) {
            const doc = snapshot.docs[0];
            itbisPercentage = doc.data().cantidadPorciento / 100; // Aseg√∫rate de que cantidadPorciento est√© en porcentaje
            asumirPor = doc.data().asumirPor; // Cargar el valor de asumirPor
            console.log("Porcentaje de ITBIS cargado:", itbisPercentage);
            console.log("Asumir por:", asumirPor);
            updateInvoicePreview(); // Llama a la funci√≥n aqu√≠
          } else {
            console.log("No se encontraron documentos en la colecci√≥n de impuestos");
          }
        })
        .catch((error) => {
          console.error("Error al obtener el porcentaje de ITBIS: ", error);
        });
    };

    // Llama a la funci√≥n al cargar la p√°gina
    loadITBISPercentage();


    function formatPhoneNumber(input) {
      // Eliminar todos los caracteres que no sean d√≠gitos
      let value = input.value.replace(/\D/g, '');

      // Formatear el n√∫mero con guiones
      if (value.length > 0) {
        value = value.replace(/(\d{3})(\d)/, '$1-$2'); // Agregar guion despu√©s de los primeros 3 d√≠gitos
      }
      if (value.length > 7) {
        value = value.replace(/-(\d{3})(\d)/, '-$1-$2'); // Agregar guion despu√©s de los siguientes 3 d√≠gitos
      }

      // Actualizar el valor del input
      input.value = value;
    }



    const updateInvoicePreview = () => {
      const clientName = document.getElementById("clientName").value || "Sin nombre";
      const clientPhone = document.getElementById("clientPhone").value || "Sin tel√©fono";
      const clientAddress = document.getElementById("clientAddress").value || "Sin direcci√≥n";

      const selectedDelivery = deliverySelection.querySelector("button.active");
      const selectedProducts = Array.from(productSelection.querySelectorAll(".productInput"));

      let subtotal = 0; // Inicializar subtotal

      // Calcular el total de los hampers
      hampers.forEach(hamper => {
        const price = parseFloat(hamper.priceDisplay.textContent.replace('Precio: RD$', '')) || 0;
        subtotal += price; // Sumar al subtotal
      });

      // Calcular el total de otros servicios
      otrosServicios.forEach(item => {
        const count = parseInt(item.input.value) || 0;
        subtotal += count * item.price; // Sumar al subtotal
      });

      // Calcular el total de productos adicionales
      selectedProducts.forEach(product => {
        const quantity = parseInt(product.value) || 0;
        const productPrice = parseFloat(product.closest('.product-item').querySelector('.productPrice').textContent.replace('$', '')) || 0;
        subtotal += quantity * productPrice; // Sumar al subtotal
      });

      // Obtener el precio del delivery
      const deliveryPrice = selectedDelivery ? parseFloat(selectedDelivery.dataset.value) : 0;
      subtotal += deliveryPrice; // Incluir delivery en el subtotal

      // Calcular el ITBIS
      const itbis = (asumirPor !== "desactivado") ? subtotal * itbisPercentage : 0; // Calcular ITBIS solo si no est√° desactivado

      // Calcular el total a pagar
      let total;
      if (asumirPor === "empresa") {
        total = subtotal; // El total es solo el subtotal
      } else {
        total = subtotal + itbis; // Sumar el ITBIS al total si no es "empresa"
      }

      // Calcular el total de productos
      const productsDetails = selectedProducts.map(product => {
        const quantity = parseInt(product.value) || 0;
        const productName = product.closest('.product-item').querySelector('div').textContent;
        const productPrice = parseFloat(product.closest('.product-item').querySelector('.productPrice').textContent.replace('$', '')) || 0;
        const productTotal = quantity * productPrice;

        if (quantity > 0) {
          return `<div style="display: flex; justify-content: space-between; gap: 24px;"><span>${productName} - Cant. ${quantity} X RD$${productPrice}</span><span>RD$${productTotal.toFixed(2)}</span></div>`;
        }
        return null;
      }).filter(Boolean).join("");

      // Actualizar el contenido de invoiceDetails
      document.getElementById("invoiceDetails").innerHTML = `
    <div style="display: flex;justify-content: flex-start;gap: 5px;flex-direction: row;align-items: center;">
      <strong>Cliente:</strong> ${clientName} </div>

    <div style="display: flex;justify-content: flex-start;gap: 5px;flex-direction: row;align-items: center;">
      <strong>Tel√©fono:</strong> ${clientPhone} </div>

    <div style="display: flex;justify-content: flex-start;gap: 5px;flex-direction: row;align-items: center;">
      <strong>Direcci√≥n:</strong> ${clientAddress} </div>

    ${hampers.length > 0 || otrosServicios.length > 0 ? `
      <br><strong>Servicios:</strong>
      ${hampers.length > 0 ? hampers.map(hamper => {
        const weight = parseInt(hamper.weightInput.value);
        const data = hamper.data;
        const librasMin = parseInt(data.librasmin);
        const librasMax = parseInt(data.librasmax);
        const precioPorLibra = parseFloat(data.preciolibras);
        const displayWeight = (weight >= librasMin && weight <= librasMax) ? "1 hamper" : `${weight}lbs X RD$${precioPorLibra}`;
        return `<div style="display: flex; justify-content: space-between; gap: 24px;"><span>${data.nombre} (${displayWeight})</span><span>RD$${hamper.priceDisplay.textContent.replace('Precio: RD$', '')}</span></div>`;
      }).join("") : ""}
      ${otrosServicios.length > 0 ? otrosServicios.map(service => `<div style="display: flex; justify-content: space-between; gap: 24px;"><span>${service.name}: ${service.input.value}</span><span>RD$${(parseFloat(service.price) * parseInt(service.input.value)).toFixed(2)}</span></div>`).join("") : ""}
    ` : ""}

    ${productsDetails.length > 0 ? `
        <strong><br>Productos:<br></strong>
        ${productsDetails}
    ` : ""}

    <strong><br>Delivery:<br></strong>
    <div style="display: flex; justify-content: space-between;"><span>${selectedDelivery ? selectedDelivery.dataset.name : "Sin delivery"}:</span><span>RD$${selectedDelivery ? selectedDelivery.dataset.value : "0"}</span></div><br>

${asumirPor !== "desactivado" ? `
  <br><div style="display: flex; justify-content: space-between;">
    <strong>Subtotal:</strong>
    <strong>RD$${subtotal.toFixed(2)}</strong>
  </div>
  <br><div style="display: flex; justify-content: space-between;">
    <strong>${asumirPor === "empresa" ? "ITBIS Incluidos" : "ITBIS"} (${(itbisPercentage * 100).toFixed(2)}%):</strong>
    <strong>RD$${itbis.toFixed(2)}</strong>
  </div>
` : ""}
    
    <div style="display: flex; justify-content: space-between;">
      <strong>Total a Pagar:</strong>
      <strong>RD$${total.toFixed(2)}</strong>
    </div>
  `;

      document.getElementById("invoiceResult").classList.remove("hidden");
    };




    const loadDeliveryOptions = () => {
      db.collection("delivery").orderBy("orden").onSnapshot((snapshot) => {
        deliverySelection.innerHTML = "";
        snapshot.forEach((doc) => {
          const data = doc.data();
          const button = document.createElement("button");
          button.type = "button";
          button.id = "DeliveryButton";
          button.innerHTML = `${data.nombre} <img src="./img/icon/${data.icon}" alt="${data.nombre}">`;
          button.dataset.name = data.nombre;

          // Crear un input para el precio
          const priceInput = document.createElement("input");
          priceInput.type = "number";
          priceInput.placeholder = "0"; // Placeholder que dice "0"
          priceInput.min = "0"; // Valor m√≠nimo
          priceInput.max = "9999"; // Establecer el m√°ximo a 9999

          // Si es "Sin delivery", establecer el valor en 0 y hacerlo no editable
          if (data.nombre === "Sin delivery") {
            priceInput.value = "0"; // Valor inicial
            priceInput.readOnly = true; // Hacerlo no editable
          } else {
            priceInput.value = ""; // Sin valor inicial
            priceInput.addEventListener("input", () => {
              // Validar que el valor no exceda 9999
              if (priceInput.value > 9999) {
                priceInput.value = 9999; // Limitar a 9999
              }
              button.dataset.value = priceInput.value || "0"; // Si est√° vac√≠o, se establece en "0"
              updateInvoicePreview(); // Actualiza la vista previa de la factura
            });
          }

          button.appendChild(priceInput);

          button.addEventListener("click", (e) => {
            handleActiveState(e, deliverySelection);

            // Al hacer clic, se establece el valor del bot√≥n en el dataset
            const inputValue = priceInput.value || "0"; // Si el input est√° vac√≠o, se establece en "0"
            button.dataset.value = inputValue; // Actualiza el valor del bot√≥n

            updateInvoicePreview(); // Actualiza la vista previa de la factura
          });

          deliverySelection.appendChild(button);
        });
      });
    };

    const handleActiveState = (event, container) => {
      const buttons = container.querySelectorAll("button");
      buttons.forEach(button => button.classList.remove("active"));
      event.currentTarget.classList.add("active");
    };

    const loadProducts = () => {
      db.collection("productos").orderBy("ordenNum").onSnapshot((snapshot) => {
        productSelection.innerHTML = "";
        snapshot.forEach((doc) => {
          const data = doc.data();
          const productItem = document.createElement("div");
          productItem.classList.add("product-item");
          productItem.innerHTML = `
        <div>${data.nombre}</div>
        <div id="detalles-hidden" style="align-items: flex-start;">${data.detalles}</div>
        <div>
          <div class="productPrice">$${data.precio}</div>
          <div class="productQuantity" style="font-size: 14px;font-weight: bold; color: ${data.cantidad < 20 ? 'red' : '#3fbfe7'};">Disponible: ${data.cantidad}</div>
          <div style="display: flex;flex-direction: row;">
              <button id="btnmenosmas" type="button" class="decreaseProduct">-</button>
              <input id="InputCantidades" type="number" class="productInput" value="" min="0" max="${data.cantidad}" placeholder="0">
              <button id="btnmenosmas" type="button" class="increaseProduct">+</button>
          </div>
          <div class="productTotal">Total: $0.00</div>
        </div>
      `;
          productSelection.appendChild(productItem);

          const increaseButton = productItem.querySelector(".increaseProduct");
          const decreaseButton = productItem.querySelector(".decreaseProduct");
          const inputField = productItem.querySelector(".productInput");
          const totalDisplay = productItem.querySelector(".productTotal");

          // Evento para aumentar la cantidad
          increaseButton.addEventListener("click", () => {
            const currentValue = parseInt(inputField.value) || 0;
            if (currentValue < data.cantidad) {
              inputField.value = currentValue + 1;
              updateProductTotal(inputField, totalDisplay, data.precio);
            }
          });

          // Evento para disminuir la cantidad
          decreaseButton.addEventListener("click", () => {
            const currentValue = parseInt(inputField.value) || 0;
            if (currentValue > 0) {
              inputField.value = currentValue - 1;
              updateProductTotal(inputField, totalDisplay, data.precio);
            }
          });

          // Evento para cambios manuales en el input
          inputField.addEventListener("input", () => {
            const currentValue = parseInt(inputField.value) || 0;
            if (currentValue > data.cantidad) {
              inputField.value = data.cantidad; // Limitar al m√°ximo disponible
            }
            updateProductTotal(inputField, totalDisplay, data.precio);
          });
        });
      });
    };

    const updateProductTotal = (inputField, totalDisplay, price) => {
      const quantity = parseInt(inputField.value) || 0;
      const total = quantity * price;
      totalDisplay.textContent = `Total: $${total.toFixed(2)}`;

      const productItem = inputField.closest('.product-item');
      if (quantity > 0) {
        productItem.style.backgroundColor = "#f1d6ef";
        productItem.style.border = "1px solid #e9bbe6";
      } else {
        productItem.style.backgroundColor = "#f9f9f9";
        productItem.style.border = "1px solid #ddd";
      }

      updateInvoicePreview();
    };


    const loadEmployees = () => {
      const empleadoSelect = document.getElementById("empleado");
      db.collection("empleados").onSnapshot((snapshot) => {
        empleadoSelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Selecciona";
        empleadoSelect.appendChild(defaultOption);

        snapshot.forEach((doc) => {
          const data = doc.data();
          const option = document.createElement("option");
          option.value = doc.id;
          option.textContent = data.nombre;
          empleadoSelect.appendChild(option);
        });
      });
    };

    loadEmployees();


    document.getElementById("processInvoice").addEventListener("click", () => {
      const clientName = document.getElementById("clientName").value.trim();
      const clientPhone = document.getElementById("clientPhone").value.replace(/-/g, ''); // Eliminar guiones
      const empleadoSelect = document.getElementById("empleado");

      // Validaci√≥n del n√∫mero de tel√©fono
      if (clientPhone.length < 10) {
        alert("El n√∫mero de tel√©fono debe tener al menos 10 caracteres.");
        return;
      }

      if (!empleadoSelect.value) {
        alert("Por favor, selecciona un empleado.");
        return;
      }

      if (!clientName || !clientPhone) {
        alert("Por favor, completa el nombre del cliente.");
        return;
      }

      // Validaci√≥n del nombre del cliente
      if (!clientName.includes(" ") || clientName.split(" ")[1].length < 1) {
        alert("Debes colocar el apellido del cliente");
        return;
      }

      const invoiceDetails = document.getElementById("invoiceDetails").innerHTML;
      document.getElementById("modalInvoiceDetails").innerHTML = invoiceDetails;

      const total = calculateTotal();
      document.getElementById("totalToPay").textContent = `RD$${total.toFixed(2)}`;

      document.getElementById("confirmationModal").classList.remove("hidden");
    });

    document.querySelector(".close-button").addEventListener("click", () => {
      document.getElementById("confirmationModal").classList.add("hidden");
    });


    // desahbilitar los botones de pagos
    const paymentButtons = document.querySelectorAll(".payment-button");
    const pendingPaymentButton = document.getElementById("pendingPayment");
    const paidButton = document.getElementById("paid");

    // Funci√≥n para habilitar los botones de estado
    const enablePaymentButtons = () => {
      paidButton.classList.remove("disabled");
    };

    // Agregar evento a los botones de m√©todo de pago
    paymentButtons.forEach(button => {
      button.addEventListener("click", (e) => {
        // Remover la clase active de todos los botones
        paymentButtons.forEach(btn => btn.classList.remove("active"));

        // A√±adir la clase active al bot√≥n clicado
        e.target.classList.add("active");

        // Mostrar cashPaymentOptions solo para efectivo
        document.getElementById("cashPaymentOptions").classList.toggle("hidden", e.target.value !== "Efectivo");

        // Validar los botones de pago
        validatePaymentButtons();
      });
    });
    paymentButtons.forEach(button => {
      button.addEventListener("click", (event) => {
        // Obtener elementos de las opciones de pago
        const cashPaymentOptions = document.getElementById("cashPaymentOptions");
        const transferCardPaymentOptions = document.getElementById("transferCardPaymentOptions");

        // Mostrar/ocultar opciones seg√∫n m√©todo de pago seleccionado
        if (event.target.value === "Efectivo") {
          cashPaymentOptions.classList.remove("hidden");
          // Mantener visible transferCardPaymentOptions para abonos en efectivo
          transferCardPaymentOptions.classList.remove("hidden");
        } else if (event.target.value === "Transferencia" || event.target.value === "Tarjeta de Cr√©dito") {
          cashPaymentOptions.classList.add("hidden");
          transferCardPaymentOptions.classList.remove("hidden");
        } else {
          cashPaymentOptions.classList.add("hidden");
          transferCardPaymentOptions.classList.remove("hidden");
        }

        // Remover la clase active de todos los botones
        paymentButtons.forEach(btn => btn.classList.remove("active"));

        // A√±adir la clase active al bot√≥n clicado
        event.target.classList.add("active");

        // Validar los botones de pago
        validatePaymentButtons();
      });
    });

    // Funci√≥n para validar los botones de pago
    function validatePaymentButtons() {
      const paymentMethod = document.querySelector(".payment-button.active")?.value;
      const total = calculateTotal();
      const amountReceived = parseFloat(document.getElementById("amountReceived").value) || 0;
      const partialAmount = parseFloat(document.getElementById("partialAmount").value) || 0;
      const paidButton = document.getElementById("paid");
      const partialButton = document.getElementById("partialPayment");

      // Validar bot√≥n "Pago Recibido"
      if (paymentMethod === "Efectivo") {
        paidButton.classList.toggle("disabled", amountReceived < total);
      } else if (paymentMethod === "Transferencia" || paymentMethod === "Tarjeta de Cr√©dito") {
        // Para transferencia/tarjeta, habilitar siempre el bot√≥n
        paidButton.classList.remove("disabled");
      } else {
        paidButton.classList.add("disabled");
      }

      // Validar bot√≥n "Abono" - debe tener un monto v√°lido (mayor que 0 y menor que total)
      partialButton.classList.toggle("disabled",
        partialAmount <= 0 || partialAmount >= total
      );
    }

    // Evento para los botones de m√©todo de pago
    paymentButtons.forEach(button => {
      button.addEventListener("click", (e) => {
        // Remover la clase active de todos los botones
        paymentButtons.forEach(btn => btn.classList.remove("active"));

        // A√±adir la clase active al bot√≥n clicado
        e.target.classList.add("active");

        // Mostrar cashPaymentOptions solo para efectivo
        document.getElementById("cashPaymentOptions").classList.toggle("hidden", e.target.value !== "Efectivo");

        // Validar los botones de pago inmediatamente
        validatePaymentButtons();
      });
    });

    // Evento para cambios en el monto recibido (solo efectivo)
    document.getElementById("amountReceived").addEventListener("input", () => {
      const total = calculateTotal();
      const amountReceived = parseFloat(document.getElementById("amountReceived").value) || 0;
      document.getElementById("changeAmount").textContent = `RD$${(amountReceived - total).toFixed(2)}`;

      // Solo validar si el m√©todo actual es efectivo
      if (document.querySelector(".payment-button.active")?.value === "Efectivo") {
        validatePaymentButtons();
      }
    });

    // Evento para cambios en el monto de abono
    document.getElementById("partialAmount").addEventListener("input", () => {
      validatePaymentButtons();
    });

    document.querySelectorAll(".payment-button").forEach(button => {
      button.addEventListener("click", (e) => {
        document.querySelectorAll(".payment-button").forEach(btn => btn.classList.remove("active"));
        e.target.classList.add("active");
        // Mostrar cashPaymentOptions solo para efectivo
        document.getElementById("cashPaymentOptions").classList.toggle("hidden", e.target.value !== "Efectivo");
        // transferCardPaymentOptions siempre visible
        validatePaymentButtons();
      });
    });

    // Eventos de los botones de pago
    document.getElementById("pendingPayment").addEventListener("click", () => {
      if (confirm("¬øSeguro que quieres asignar esta factura como pago pendiente?")) {
        processInvoice("pago pendiente");
      }
    });

    document.getElementById("partialPayment").addEventListener("click", async () => {
      // Verificar si hay un m√©todo de pago seleccionado
      const selectedPaymentMethod = document.querySelector(".payment-button.active");

      if (!selectedPaymentMethod) {
        alert("Por favor selecciona un m√©todo de pago");
        return;
      }

      const paymentMethod = selectedPaymentMethod.value;
      const partialAmount = parseFloat(document.getElementById("partialAmount").value) || 0;
      const total = calculateTotal();

      if (partialAmount <= 0 || partialAmount >= total) {
        alert("Por favor ingrese un monto v√°lido para el abono (mayor que 0 y menor que el total)");
        return;
      }

      if (confirm(`¬øSeguro que deseas registrar un abono de RD$${partialAmount}?`)) {
        try {
          await processInvoice("pagado", true, partialAmount);
        } catch (error) {
          console.error("Error:", error);
          alert("Error al procesar el abono");
        }
      }
    });

    document.getElementById("paid").addEventListener("click", async () => {
      const paymentMethod = document.querySelector(".payment-button.active").value;
      const total = calculateTotal();

      if (paymentMethod === "Efectivo") {
        const amountReceived = parseFloat(document.getElementById("amountReceived").value) || 0;
        if (amountReceived < total) {
          alert("El monto recibido debe ser igual o mayor al total");
          return;
        }
      }

      try {
        await processInvoice("pagado");
      } catch (error) {
        console.error("Error:", error);
        alert("Error al procesar el pago");
      }
    });

    // Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("paid").classList.add("disabled");
      document.getElementById("partialPayment").classList.add("disabled");
    });

    const processInvoice = async (status, isPartialPayment = false, partialAmount = 0) => {
      // Si el estado es "pago pendiente", no se necesita un m√©todo de pago
      let paymentMethod = status === "pago pendiente" ? "Pago Pendiente" : document.querySelector(".payment-button.active").value;

      const deliveryOption = deliverySelection.querySelector("button.active");
      const deliveryPrice = deliveryOption ? deliveryOption.dataset.value : "0";

      // Obtener el subtotal
      let subtotal = 0;

      // Calcular el total de los hampers
      hampers.forEach(hamper => {
        const price = parseFloat(hamper.priceDisplay.textContent.replace('Precio: RD$', '')) || 0;
        subtotal += price; // Sumar al subtotal
      });

      // Calcular el total de otros servicios
      otrosServicios.forEach(item => {
        const count = parseInt(item.input.value) || 0;
        subtotal += count * item.price; // Sumar al subtotal
      });

      // Calcular el total de productos adicionales
      const selectedProducts = Array.from(productSelection.querySelectorAll(".productInput"));
      selectedProducts.forEach(product => {
        const quantity = parseInt(product.value) || 0;
        const productPrice = parseFloat(product.closest('.product-item').querySelector('.productPrice').textContent.replace('$', '')) || 0;
        subtotal += quantity * productPrice; // Sumar al subtotal
      });

      // Obtener el precio del delivery
      const selectedDelivery = deliverySelection.querySelector("button.active");
      const deliveryPriceValue = selectedDelivery ? parseFloat(selectedDelivery.dataset.value) : 0;
      subtotal += deliveryPriceValue; // Incluir delivery en el subtotal

      // Calcular el ITBIS
      const itbis = (asumirPor !== "desactivado") ? subtotal * itbisPercentage : 0; // Calcular ITBIS solo si no est√° desactivado

      // Calcular el total a pagar
      const total = (asumirPor === "empresa") ? subtotal : subtotal + itbis; // Ajustar el total seg√∫n asumirPor

      // Si el m√©todo de pago es Efectivo, obtener el monto recibido y calcular el cambio
      let amountReceived = 0;
      let changeAmount = 0;
      let remainingBalance = 0;

      if (isPartialPayment) {
        amountReceived = partialAmount;
        remainingBalance = total - partialAmount;
      } else if (paymentMethod === "Efectivo") {
        amountReceived = parseFloat(document.getElementById("amountReceived").value) || 0;
        changeAmount = amountReceived - total;
      } else if (paymentMethod === "Transferencia" || paymentMethod === "Tarjeta de Cr√©dito") {
        // Para transferencia/tarjeta sin abono, el monto recibido es el total
        amountReceived = total;
      }

      const invoiceData = {
        id: generateNewInvoiceId(await getLastInvoiceId()),
        clientName: document.getElementById("clientName").value.trim(),
        clientPhone: document.getElementById("clientPhone").value.replace(/-/g, ''),
        clientAddress: document.getElementById("clientAddress").value.trim(),
        NombreEmpleado: document.getElementById("empleado").options[document.getElementById("empleado").selectedIndex].text,
        selectedServices: hampers.map(hamper => {
          const weight = parseInt(hamper.weightInput.value);
          const librasMin = parseInt(hamper.data.librasmin);
          const librasMax = parseInt(hamper.data.librasmax);

          return {
            name: hamper.data.nombre,
            weight: weight,
            price: hamper.priceDisplay.textContent.replace('Precio: RD$', ''),
            priceXlbs: hamper.data.preciolibras,
            hamperComplete: (weight >= librasMin && weight <= librasMax) ? "yes" : "no"
          };
        }),

        otrosServicios: otrosServicios.map(item => ({
          name: item.name,
          count: parseInt(item.input.value) || 0,
          price: item.price
        })).filter(item => item.count > 0),
        deliveryOption: deliveryOption ? [{
          name: deliveryOption.dataset.name,
          price: deliveryPrice
        }] : [{ name: "Sin Delivery", price: "0" }],
        selectedProducts: Array.from(productSelection.querySelectorAll(".productInput")).map(product => ({
          name: product.closest('.product-item').querySelector('div').textContent,
          quantity: parseInt(product.value) || 0,
          price: parseFloat(product.closest('.product-item').querySelector('.productPrice').textContent.replace('$', ''))
        })).filter(product => product.quantity > 0),
        total: total,
        paymentMethod: paymentMethod,
        status: status,
        amountReceived: amountReceived,
        changeAmount: changeAmount,
        remainingBalance: remainingBalance,
        abonoFact: isPartialPayment ? "yes" : "", // Cambiado a cadena vac√≠a para no abonos
        amountReceivedAbono1er: isPartialPayment ? partialAmount : 0, // Nuevo campo para el monto del primer abono
        amountReceivedAbono1erMethod: isPartialPayment ? paymentMethod : "",
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        ITBISmonto: itbis
      };

      try {
        const invoiceRef = await db.collection("facturas").add(invoiceData);
        const invoiceDoc = await invoiceRef.get();
        const invoiceId = invoiceDoc.data().id;
        document.getElementById("invoiceIdDisplay").textContent = `${invoiceId}`;

        // ========== [NUEVO C√ìDIGO A√ëADIDO] ==========
        // Funci√≥n para detectar productos b√°sicos (insensible a may√∫sculas/acentos)
        const esProductoBasico = (nombre) =>
          nombre.normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .includes('basico');

        // Calcular total de productos no b√°sicos
        let totalProductos = 0;
        const productosInputs = Array.from(productSelection.querySelectorAll(".productInput"));

        productosInputs.forEach(input => {
          const cantidad = parseInt(input.value) || 0;
          if (cantidad > 0) {
            const nombreProducto = input.closest('.product-item').querySelector('div').textContent;
            if (!esProductoBasico(nombreProducto)) {
              totalProductos += cantidad;
            }
          }
        });

        // Registrar en ventaproductos solo si hay productos v√°lidos
        if (totalProductos > 0) {
          const nombreEmpleado = document.getElementById("empleado").options[document.getElementById("empleado").selectedIndex].text;

          await db.collection("ventaproductos").doc(nombreEmpleado).set({
            empleado: nombreEmpleado,
            monto: firebase.firestore.FieldValue.increment(totalProductos)
          }, { merge: true });
        }
        // ========== [FIN DE NUEVO C√ìDIGO] ==========

        // Actualizar inventario de productos adicionales basado en el array "consumo" de los hampers
        for (const hamper of hampers) {
          for (const item of hamper.consumo) {
            const productDoc = await db.collection("productos").where("id", "==", item.id).get();
            if (!productDoc.empty) {
              const productRef = productDoc.docs[0].ref;
              const productData = productDoc.docs[0].data();
              const newQuantity = productData.cantidad - item.cantidad;
              await productRef.update({ cantidad: newQuantity });
            }
          }
        }

        // Actualizar inventario de productos adicionales basado en el array "consumo" de los "otroservicio"
        for (const servicio of otrosServicios) {
          const cantidadServicio = parseInt(servicio.input.value) || 0;
          if (cantidadServicio > 0) {
            for (const item of servicio.consumo) {
              const productDoc = await db.collection("productos").where("id", "==", item.id).get();
              if (!productDoc.empty) {
                const productRef = productDoc.docs[0].ref;
                const productData = productDoc.docs[0].data();
                const newQuantity = productData.cantidad - (item.cantidad * cantidadServicio);
                await productRef.update({ cantidad: newQuantity });
              }
            }
          }
        }

        // Actualizar inventario de productos seleccionados manualmente
        for (const product of selectedProducts) {
          const quantity = parseInt(product.value) || 0;
          if (quantity > 0) {
            const productName = product.closest('.product-item').querySelector('div').textContent;
            const productDoc = await db.collection("productos").where("nombre", "==", productName).get();
            if (!productDoc.empty) {
              const productRef = productDoc.docs[0].ref;
              const productData = productDoc.docs[0].data();
              const newQuantity = productData.cantidad - quantity;
              await productRef.update({ cantidad: newQuantity });
            }
          }
        }

        disablePaymentButtons();
        document.getElementById("cashPaymentOptions").classList.add("hidden");

        showProcessedInvoiceModal(
          document.getElementById("modalInvoiceDetails").innerHTML,
          paymentMethod,
          amountReceived,
          changeAmount,
          status,
          isPartialPayment,
          partialAmount,
          remainingBalance
        );

        clearSelections();
        document.getElementById("billingForm").reset();
        document.getElementById("amountReceived").value = "";
        document.getElementById("partialAmount").value = "";
        document.getElementById("changeAmount").textContent = "";
        document.getElementById("empleado").selectedIndex = 0;
        updateInvoicePreview();

      } catch (error) {
        console.error("Error al guardar la factura: ", error);
        alert("Hubo un problema al procesar la factura. Int√©ntalo de nuevo.");
      }

      document.getElementById("confirmationModal").classList.add("hidden");
    };





    // Eventos de entrada para validar botones
    document.getElementById("amountReceived").addEventListener("input", () => {
      const total = calculateTotal();
      const amountReceived = parseFloat(document.getElementById("amountReceived").value) || 0;
      document.getElementById("changeAmount").textContent = `RD$${(amountReceived - total).toFixed(2)}`;
      validatePaymentButtons();
    });

    document.getElementById("partialAmount").addEventListener("input", () => {
      validatePaymentButtons();
    });




    // Funci√≥n para deshabilitar los botones de pago
    const disablePaymentButtons = () => {

      const paidButton = document.getElementById("paid");
      paidButton.classList.add("disabled");
    };

    const getLastInvoiceId = async () => {
      const invoicesSnapshot = await db.collection("facturas").orderBy("id", "desc").limit(1).get();
      if (!invoicesSnapshot.empty) {
        const lastInvoice = invoicesSnapshot.docs[0].data();
        return lastInvoice.id;
      }
      return "a00000";
    };

    const generateNewInvoiceId = (lastId) => {
      const lastNumber = parseInt(lastId.substring(1));
      const newNumber = lastNumber + 1;
      return `a${String(newNumber).padStart(5, '0')}`;
    };





    const calculateTotal = () => {
      let total = 0;

      // Calcular subtotal
      hampers.forEach(hamper => {
        const price = parseFloat(hamper.priceDisplay.textContent.replace('Precio: RD$', '')) || 0;
        total += price;
      });

      otrosServicios.forEach(item => {
        const count = parseInt(item.input.value) || 0;
        total += count * item.price;
      });

      const selectedDelivery = deliverySelection.querySelector("button.active");
      if (selectedDelivery) {
        total += parseFloat(selectedDelivery.dataset.value) || 0;
      }

      const selectedProducts = Array.from(productSelection.querySelectorAll(".productInput"));
      selectedProducts.forEach(product => {
        const quantity = parseInt(product.value) || 0;
        const price = parseFloat(product.closest('.product-item').querySelector('.productPrice').textContent.replace('$', '')) || 0;
        total += quantity * price;
      });

      // Calcular el ITBIS solo si asumirPor no est√° en "desactivado" y est√° en "cliente"
      let itbis = 0;
      if (asumirPor !== "desactivado" && asumirPor !== "empresa") {
        itbis = total * itbisPercentage; // Aseg√∫rate de que itbisPercentage est√© definido y tenga el valor correcto
      }

      total += itbis; // Sumar el ITBIS al total

      return total;
    };






    const clearSelections = () => {
      const deliveryButtons = deliverySelection.querySelectorAll("button");
      deliveryButtons.forEach(button => button.classList.remove("active"));

      const activeButtons = document.querySelectorAll(".button-list button.active");
      activeButtons.forEach(button => button.classList.remove("active"));

      const productInputs = productSelection.querySelectorAll(".productInput");
      productInputs.forEach(input => {
        input.value = 0;
        const productItem = input.closest('.product-item');
        productItem.style.backgroundColor = "#f9f9f9";
      });

      hamperContainer.innerHTML = "";
      hampers = [];

      otrosServiciosDisplay.innerHTML = "";
      otrosServicios = [];

      const otrosInputs = otrosServiciosDisplay.querySelectorAll(".itemInput");
      otrosInputs.forEach(input => {
        input.value = 0;
      });

      updateInvoicePreview();
    };

    document.getElementById("clientName").addEventListener("input", updateInvoicePreview);
    document.getElementById("clientPhone").addEventListener("input", updateInvoicePreview);
    document.getElementById("clientAddress").addEventListener("input", updateInvoicePreview);

    loadServices();
    loadDeliveryOptions();
    loadProducts();


    //Modal Factura procesada
    const showProcessedInvoiceModal = (invoiceDetails, paymentMethod, amountReceived, changeAmount, status, isPartial = false, partialAmount = 0, remainingBalance = 0) => {
      // Obtener la fecha y hora actual en formato AM/PM
      const now = new Date();
      const hours = now.getHours() % 12 || 12;
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
      const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;

      // Formatear fecha
      const day = now.getDate().toString().padStart(2, "0");
      const month = (now.getMonth() + 1).toString().padStart(2, "0");
      const year = now.getFullYear();
      const dateString = `${day}/${month}/${year}`;

      let paymentDetails = `
    <div style="display: flex; justify-content: space-between;">
      <strong>M√©todo de Pago:</strong>
      <span>${paymentMethod}</span>
    </div>
  `;

      if (isPartial) {
        paymentDetails += `
      <div style="display: flex; justify-content: space-between;">
        <strong>Monto Abonado:</strong> 
        <span>RD$${partialAmount.toFixed(2)}<span><br>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <strong>Saldo Pendiente:</strong>
        <span>RD$${remainingBalance.toFixed(2)}</span>
      </div>
      <div style="text-align: center; margin-top: 10px; margin-bottom: 4px;font-weight: bold; color: orange;">
        Pago Parcial (Abono)
      </div>
    `;
      } else if (paymentMethod === "Efectivo") {
        paymentDetails += `
      <div style="display: flex; justify-content: space-between;">
        <strong>Monto Recibido:</strong> 
        <span>RD$${amountReceived.toFixed(2)}<span><br>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <strong>Cambio:</strong>
        <span>RD$${changeAmount.toFixed(2)}</span>
      </div>
    `;
      }

      const statusDisplay = status === "pago pendiente" ? `
    <div style="text-align: center; margin-top: 10px; margin-bottom: 4px;font-weight: bold; color: red;">
      Pago Pendiente
    </div>
  ` : "";

      const details = `
    <div style="display: inline-flex;width: 100%;padding-left: 0; margin-left: 0;"">

      <div style="display: inline-flex;justify-content: center;width: 100%;gap: 10px;padding-left: 0; margin-left: 0;"">
        <div>
           <img src="./img/logo1_impresion.png" style="height: 100px;margin: 5px 0px;">
        </div>

        <div style="display: inline-flex;flex-direction: column;justify-content: space-between;">
          <h1 style="font-size: 24px;text-align: center;margin-block-start: 0px;margin-block-end: 0px;">Paris Laundry RD</h1>
          <p style="margin-block-start: 0px;margin-block-end: 0px;font-size: 12px;width: 95%;margin: 0 auto;">Direcci√≥n: Santo Domingo Este, Sector Alma Rosa, Calle Club Activo 2030 #24, 2do nivel.</p>

             <div style="text-align: end;padding-left: 0;margin-left: 0;display: inline-flex;flex-direction: column;">
               <strong>Fecha y Hora:</strong>
               <span>${dateString} ${timeString}</span>
             </div>
        </div>
      </div>

    </div>

    <div style="background: black; height: 1px; width: 100%; margin-bottom: 4px;"></div>
    
    ${invoiceDetails}<br>
    
    ${paymentDetails}
    ${statusDisplay}
  `;

      document.getElementById("processedInvoiceDetails").innerHTML = details;
      document.getElementById("processedInvoiceModal").classList.remove("hidden");
    };




    const closeProcessedInvoiceModal = () => {
      // Cerrar el modal
      document.getElementById("processedInvoiceModal").classList.add("hidden");
      document.getElementById("partialPayment").classList.add("disabled");


      // Reiniciar la opci√≥n de m√©todo de pago
      const paymentButtons = document.querySelectorAll(".payment-button");
      paymentButtons.forEach(button => button.classList.remove("active"));
    };


    // Modificar el evento de los botones de pago
    document.getElementById("pendingPayment").addEventListener("click", async () => {
      const paymentMethod = document.querySelector(".payment-button.active").value;
      const amountReceived = paymentMethod === "Efectivo" ? parseFloat(document.getElementById("amountReceived").value) || 0 : 0;
      const changeAmount = paymentMethod === "Efectivo" ? amountReceived - calculateTotal() : 0;

      // Mostrar el modal con el estado "pago pendiente"
      showProcessedInvoiceModal(document.getElementById("modalInvoiceDetails").innerHTML, paymentMethod, amountReceived, changeAmount, "pago pendiente");
    });

    document.getElementById("paid").addEventListener("click", () => {
      const paymentMethod = document.querySelector(".payment-button.active").value;
      const amountReceived = paymentMethod === "Efectivo" ? parseFloat(document.getElementById("amountReceived").value) || 0 : 0;
      const changeAmount = paymentMethod === "Efectivo" ? amountReceived - calculateTotal() : 0;

      // Solo mostrar el modal sin procesar la factura
      showProcessedInvoiceModal(document.getElementById("modalInvoiceDetails").innerHTML, paymentMethod, amountReceived, changeAmount);
    });
    //Modal Factura procesada FIN












    // A√±adir la biblioteca QRious en el head del documento
    (function loadQriousScript() {
      if (!window.QRious) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js';
        script.async = true;
        document.head.appendChild(script);
      }
    })();

    document.getElementById("printInvoiceButton").addEventListener("click", () => {
      printInvoice();
    });

    const printInvoice = () => {
      const invoiceDetails = document.getElementById("processedInvoiceDetails").innerHTML;
      const invoiceId = document.getElementById("invoiceIdDisplay").textContent; // Obtener el ID de la factura

      // Cargar primero la imagen para asegurarnos de que est√© disponible antes de imprimir
      const logoImg = new Image();
      logoImg.onload = () => {
        // Una vez que la imagen se cargue, procedemos con la impresi√≥n
        proceedWithPrinting(invoiceDetails, invoiceId, logoImg);
      };

      logoImg.onerror = () => {
        // Si hay un error al cargar la imagen, intentamos con una ruta alternativa
        console.warn("Error al cargar el logo. Intentando ruta alternativa...");
        logoImg.src = "../logo1.png"; // Intentar con una ruta relativa alternativa

        // Si despu√©s de un tiempo prudente sigue sin cargar, imprimimos sin logo
        setTimeout(() => {
          if (!logoImg.complete || logoImg.naturalHeight === 0) {
            console.error("No se pudo cargar el logo. Imprimiendo sin logo.");
            proceedWithPrinting(invoiceDetails, invoiceId, null);
          }
        }, 1000);
      };

      // Intentar primero con la ruta directa
      logoImg.src = "./img/logo1_impresion.png";
    };

    const proceedWithPrinting = (invoiceDetails, invoiceId, logoImg) => {
      const printWindow = window.open('', '', 'height=600,width=800');

      // Obtener la fecha y hora actual en formato AM/PM    
      const now = new Date();
      const hours = now.getHours() % 12 || 12;
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
      const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;

      // Reemplazar "Peso: X lbs" por "1 hamper" si est√° dentro del rango
      const modifiedDetails = invoiceDetails.replace(/Peso: (\d+) lbs/g, (match, weight) => {
        const weightNum = parseInt(weight);
        const hamperData = hampers.find(hamper => parseInt(hamper.weightInput.value) === weightNum);
        if (hamperData) {
          const librasMin = parseInt(hamperData.data.librasmin);
          const librasMax = parseInt(hamperData.data.librasmax);
          return (weightNum >= librasMin && weightNum <= librasMax) ? "1 hamper" : match;
        }
        return match;
      });

      // Preparar el logo para la ventana de impresi√≥n
      let logoHtml = '';

      if (logoImg && logoImg.complete && logoImg.naturalHeight !== 0) {
        // Si la imagen se carg√≥ correctamente, la convertimos a base64 para asegurar que se imprima
        try {
          // Crear un canvas para convertir la imagen a base64
          const canvas = document.createElement('canvas');
          canvas.width = logoImg.width;
          canvas.height = logoImg.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(logoImg, 0, 0);

          // Convertir a base64
          const dataUrl = canvas.toDataURL('image/png');

          // Crear el HTML para la imagen
          logoHtml = `<img src="${dataUrl}" alt="Logo de Paris Laundry RD" style="">`;
        } catch (e) {
          console.error("Error al convertir la imagen a base64", e);
          // Usar la imagen directamente como fallback
          logoHtml = `<img src="${logoImg.src}" alt="Logo de Paris Laundry RD" style="">`;
        }
      } else {
        // Si no se pudo cargar la imagen, usar un texto como respaldo
        logoHtml = `<div style="border: 1px solid #ccc; padding: 10px; text-align: center;">
              <span style="font-size: 20px; font-weight: bold;">PARIS LAUNDRY RD</span>
            </div>`;
      }

      // Crear URL para consultar estado de la ropa
      const trackingUrl = `www.midominio.com/#id-${invoiceId}`;

      // Generar c√≥digo QR localmente con QRious
      const qrCanvas = document.createElement('canvas');
      qrCanvas.width = 100;
      qrCanvas.height = 100;

      // Esperar a que la biblioteca QRious est√© cargada
      const generateQR = () => {
        if (window.QRious) {
          const qr = new QRious({
            element: qrCanvas,
            value: 'https://' + trackingUrl,
            size: 100
          });
          return qrCanvas.toDataURL('image/png');
        } else {
          // Si QRious no est√° cargado, esperamos 100ms y volvemos a intentar
          return null;
        }
      };

      // Intentar generar el QR o usar un texto alternativo
      let qrDataUrl = generateQR();

      // Si la biblioteca no est√° lista, esperar un poco y reintentar una vez
      if (!qrDataUrl && typeof QRious === 'undefined') {
        setTimeout(() => {
          const retryQrDataUrl = generateQR();
          if (retryQrDataUrl) {
            // Si en el segundo intento se consigue generar el QR, actualizar la imagen
            const qrImg = printWindow.document.querySelector('.qr-code img');
            if (qrImg) {
              qrImg.src = retryQrDataUrl;
            }
          }
        }, 200); // Esperar 200ms antes de reintentar
      }

      printWindow.document.write(`
<html>
<head>
  <title>Factura</title>
  <style>
      @media print {
          @page {
      margin: 3mm 3mm 3mm 3mm; /* o 0 para m√°rgenes m√≠nimos */
      size: auto;
    }
          body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 20px;
              print-color-adjust: exact;
              -webkit-print-color-adjust: exact;
          }
          .logo-container {
              display: block !important;
              visibility: visible !important;
              text-align: center;
              margin: 10px 0;
          }
          img {
              display: block !important;
              visibility: visible !important;
              max-width: 100px;
              height: auto;
              margin: 0 auto;
          }
          .qr-code {
              display: block !important;
              visibility: visible !important;
              text-align: center;
              margin: 0;
          }
          .tracking-info {
              text-align: center;
              margin: 5px 0;
          }
      }
      
      body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 20px;
          margin: 0 !important;
          padding: 0 !important;
          width: 100% !important;
      
      }
      h1 {
          text-align: center;
          font-size: 14px;
          margin-block-start: 0px;
          margin-block-end: 0px;
      }

      h2 {
          margin-block-start: 0px;
          margin-block-end: 5px;
          margin-top: 10px;
          text-align: center;
          font-size: 1.1em;
      }

      img {
          display: block !important;
          visibility: visible !important;
          max-width: 100px;
          height: auto;
          margin: 0 auto;
      }
  
      .invoice-details {
          margin: 0px 0px;
      }
      .invoice-details strong {
          display: block;
          margin: 0px 0;
      }
      
      .logo-container {
          text-align: center;
          margin: 10px 0;
      }
      .tracking-info {
          text-align: center;
          margin: 2px 0;
          font-size: 0.9em;
      }
      .tracking-url {
          font-weight: bold;
          font-size: 1em;
      }
      .qr-code {
          text-align: center;
          margin: 0;
      }

        body, html, .MasterBox, .container_previewfactura, #invoiceResult {
    margin: 0 !important;
    padding: 0 !important;
    width: 97% !important;
  }
  </style>
</head>
<body>

  <h2 style="margin-block-end: 7px;">Factura</h2>
  <div style="background: black; height: 1px; width: 100%;"></div>

  <!-- <div class="logo-container" style="display: inline-flex;align-items: center;">
      <div style="width: 50px;">${logoHtml}</div>
      <div>
          <h1 style="font-size: 24px;">Paris Laundry RD3</h1>
      </div>   
  </div> -->

  <div class="invoice-details">

      ${modifiedDetails}

      <div style="background: black; height: 1px; width: 100%; margin-top: 4px;"></div>

      <div style="display: inline-flex;width: 100%;flex-direction: column;align-items: center; margin-top: 10px; margin-bottom: 0px;">
          <span>ID de Factura:</span> <strong style="font-size: 37px;">${invoiceId}</strong>
      </div>
      
      <!-- Informaci√≥n de seguimiento -->
      <!-- <div class="tracking-info">
          <p style="margin-block-start: 7px;margin-block-end: 2px;">Consulta el estado de tu ropa en el link:</p>
          <p class="tracking-url" style="margin-block-start: 2px;margin-block-end: 2px;">${trackingUrl}</p>
      </div> -->
      
      <!-- C√≥digo QR -->
      <!-- <div class="qr-code">
          ${qrDataUrl
          ? `<img src="${qrDataUrl}" alt="C√≥digo QR para seguimiento" style="width:100px; height:100px;">`
          : `<div style="width:100px; height:100px; margin:0 auto; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; text-align:center; font-size:10px;">
                 Escanea el URL para seguimiento
               </div>`
        }
      </div> -->

      <div style="width: 100%;margin-bottom: 0px;text-align: justify;">
          <p>Nota: No somos responsables por da√±os ocasionados por las m√°quinas o por la mala divisi√≥n de la ropa por parte del cliente.</p>
      </div>

      <h2>¬°Gracias por elegirnos!</h2>

      <div style="width: 100%;margin-bottom: 30px;text-align: center;"><p>.</p></div>

  </div>
</body>
</html>
`);

      printWindow.document.close();
      printWindow.focus();

      // Si tenemos el QR generado, imprimimos inmediatamente
      if (qrDataUrl) {
        setTimeout(() => {
          printWindow.print();
          setTimeout(() => {
            printWindow.close();
          }, 300);
        }, 200);
      } else {
        // Si el QR a√∫n no est√° listo, damos un poco m√°s de tiempo para que se cargue la biblioteca
        setTimeout(() => {
          printWindow.print();
          setTimeout(() => {
            printWindow.close();
          }, 300);
        }, 500);
      }
    };







    // ===== [CONTROL DE ABONO SIMPLIFICADO] ===== //
    document.addEventListener('DOMContentLoaded', function () {
      const abonoCheckbox = document.getElementById('pagarConAbonoCheckbox');
      const opcionesAbono = document.getElementById('transferCardPaymentOptions');

      // 1. Ocultar al cargar
      opcionesAbono.style.display = 'none';

      // 2. Mostrar/ocultar al hacer click
      abonoCheckbox.addEventListener('click', function () {
        opcionesAbono.style.display = this.checked ? 'block' : 'none';
      });

      // 3. Ocultar siempre que se abra el modal (a√±ade esto donde procesas la factura)
      document.getElementById('processInvoice').addEventListener('click', function () {
        abonoCheckbox.checked = false;
        opcionesAbono.style.display = 'none';
      });
    });

    // 1. Controlar visibilidad con el checkbox
    document.getElementById('pagarConAbonoCheckbox').addEventListener('change', function () {
      document.getElementById('cashPaymentOptions').hidden = this.checked;
    });

    // 2. Reiniciar al cerrar el modal
    document.querySelector('.close-button').addEventListener('click', function () {
      document.getElementById('pagarConAbonoCheckbox').checked = false;
      document.getElementById('cashPaymentOptions').hidden = false;
    });
  </script>

</body>

</html>

<!-- 4 -->