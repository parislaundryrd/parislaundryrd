<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Contabilidad - Paris Laundry</title>
  <link rel="icon" href="./img/Paris Laundry 1.png" type="image/png">
  <link rel="stylesheet" href="./css/styles_contabilidad.css">
  <link rel="stylesheet" href="./css/styles_menu.css">
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
  <script src="./js/app.js"></script>
  <script src="./js/menu.js" defer></script>
  <style>
    .transaction-table-container {
      min-height: 160px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 0px 0px 10px 10px;
    }

    .transaction-table {
      width: 100%;
      border-collapse: collapse;
      /* Colapsar bordes */
    }

    .transaction-table th,
    .transaction-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #b3cfe7;
      /* Línea entre filas */
      cursor: pointer;
      /* Cambiar cursor al pasar sobre las filas */
    }

    .transaction-table th {
      background-color: #c6daf3;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .highlight {
      background-color: yellow;
    }
  </style>
</head>

<body>

  <div class="MasterBox0" style="display: none;">

    <laundry-menu></laundry-menu>

    <!-- Contenedor de inventario -->
    <div class="container_contabilidad">

      <!-- Titulo -->
      <div class="panelContabilidad_tittle">
        <h2>Contabilidad</h2>
      </div>
      <!-- Titulo FIN -->

      <!-- body -->
      <div class="panelContabilidad_body">

        <!-- Resumen -->
        <div class="ResumenBox-Master">
          <div class="summary" id="summary">
            <h2 style="margin-block-start: 5px;margin-block-end: 5px;text-align: center;">Resumen Total</h2>
            <p id="IngresoStyle">Ingresos Total: <span id="totalIncome" style="color: black;">0.00</span></p>
            <p id="GastoStyle">Gastos Total: <span id="totalExpenses" style="color: black;">0.00</span></p>
            <p id="BalanceStyle">Balance Total: <span id="balance" style="color: black;">0.00</span></p>
          </div>

          <!-- Filtrar por Fecha -->
          <div class="filter">
            <h2 style="margin-block-start: 5px;margin-block-end: 5px;text-align: center;">Filtrar por Fecha</h2>
            <div style="margin-top: 14px;display: inline-flex;gap: 20px;">
              <div class="fechaCSS">
                <label for="startDate" style="font-weight: bold;">Desde:</label>
                <input type="date" id="startDate">
              </div>
              <div class="fechaCSS">
                <label for="endDate" style="font-weight: bold;">Hasta:</label>
                <input type="date" id="endDate">
              </div>
            </div>
            <button id="filterButton">Filtrar Fecha</button>
            <button id="resetFilterButton">Borrar Fecha</button>
          </div>
          <!-- Filtrar por Fecha FIN -->

          <!-- Chart -->
          <div class="Chart-Master">
            <div class="ChartCSS">
              <div class="box-año-dashboard" style="display: inline-flex;align-items: center;margin: 7px 0px;">
                <h2 style="margin-block-start: -4px;margin-block-end: 5px;text-align: center;display: contents;">
                  Ingresos y Gastos por Mes - Año: </h2>
                <select id="yearSelect" style="margin-left: 5px;">
                  <option value="2025">2025</option>
                </select>
              </div>

              <canvas id="monthlyChart" width="400" height="160"></canvas>
            </div>
            <div class="ChartCSS">
              <!-- <label for="yearSelect">Año:</label> -->

            </div>
          </div>
          <!-- Chart FIN -->

        </div>
        <!-- Resumen FIN -->


        <!-- Transacciones -->
        <h2 style="text-align: center;margin-block-start: 5px;margin-block-end: 7px;">Transacciones</h2>

        <div class="Top-Container">

          <!-- Boton Añadir Transaccion -->
          <div class="button-list">
            <button id="addTransactionButton"><img src="./img/icon/mas.png">Añadir Transacción</button>
          </div>
          <!-- Boton Añadir Transaccion FIN -->

          <!-- Barra de busqueda -->
          <div class="search-bar">
            <input type="text" id="searchInput"
              placeholder="Buscar por ID, detalles, nombre del cliente, número del cliente, empleado o monto">
            <div class="cantidad-img"><img src="./img/icon/buscar2.png"></div>
          </div>
          <!-- Barra de busqueda FIN -->

          <div
            style="display: inline-flex;flex-direction: column;justify-content: space-evenly;margin: 0px 14px;font-weight: bold;color: #252525;">

            <!-- transacciones Visibles -->
            <div id="visibleTransactionCount">Transacciones visibles: 0</div>
            <!-- transacciones Visibles FIN -->
            <!-- Filtrar transacciones por tipo -->
            <div class="transaction-filter">
              <label for="transactionTypeFilter">Filtrar por tipo:</label>
              <select id="transactionTypeFilter">
                <option value="all">Todas</option>
                <option value="expense">Gasto</option>
                <option value="income">Ingreso</option>
              </select>
            </div>
            <!-- Filtrar transacciones por tipo FIN -->


          </div>

        </div>

        <!-- Tabla de Transacciones -->
        <div class="transaction-table-container">
          <table class="transaction-table" id="combinedTransactionTable">
            <thead>
              <tr>
                <th><input type="checkbox" class="transaction-checkbox" checked=""
                    style="filter: opacity(0.3);pointer-events: none;"></th>

                <th>ID</th>
                <th>Tipo</th>
                <th>Detalles</th>
                <th>Monto</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody id="combinedTransactionList"></tbody>
          </table>
        </div>
        <!-- Tabla de Transacciones FIN -->
        <!-- Transacciones FIN -->


      </div>
      <!-- body FIN -->


      <!-- Down -->
      <div class="panelContabilidad_down">
        <p>© Paris Laundry RD - 2025</p>
      </div>
      <!-- Down FIN -->

    </div>
    <!-- Contenedor de inventario FIN -->



    <!-- Modal para agregar transacción -->
    <div id="addTransactionModal" class="modal">
      <div class="modal-content">

        <!-- modal-content-tiitle -->
        <div class="modal-content-tiitle">
          <span class="close" id="closeModal">&times;</span>
          <h2>Añadir Nueva Transacción</h2>
        </div>
        <!-- modal-content-tiitle FIN -->

        <!-- modal-content-body -->
        <div class="modal-content-body">

          <label for="transactionType">Tipo:</label>
          <select id="transactionType">
            <option value="expense">Gasto (-)</option>
            <option value="income">Ingreso (+)</option>
            <option value="employeePayment">Pago de Empleado</option> <!-- Nuevo tipo -->
          </select>

          <div class="modal-divisor"></div> <!-- Modal divisor -->

          <!-- Sección de Transacción Normal -->
          <div id="normalTransactionFields">
            <div style="margin-top: 17px;display: flex;flex-direction: row;align-items: center;">
              <div class="fecha-hora-modal">
                <label for="transactionDate">Fecha:</label>
                <input type="date" id="transactionDate">
              </div>
              <div class="fecha-hora-modal">
                <label for="transactionTime">Hora:</label>
                <input type="time" id="transactionTime">
              </div>
            </div>

            <div class="modal-divisor"></div> <!-- Modal divisor -->

            <label for="transactionAmount">Monto:</label><br>
            <input type="number" id="transactionAmount" placeholder="Monto (RD$)" step="0.01">
            <br>
            <label for="transactionDetails">Detalles:</label><br>
            <textarea id="transactionDetails" placeholder="Nota o descripción de la transacción"></textarea>
            <br><br>
          </div>

          <!-- Sección de Pago de Empleado -->
          <div id="employeePaymentFields" style="display: none;"> <!-- Campos ocultos por defecto -->

            <h3 style="margin-block-start: 0px;margin-block-end: 1em;text-align: center;">Pago de Empleado:</h3>

            <label for="employeeName">Nombre de Empleado:</label>
            <select id="employeeName" style="margin-bottom: 8px;">
              <option value="">Selecciona un empleado</option> <!-- Opción por defecto -->
            </select>
            <br>

            <div class="cube-form">

              <div class="cube-form-flex">
                <div>
                  <label for="salaryPayment">Pago de Sueldo:</label>
                </div>
                <div>
                  <input type="number" id="salaryPayment" placeholder="Monto (RD$)" step="0.01">
                </div>
              </div>

              <div class="cube-form-flex">
                <div>
                  <label for="holidayPayment">Pago de Día Feriado:</label>
                </div>
                <div>
                  <input type="number" id="holidayPayment" placeholder="Monto (RD$)" step="0.01">
                </div>
              </div>

              <div class="cube-form-flex">
                <div>
                  <label for="overtimePayment">Pago Hora Extra:</label>
                </div>
                <div>
                  <input type="number" id="overtimePayment" placeholder="Monto (RD$)" step="0.01">
                </div>
              </div>

              <div class="cube-form-flex">
                <div>
                  <label for="vacationPayment">Pago de Vacaciones:</label>
                </div>
                <div>
                  <input type="number" id="vacationPayment" placeholder="Monto (RD$)" step="0.01">
                </div>
              </div>

              <div class="cube-form-flex">
                <div>
                  <label for="christmasPayment">Pago de Navidad:</label>
                </div>
                <div>
                  <input type="number" id="christmasPayment" placeholder="Monto (RD$)" step="0.01">
                </div>
              </div>
            </div>


            <div class="modal-divisor"></div> <!-- Modal divisor -->

            <h3 style="text-align: center;">Incentivos</h3>

            <div class="cube-form">
              <!-- Agregar este span para mostrar la cantidad de productos vendidos -->
              <div class="cube-form-flex">
                <div id="productsSoldInfo" style="margin-bottom: 8px;">
                  <span style="font-weight: bold;">Cantidad de productos vendidos:</span>
                  <span id="productsSoldAmount" style="color: #0069af; font-weight: bold;">0</span>
                  <div id="productsSoldTimestamp" style="font-size: 14px;color: #0069af;font-weight: bold;"></div>
                  <label style="display: flex; align-items: center; margin-top: 5px;">
                    <input type="checkbox" id="resetProductsSoldCheckbox"
                      style="margin-right: 7px;margin-bottom: 6px;height: 25px;width: 25px;">
                    Pagar incentivo por ventas de producto.
                  </label>
                </div>
              </div>

              <div class="cube-form-flex">
                <div>
                  <label for="productSale">Venta de Producto:</label>
                </div>
                <div>
                  <input type="number" id="productSale" placeholder="Monto (RD$)" step="0.01" disabled
                    style="background-color: rgb(193 193 193); color: #888; cursor: no-drop;">
                </div>
              </div>

              <div class="cube-form-flex">
                <div>
                  <label for="productionIncentive">Producción:</label>
                </div>
                <div>
                  <input type="number" id="productionIncentive" placeholder="Monto (RD$)" step="0.01">
                </div>
              </div>

              <div class="cube-form-flex">
                <div>
                  <label for="punctualityIncentive">Puntualidad:</label>
                </div>
                <div>
                  <input type="number" id="punctualityIncentive" placeholder="Monto (RD$)" step="0.01">
                </div>
              </div>
            </div>


            <div class="modal-divisor"></div> <!-- Modal divisor -->

            <h3 style="text-align: center;">Descuentos</h3>

            <div class="cube-form">
              <div class="cube-form-flex">
                <div>
                  <label for="licenseDay">Día de Licencia:</label>
                </div>
                <div>
                  <input type="number" id="licenseDay" placeholder="Monto (RD$)" step="0.01">
                </div>
              </div>

              <div class="cube-form-flex">
                <div>
                  <label for="insurance">Seguro:</label>
                </div>
                <div>
                  <input type="number" id="insurance" placeholder="Monto (RD$)" step="0.01">
                </div>
              </div>
            </div>

            <div class="modal-divisor"></div> <!-- Modal divisor -->

            <br>
            <div style="display: flex;flex-direction: row;align-items: center;">
              <div class="fecha-hora-modal">
                <label for="employeePaymentDate">Fecha de Pago:</label>
                <input type="date" id="employeePaymentDate"> <!-- Campo de fecha -->
              </div>
              <div class="fecha-hora-modal">
                <label for="employeePaymentTime">Hora de Pago:</label>
                <input type="time" id="employeePaymentTime"> <!-- Campo de hora -->
              </div>
            </div>

            <div class="modal-divisor"></div> <!-- Modal divisor -->

            <input type="hidden" id="type" value="expense"> <!-- Campo oculto -->

            <div class="cube-form">
              <div class="cube-form-flex">
                <div>
                  <label for="totalAmount">Total:</label>
                </div>
                <div>
                  <input type="text" id="totalAmount" readonly placeholder="Total (RD$)">
                </div>
              </div>
            </div>
            <!-- Campo para mostrar total -->



          </div>
        </div>
        <!-- modal-content-body FIN -->

        <!-- modal-content-down -->
        <div class="modal-content-down">
          <button id="submitTransactionButton">Añadir Transacción</button>
        </div>
        <!-- modal-content-down FIN -->
      </div>
    </div>

    <!-- Modal para editar transacción -->
    <div id="editTransactionModal" class="modal">
      <div class="modal-content">

        <!-- modal-content-tiitle -->
        <div class="modal-content-tiitle">
          <span class="close" id="closeEditModal">&times;</span>
          <h2>Editar Transacción</h2>
        </div>
        <!-- modal-content-tiitle FIN -->

        <!-- modal-content-body -->
        <div class="modal-content-body">
          <input type="hidden" id="editTransactionId">
          <label for="editTransactionType">Tipo:</label>
          <select id="editTransactionType">
            <option value="income">Ingreso</option>
            <option value="expense">Gasto</option>
          </select>

          <div class="modal-divisor"></div> <!-- Modal divisor -->

          <div style="display: flex;flex-direction: row;align-items: center;">
            <div class="fecha-hora-modal">
              <label for="editTransactionDate">Fecha:</label>
              <input type="date" id="editTransactionDate">
            </div>
            <div class="fecha-hora-modal">
              <label for="editTransactionTime">Hora:</label>
              <input type="time" id="editTransactionTime">
            </div>
          </div>

          <div class="modal-divisor"></div> <!-- Modal divisor -->

          <label for="editTransactionAmount">Monto:</label>
          <input type="number" id="editTransactionAmount" placeholder="Monto (RD$)" step="0.01">

          <label for="editTransactionDetails">Detalles:</label>
          <textarea id="editTransactionDetails" placeholder="Descripción de la transacción"></textarea>

        </div>
        <!-- modal-content-body FIN -->

        <!-- modal-content-down -->
        <div class="modal-content-down">
          <button id="deleteTransactionButton" style="background: #f59696;">Eliminar Transacción</button>
          <button id="saveTransactionButton">Guardar Cambios</button>
        </div>
        <!-- modal-content-down FIN -->
      </div>
    </div>

    <!-- Modal para editar factura -->
    <div id="editInvoiceModal" class="modal">
      <div class="modal-content">

        <!-- modal-content-tiitle -->
        <div class="modal-content-tiitle">
          <span class="close" id="closeInvoiceModal">&times;</span>
          <h2>Editar Factura</h2>
        </div>
        <!-- modal-content-tiitle FIN -->

        <!-- modal-content-body -->
        <div class="modal-content-body">
          <input type="hidden" id="editInvoiceId">
          <label for="editClientName">Nombre del Cliente:</label>
          <input type="text" id="editClientName" placeholder="Nombre del Cliente">
          <br>
          <label for="editClientPhone">Teléfono del Cliente:</label>
          <input type="text" id="editClientPhone" placeholder="Teléfono del Cliente">
          <br>
          <label for="editClientAddress">Dirección del Cliente:</label>
          <input type="text" id="editClientAddress" placeholder="Dirección del Cliente">

          <div class="modal-divisor"></div> <!-- Modal divisor -->

          <label for="editEmployeeName">Nombre del Empleado:</label>
          <input type="text" id="editEmployeeName" placeholder="Nombre del Empleado">

          <div class="modal-divisor"></div> <!-- Modal divisor -->

          <label for="editDeliveryName">Opción de Entrega:</label>
          <input type="text" id="editDeliveryName" placeholder="Nombre de la Opción de Entrega">
          <br>
          <label for="editDeliveryPrice">Precio de la Entrega:</label>
          <input type="text" id="editDeliveryPrice" placeholder="Precio" value="0.00"> <!-- Cambiado a tipo text -->

        </div>
        <!-- modal-content-body FIN -->

        <!-- modal-content-down -->
        <div class="modal-content-down">
          <button id="deleteInvoiceButton" style="background: #f59696;">Eliminar Factura</button>
          <button id="saveInvoiceButton">Guardar Cambios</button>
        </div>
        <!-- modal-content-down FIN -->
      </div>
    </div>





    <!-- Modal para editar pago de empleado -->
    <div id="editEmployeePaymentModal" class="modal">
      <div class="modal-content">

        <!-- modal-content-tiitle -->
        <div class="modal-content-tiitle">
          <span class="close" id="closeEditEmployeeModal">&times;</span>
          <h2>Editar Pago de Empleado</h2>
        </div>
        <!-- modal-content-tiitle FIN -->

        <!-- modal-content-body -->
        <div class="modal-content-body">
          <input type="hidden" id="editEmployeePaymentId">


          <div class="cube-form">

            <div class="cube-form-flex">
              <div>
                <!-- Campo para el nombre del empleado (nuevo id) -->
                <label for="editEmployeePaymentName">Nombre de Empleado:</label>
              </div>
              <div>
                <input type="text" id="editEmployeePaymentName" style="width: 150px;">
              </div>
            </div>

            <div class="cube-form-flex">
              <div>
                <label for="editSalaryPayment">Pago de Sueldo:</label>
              </div>
              <div>
                <input type="number" id="editSalaryPayment" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>

            <div class="cube-form-flex">
              <div>
                <label for="editHolidayPayment">Pago de Día Feriado:</label>
              </div>
              <div>
                <input type="number" id="editHolidayPayment" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>

            <div class="cube-form-flex">
              <div>
                <label for="editOvertimePayment">Pago Hora Extra:</label>
              </div>
              <div>
                <input type="number" id="editOvertimePayment" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>

            <div class="cube-form-flex">
              <div>
                <label for="editVacationPayment">Pago de Vacaciones:</label>
              </div>
              <div>
                <input type="number" id="editVacationPayment" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>

            <div class="cube-form-flex">
              <div>
                <label for="editChristmasPayment">Pago de Navidad:</label>
              </div>
              <div>
                <input type="number" id="editChristmasPayment" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>
          </div>


          <div class="modal-divisor"></div> <!-- Modal divisor -->

          <h3 style="text-align: center;">Incentivos</h3>

          <div class="cube-form">

            <div class="cube-form-flex">
              <div>
                <label for="editProductSale">Venta de Producto:</label>
              </div>
              <div>
                <input type="number" id="editProductSale" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>

            <div class="cube-form-flex">
              <div>
                <label for="editProductionIncentive">Producción:</label>
              </div>
              <div>
                <input type="number" id="editProductionIncentive" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>

            <div class="cube-form-flex">
              <div>
                <label for="editPunctualityIncentive">Puntualidad:</label>
              </div>
              <div>
                <input type="number" id="editPunctualityIncentive" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>
          </div>


          <div class="modal-divisor"></div> <!-- Modal divisor -->

          <h3 style="text-align: center;">Descuentos</h3>

          <div class="cube-form">
            <div class="cube-form-flex">
              <div>
                <label for="editLicenseDay">Día de Licencia:</label>
              </div>
              <div>
                <input type="number" id="editLicenseDay" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>

            <div class="cube-form-flex">
              <div>
                <label for="editInsurance">Seguro:</label>
              </div>
              <div>
                <input type="number" id="editInsurance" placeholder="Monto (RD$)" step="0.01">
              </div>
            </div>
          </div>

          <div class="modal-divisor"></div> <!-- Modal divisor -->

          <br>
          <div style="display: flex;flex-direction: row;align-items: center;">
            <div class="fecha-hora-modal">
              <label for="editEmployeePaymentDate">Fecha de Pago:</label>
              <input type="date" id="editEmployeePaymentDate">
            </div>
            <div class="fecha-hora-modal">
              <label for="editEmployeePaymentTime">Hora de Pago:</label>
              <input type="time" id="editEmployeePaymentTime">
            </div>
          </div>

          <div class="modal-divisor"></div> <!-- Modal divisor -->

          <div class="cube-form">
            <div class="cube-form-flex">
              <div>
                <label for="editTotalAmount">Total:</label>
              </div>
              <div>
                <input type="text" id="editTotalAmount" readonly>
              </div>
            </div>
          </div>

        </div>
        <!-- modal-content-body FIN -->

        <!-- modal-content-down -->
        <div class="modal-content-down">
          <button id="deleteEmployeePaymentButton" style="background: #f59696;">Eliminar Pago de Empleado</button>
          <button id="saveEmployeePaymentButton">Guardar Cambios</button>
        </div>
        <!-- modal-content-down FIN -->
      </div>


    </div>

   <script>
  // Al inicio de tu script, antes de las funciones
  window.combinedTransactions = []; // Lista global de transacciones

  // Función para obtener la fecha actual en formato YYYY-MM-DD
// Función para obtener la fecha actual en formato YYYY-MM-DD (menos un día)
const getCurrentDate = () => {
  const now = new Date();
  // Restar un día
  now.setDate(now.getDate() - 1);
  return now.toISOString().split('T')[0];
};

  // Función para establecer las fechas por defecto
const setDefaultDates = () => {
  const currentDate = getCurrentDate();
  document.getElementById("startDate").value = currentDate;
  document.getElementById("endDate").value = currentDate;
};

  // Reemplaza la llamada a loadTransactions() al final del script con:
  document.addEventListener('DOMContentLoaded', () => {
    // Establecer fechas por defecto
    setDefaultDates();
    
    setupRealTimeListeners();

    // Configurar eventos de filtrado para que actualicen la UI
    document.getElementById("filterButton").addEventListener("click", updateTransactionListUI);
    document.getElementById("resetFilterButton").addEventListener("click", updateTransactionListUI);
    document.getElementById("transactionTypeFilter").addEventListener("change", updateTransactionListUI);
    document.getElementById("searchInput").addEventListener("input", searchTransactions);
  });

  const addTransactionModal = document.getElementById("addTransactionModal");
  const closeModal = document.getElementById("closeModal");
  const submitTransactionButton = document.getElementById("submitTransactionButton");
  const filterButton = document.getElementById("filterButton");
  const totalIncomeElement = document.getElementById("totalIncome");
  const totalExpensesElement = document.getElementById("totalExpenses");
  const balanceElement = document.getElementById("balance");
  const editTransactionModal = document.getElementById("editTransactionModal");
  const closeEditModal = document.getElementById("closeEditModal");
  const saveTransactionButton = document.getElementById("saveTransactionButton");

  // Función para contar las transacciones visibles
  const countVisibleTransactions = () => {
    const combinedTransactionList = document.getElementById("combinedTransactionList");
    const rows = combinedTransactionList.getElementsByTagName("tr");
    let visibleCount = 0;

    // Contar las filas visibles
    for (let i = 0; i < rows.length; i++) {
      if (rows[i].offsetParent !== null) { // Verifica si la fila es visible
        visibleCount++;
      }
    }

    // Actualizar el conteo en el DOM
    const visibleCountElement = document.getElementById("visibleTransactionCount");
    visibleCountElement.textContent = `Transacciones visibles: ${visibleCount}`;
  };

  // Mantenemos la función original loadTransactions para cargas iniciales
  const loadTransactions = () => {
    const combinedTransactions = [];
    const startDate = document.getElementById("startDate").value ? new Date(document.getElementById("startDate").value) : null;
    const endDate = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value) : null;

    // Asegúrate de que la fecha de fin incluya todo el día
    if (endDate) {
      endDate.setHours(23, 59, 59, 999);
      endDate.setDate(endDate.getDate() + 1);
    }

    // Asegurarse de que la fecha de inicio incluya el inicio del día
    if (startDate) {
      startDate.setHours(0, 0, 0, 0);
      startDate.setDate(startDate.getDate() + 1);
    }

    let totalIncome = 0;
    let totalExpenses = 0;

    // Cargar transacciones de la colección "transacciones"
    let transactionsQuery = db.collection("transacciones").orderBy("timestamp", "desc");

    // Filtrar transacciones según las fechas seleccionadas
    if (startDate && endDate) {
      transactionsQuery = transactionsQuery.where("timestamp", ">=", startDate).where("timestamp", "<=", endDate);
    }

    transactionsQuery.get()
      .then((snapshot) => {
        snapshot.forEach((doc) => {
          const data = doc.data();
          const transactionDate = data.timestamp ? data.timestamp.toDate() : null;

          combinedTransactions.push({
            id: data.id,
            type: data.type,
            amount: data.amount,
            date: transactionDate,
            details: data.details || "Sin detalles"
          });

          // Sumar a los totales
          if (data.type === "income") {
            totalIncome += data.amount;
          } else {
            totalExpenses += data.amount;
          }
        });

        // Cargar pagos de empleados
        return db.collection("PagoEmpleado").orderBy("timestamp", "desc").get();
      })
      .then((snapshot) => {
        snapshot.forEach((doc) => {
          const data = doc.data();
          const employeePaymentDate = data.timestamp ? data.timestamp.toDate() : null;

          // Filtrar pagos de empleados según las fechas
          if ((!startDate || employeePaymentDate >= startDate) &&
            (!endDate || employeePaymentDate <= endDate)) {
            combinedTransactions.push({
              id: data.id,
              type: "expense",
              amount: data.total,
              date: employeePaymentDate,
              details: `Pago de empleado: ${data.employeeName}`
            });
            totalExpenses += data.total;
          }
        });

        // Cargar facturas
        return db.collection("facturas").orderBy("timestamp", "desc").get();
      })
      .then((snapshot) => {
        snapshot.forEach((doc) => {
          const data = doc.data();
          const invoiceDate = data.timestamp ? data.timestamp.toDate() : null;

          // Filtrar facturas según las fechas
          if ((!startDate || invoiceDate >= startDate) &&
            (!endDate || invoiceDate <= endDate)) {
            combinedTransactions.push({
              id: data.id,
              type: "income",
              amount: data.total,
              date: invoiceDate,
              details: `Factura | Cliente: ${data.clientName} | Núm.: ${data.clientPhone} | ${data.NombreEmpleado}`,
              clientName: data.clientName,
              clientPhone: data.clientPhone,
              clientAddress: data.clientAddress,
              NombreEmpleado: data.NombreEmpleado,
              deliveryOption: data.deliveryOption
            });
            totalIncome += data.total;
          }
        });

        // Ordenar las transacciones combinadas por fecha
        combinedTransactions.sort((a, b) => b.date - a.date);

        // Actualizar la lista global de transacciones
        window.combinedTransactions = combinedTransactions;

        // Renderizar la lista
        renderTransactionList();

        // Actualizar resumen
        updateSummary(totalIncome, totalExpenses);
        countVisibleTransactions();
      })
      .catch((error) => {
        console.error("Error al cargar transacciones:", error);
      });
  };

  // Nueva función para renderizar la lista de transacciones
  const renderTransactionList = () => {
    const combinedTransactionList = document.getElementById("combinedTransactionList");
    combinedTransactionList.innerHTML = "";
    
    // Obtener fecha actual del dispositivo
    const today = new Date();
    const todayFormatted = today.toISOString().split('T')[0];
    
    // Aplicar filtros
    let startDate = document.getElementById("startDate").value ? new Date(document.getElementById("startDate").value) : null;
    let endDate = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value) : null;
    const typeFilter = document.getElementById("transactionTypeFilter").value;

    // Si no se han seleccionado fechas, usar la fecha actual
    if (!document.getElementById("startDate").value) {
      document.getElementById("startDate").value = todayFormatted;
      startDate = new Date(todayFormatted);
    }
    
    if (!document.getElementById("endDate").value) {
      document.getElementById("endDate").value = todayFormatted;
      endDate = new Date(todayFormatted);
    }

    // Configurar las horas para incluir todo el día
    if (startDate) startDate.setHours(0, 0, 0, 0);
    if (endDate) endDate.setHours(23, 59, 59, 999);

    let totalIncome = 0;
    let totalExpenses = 0;

    window.combinedTransactions.forEach(item => {
      // Comprobar si la transacción tiene una fecha válida
      if (!item.date) return;
      
      // Extraer fecha de la transacción (yyyy-mm-dd)
      const itemDateStr = item.date.toISOString().split('T')[0];
      
      // Extraer fechas de inicio y fin para comparación (yyyy-mm-dd)
      const startDateStr = startDate ? startDate.toISOString().split('T')[0] : null;
      const endDateStr = endDate ? endDate.toISOString().split('T')[0] : null;
      
      // Comparar solo las fechas sin la hora
      const withinStartDate = !startDateStr || itemDateStr >= startDateStr;
      const withinEndDate = !endDateStr || itemDateStr <= endDateStr;
      
      if (withinStartDate && withinEndDate && (typeFilter === "all" || item.type === typeFilter)) {

        const transactionItem = document.createElement("tr");
        transactionItem.innerHTML = `
          <td><input type="checkbox" class="transaction-checkbox" checked></td>
          <td>${item.id}</td>
          <td>${item.type === "income" ? "Ingreso" : "Gasto"}</td>
          <td>${item.details || "Sin detalles"}</td>
          <td>RD$${item.amount.toFixed(2)}</td>
          <td>${item.date ? `${item.date.toLocaleDateString()} ${formatTime(item.date)}` : "Fecha no válida"}</td>
        `;

        const checkbox = transactionItem.querySelector(".transaction-checkbox");
        checkbox.addEventListener("change", () => {
          transactionItem.style.backgroundColor = checkbox.checked ? "" : "lightgray";
          countVisibleTransactionsAndUpdateSummary();
        });

        transactionItem.addEventListener("click", (event) => {
          if (event.target !== checkbox) {
            if (item.type === "income" && item.details.includes("Factura")) {
              openEditInvoiceModal(item);
            } else if (item.type === "expense" && item.details.includes("Pago de empleado")) {
              loadEmployeePaymentData(item.id);
            } else {
              openEditTransactionModal(item);
            }
          }
        });

        combinedTransactionList.appendChild(transactionItem);

        if (item.type === "income") {
          totalIncome += item.amount;
        } else {
          totalExpenses += item.amount;
        }
      }
    });

    updateSummary(totalIncome, totalExpenses);
    countVisibleTransactions();
  };

  // Función para formatear la hora (la mantenemos igual)
  function formatTime(date) {
    const hours = date.getHours();
    const minutes = date.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const formattedHours = hours % 12 === 0 ? 12 : hours % 12;
    return `${formattedHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
  }

  // Configuramos los listeners en tiempo real
  const setupRealTimeListeners = () => {
    // Limpiar listeners anteriores si existen
    if (window.transactionsListener) window.transactionsListener();
    if (window.employeePaymentsListener) window.employeePaymentsListener();
    if (window.invoicesListener) window.invoicesListener();

    // Inicializar la lista global si no existe
    window.combinedTransactions = window.combinedTransactions || [];

    // Listener para transacciones normales
    window.transactionsListener = db.collection("transacciones")
      .orderBy("timestamp", "desc")
      .onSnapshot((snapshot) => {
        snapshot.docChanges().forEach((change) => {
          const data = change.doc.data();
          const transaction = {
            id: data.id,
            type: data.type,
            amount: data.amount,
            date: data.timestamp.toDate(),
            details: data.details || "Sin detalles"
          };

          if (change.type === "added" || change.type === "modified") {
            const index = window.combinedTransactions.findIndex(t => t.id === transaction.id);
            if (index >= 0) {
              window.combinedTransactions[index] = transaction;
            } else {
              window.combinedTransactions.push(transaction);
            }
          } else if (change.type === "removed") {
            window.combinedTransactions = window.combinedTransactions.filter(t => t.id !== transaction.id);
          }
        });

        window.combinedTransactions.sort((a, b) => b.date - a.date);
        renderTransactionList();
      });

    // Listener para pagos de empleados
    window.employeePaymentsListener = db.collection("PagoEmpleado")
      .orderBy("timestamp", "desc")
      .onSnapshot((snapshot) => {
        snapshot.docChanges().forEach((change) => {
          const data = change.doc.data();
          const transaction = {
            id: data.id,
            type: "expense",
            amount: data.total,
            date: data.timestamp.toDate(),
            details: `Pago de empleado: ${data.employeeName}`
          };

          if (change.type === "added" || change.type === "modified") {
            const index = window.combinedTransactions.findIndex(t => t.id === transaction.id);
            if (index >= 0) {
              window.combinedTransactions[index] = transaction;
            } else {
              window.combinedTransactions.push(transaction);
            }
          } else if (change.type === "removed") {
            window.combinedTransactions = window.combinedTransactions.filter(t => t.id !== transaction.id);
          }
        });

        window.combinedTransactions.sort((a, b) => b.date - a.date);
        renderTransactionList();
      });

    // Listener para facturas
    window.invoicesListener = db.collection("facturas")
      .orderBy("timestamp", "desc")
      .onSnapshot((snapshot) => {
        snapshot.docChanges().forEach((change) => {
          const data = change.doc.data();
          const transaction = {
            id: data.id,
            type: "income",
            amount: data.total,
            date: data.timestamp.toDate(),
            details: `Factura | Cliente: ${data.clientName} | Núm.: ${data.clientPhone} | ${data.NombreEmpleado}`,
            clientName: data.clientName,
            clientPhone: data.clientPhone,
            clientAddress: data.clientAddress,
            NombreEmpleado: data.NombreEmpleado,
            deliveryOption: data.deliveryOption
          };

          if (change.type === "added" || change.type === "modified") {
            const index = window.combinedTransactions.findIndex(t => t.id === transaction.id);
            if (index >= 0) {
              window.combinedTransactions[index] = transaction;
            } else {
              window.combinedTransactions.push(transaction);
            }
          } else if (change.type === "removed") {
            window.combinedTransactions = window.combinedTransactions.filter(t => t.id !== transaction.id);
          }
        });

        window.combinedTransactions.sort((a, b) => b.date - a.date);
        renderTransactionList();
      });
  };

  // Mantenemos la función updateSummary sin cambios
  const updateSummary = (totalIncome, totalExpenses) => {
    totalIncomeElement.textContent = totalIncome.toLocaleString('es-DO', { style: 'currency', currency: 'DOP' });
    totalExpensesElement.textContent = totalExpenses.toLocaleString('es-DO', { style: 'currency', currency: 'DOP' });
    balanceElement.textContent = (totalIncome - totalExpenses).toLocaleString('es-DO', { style: 'currency', currency: 'DOP' });
  };

  // Al cargar la página, configuramos los listeners y cargamos los datos iniciales
  document.addEventListener('DOMContentLoaded', () => {
    // Establecer fechas por defecto
    setDefaultDates();
    
    // Primero cargamos los datos iniciales
    loadTransactions();

    // Luego configuramos los listeners para cambios en tiempo real
    setupRealTimeListeners();

    // Configuramos los eventos de los filtros para que llamen a renderTransactionList
    document.getElementById("filterButton").addEventListener("click", renderTransactionList);
    document.getElementById("resetFilterButton").addEventListener("click", () => {
      // Al resetear, volver a establecer las fechas por defecto
      setDefaultDates();
      renderTransactionList();
    });
    document.getElementById("transactionTypeFilter").addEventListener("change", renderTransactionList);
    document.getElementById("searchInput").addEventListener("input", searchTransactions);
  });

  // Función para generar un ID basado en el timestamp actual
  const generateTimestampId = (prefix) => {
    const now = new Date();

    // Obtener componentes de fecha y hora
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = String(now.getFullYear()).slice(-2);
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    // Formato: prefijo + ddmmyy-hhmmss
    return `${prefix}${day}${month}${year}-${hours}${minutes}${seconds}`;
  };

  // Modificar la función addTransaction para usar generateTimestampId
  const addTransaction = async () => {
    const type = document.getElementById("transactionType").value;
    const dateInput = document.getElementById("transactionDate").value;
    const timeInput = document.getElementById("transactionTime").value;

    if (type === "employeePayment") {
      // Lógica para el pago de empleado
      const salaryPayment = parseFloat(document.getElementById("salaryPayment").value) || 0;
      const holidayPayment = parseFloat(document.getElementById("holidayPayment").value) || 0;
      const overtimePayment = parseFloat(document.getElementById("overtimePayment").value) || 0;
      const vacationPayment = parseFloat(document.getElementById("vacationPayment").value) || 0;
      const christmasPayment = parseFloat(document.getElementById("christmasPayment").value) || 0;
      const productSale = parseFloat(document.getElementById("productSale").value) || 0;
      const productionIncentive = parseFloat(document.getElementById("productionIncentive").value) || 0;
      const punctualityIncentive = parseFloat(document.getElementById("punctualityIncentive").value) || 0;
      const licenseDay = parseFloat(document.getElementById("licenseDay").value) || 0;
      const insurance = parseFloat(document.getElementById("insurance").value) || 0;

      const total = salaryPayment + holidayPayment + overtimePayment + vacationPayment + christmasPayment +
        productSale + productionIncentive + punctualityIncentive - licenseDay - insurance;

      const employeeName = document.getElementById("employeeName").value;

      // Obtener la fecha y hora de pago de empleado
      const employeePaymentDate = document.getElementById("employeePaymentDate").value;
      const employeePaymentTime = document.getElementById("employeePaymentTime").value;

      // Validar fecha y hora de pago de empleado
      if (!employeePaymentDate || !employeePaymentTime) {
        alert("Por favor, ingresa una fecha y hora válidas para el pago de empleado.");
        return;
      }

      // Crear el objeto Date para el pago de empleado
      const [year, month, day] = employeePaymentDate.split('-');
      const [hours, minutes] = employeePaymentTime.split(':');
      const paymentDate = new Date(year, month - 1, day, hours, minutes);

      // Generar ID único basado en timestamp con prefijo 'pe'
      const newId = generateTimestampId('pe');

      // Verificar si el checkbox está marcado
      const resetProductsSold = document.getElementById("resetProductsSoldCheckbox").checked;

      // Si el checkbox está marcado, reiniciar los montos en ventaproductos
      if (resetProductsSold && employeeName) {
        try {
          // Obtener todos los documentos de ventaproductos para este empleado
          const querySnapshot = await db.collection("ventaproductos")
            .where("empleado", "==", employeeName)
            .get();

          // Crear un batch para actualizar todos los documentos
          const batch = db.batch();

          querySnapshot.forEach(doc => {
            const docRef = db.collection("ventaproductos").doc(doc.id);
            batch.update(docRef, {
              monto: 0,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
          });

          // Ejecutar el batch
          await batch.commit();
          console.log("Contador de productos vendidos reiniciado para", employeeName);
        } catch (error) {
          console.error("Error al reiniciar el contador de productos vendidos:", error);
        }
      }

      // Agregar el pago de empleado con el nuevo ID
      db.collection("PagoEmpleado").add({
        id: newId,
        type: "expense",
        timestamp: paymentDate,
        employeeName,
        salaryPayment,
        holidayPayment,
        overtimePayment,
        vacationPayment,
        christmasPayment,
        productSale,
        productionIncentive,
        punctualityIncentive,
        licenseDay,
        insurance,
        total
      }).then(() => {
        alert("Pago de empleado agregado correctamente.");
        resetForm(); // Llamar a la función para reiniciar el formulario
        closeModal.click();
        loadTransactions();
      }).catch((error) => {
        console.error("Error al agregar el pago de empleado: ", error);
        alert("Hubo un problema al agregar el pago de empleado.");
      });

    } else {
      // Lógica para transacciones normales (gasto o ingreso)
      const amount = parseFloat(document.getElementById("transactionAmount").value);
      const details = document.getElementById("transactionDetails").value;

      if (!isNaN(amount) && dateInput && timeInput && details) {
        const [year, month, day] = dateInput.split('-');
        const [hours, minutes] = timeInput.split(':');
        const timestamp = new Date(year, month - 1, day, hours, minutes);

        // Determinar el prefijo según el tipo de transacción
        const prefix = type === "expense" ? "tg" : "ti";

        // Generar ID único basado en timestamp
        const newId = generateTimestampId(prefix);

        db.collection("transacciones").add({
          id: newId,
          type,
          amount,
          timestamp,
          details
        }).then(() => {
          alert("Transacción agregada correctamente.");
          resetForm(); // Llamar a la función para reiniciar el formulario
          closeModal.click();
          loadTransactions
        }).catch((error) => {
          console.error("Error al agregar la transacción: ", error);
          alert("Hubo un problema al agregar la transacción.");
        });
      } else {
        alert("Por favor, completa todos los campos correctamente.");
      }
    }
  };

  // Función para reiniciar el formulario
  const resetForm = () => {
    document.getElementById("transactionType").value = "expense"; // Restablecer tipo a gasto
    document.getElementById("transactionDate").value = ""; // Limpiar fecha
    document.getElementById("transactionTime").value = ""; // Limpiar hora
    document.getElementById("transactionAmount").value = ""; // Limpiar monto
    document.getElementById("transactionDetails").value = ""; // Limpiar detalles
    document.getElementById("employeeName").value = ""; // Limpiar nombre de empleado
    document.getElementById("salaryPayment").value = ""; // Limpiar pago de sueldo
    document.getElementById("holidayPayment").value = ""; // Limpiar pago de día feriado
    document.getElementById("overtimePayment").value = ""; // Limpiar pago hora extra
    document.getElementById("vacationPayment").value = ""; // Limpiar pago de vacaciones
    document.getElementById("christmasPayment").value = ""; // Limpiar pago de navidad
    document.getElementById("productSale").value = ""; // Limpiar venta de producto
    document.getElementById("productionIncentive").value = ""; // Limpiar producción
    document.getElementById("punctualityIncentive").value = ""; // Limpiar puntualidad
    document.getElementById("licenseDay").value = ""; // Limpiar día de licencia
    document.getElementById("insurance").value = ""; // Limpiar seguro
    document.getElementById("employeePaymentDate").value = ""; // Limpiar fecha de pago
    document.getElementById("employeePaymentTime").value = ""; // Limpiar hora de pago
    document.getElementById("totalAmount").value = ""; // Limpiar total
    // Desmarcar el checkbox y deshabilitar el campo de venta de producto
    document.getElementById("resetProductsSoldCheckbox").checked = false;
    document.getElementById("productSale").disabled = true;
    document.getElementById("productSale").style.backgroundColor = "#f0f0f0";
    document.getElementById("productSale").style.color = "#888";
    document.getElementById("productSale").value = "";
  };

  // Evento para filtrar transacciones al hacer clic en el botón de filtrar
  filterButton.addEventListener("click", () => {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    // Verificar si hay fechas seleccionadas
    if (startDate || endDate) {
      loadTransactions(); // Cargar transacciones con los filtros aplicados
      filterButton.classList.add("active"); // Agregar la clase 'active' al botón
    } else {
      alert("Por favor, selecciona al menos una fecha."); // Mensaje de advertencia si no hay fechas
    }
  });

  // Evento para restablecer los filtros de fecha
  document.getElementById("resetFilterButton").addEventListener("click", () => {
    setDefaultDates(); // Establecer fechas por defecto en lugar de vacías
    loadTransactions(); // Cargar transacciones sin filtros
    filterButton.classList.remove("active"); // Quitar la clase 'active' del botón
  });

  // Agregar eventos para quitar la clase 'active' si se borra la fecha
  document.getElementById("startDate").addEventListener("input", () => {
    if (!document.getElementById("startDate").value && !document.getElementById("endDate").value) {
      filterButton.classList.remove("active"); // Quitar la clase 'active' si ambos campos están vacíos
    }
  });

  document.getElementById("endDate").addEventListener("input", () => {
    if (!document.getElementById("startDate").value && !document.getElementById("endDate").value) {
      filterButton.classList.remove("active"); // Quitar la clase 'active' si ambos campos están vacíos
    }
  });

  // Función para abrir el modal de edición de transacción
  const openEditTransactionModal = (transaction) => {
    document.getElementById("editTransactionId").value = transaction.id;
    document.getElementById("editTransactionType").value = transaction.type;
    document.getElementById("editTransactionAmount").value = transaction.amount;
    document.getElementById("editTransactionDate").value = transaction.date.toISOString().split('T')[0];
    document.getElementById("editTransactionTime").value = transaction.date.toTimeString().split(' ')[0].substring(0, 5);
    document.getElementById("editTransactionDetails").value = transaction.details;
    editTransactionModal.style.display = "block";
  };

  // Evento para cerrar el modal de edición
  closeEditModal.addEventListener("click", () => {
    editTransactionModal.style.display = "none";
  });

  // Función para abrir el modal de edición de facturas
  const openEditInvoiceModal = (invoice) => {
    document.getElementById("editInvoiceId").value = invoice.id; // Asegúrate de que 'id' esté presente
    document.getElementById("editClientName").value = invoice.clientName || ''; // Usa un valor por defecto si es undefined
    document.getElementById("editClientPhone").value = invoice.clientPhone || '';
    document.getElementById("editClientAddress").value = invoice.clientAddress || '';
    document.getElementById("editEmployeeName").value = invoice.NombreEmpleado || '';

    // Asegúrate de que deliveryOption esté correctamente estructurado
    if (invoice.deliveryOption && invoice.deliveryOption.length > 0) {
      document.getElementById("editDeliveryName").value = invoice.deliveryOption[0].name || '';
      document.getElementById("editDeliveryPrice").value = invoice.deliveryOption[0].price || '';
    } else {
      document.getElementById("editDeliveryName").value = '';
      document.getElementById("editDeliveryPrice").value = '';
    }

    editInvoiceModal.style.display = "block"; // Mostrar el modal
  };

  document.getElementById("closeInvoiceModal").addEventListener("click", () => {
    editInvoiceModal.style.display = "none";
  });

  document.getElementById("saveInvoiceButton").addEventListener("click", () => {
    const id = document.getElementById("editInvoiceId").value;
    const clientName = document.getElementById("editClientName").value;
    const clientPhone = document.getElementById("editClientPhone").value;
    const clientAddress = document.getElementById("editClientAddress").value;
    const employeeName = document.getElementById("editEmployeeName").value;
    const deliveryName = document.getElementById("editDeliveryName").value;
    const deliveryPrice = document.getElementById("editDeliveryPrice").value; // Se mantiene como cadena

    // Actualizar la factura en Firestore
    db.collection("facturas").where("id", "==", id).get()
      .then((querySnapshot) => {
        if (!querySnapshot.empty) {
          const doc = querySnapshot.docs[0];
          return doc.ref.update({
            clientName,
            clientPhone,
            clientAddress,
            NombreEmpleado: employeeName,
            deliveryOption: [{ name: deliveryName, price: deliveryPrice }] // Se envía como cadena
          });
        } else {
          throw new Error("No se encontró la factura con el ID proporcionado.");
        }
      })
      .then(() => {
        alert("Factura actualizada correctamente.");
        editInvoiceModal.style.display = "none";
        loadTransactions(); // Recargar transacciones
      })
      .catch((error) => {
        console.error("Error al actualizar la factura: ", error);
        alert("Hubo un problema al actualizar la factura.");
      });
  });

  // Función para cargar los nombres de empleados desde Firestore
  const loadEmployeeNames = () => {
    const employeeSelect = document.getElementById("employeeName");
    employeeSelect.innerHTML = ""; // Limpiar opciones existentes

    // Agregar opción por defecto
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = "Selecciona un empleado";
    employeeSelect.appendChild(defaultOption);

    // Consultar la colección "empleados"
    db.collection("empleados").get().then((snapshot) => {
      snapshot.forEach((doc) => {
        const data = doc.data();
        const option = document.createElement("option");
        option.value = data.nombre; // Asumiendo que el campo se llama "nombre"
        option.textContent = data.nombre; // Mostrar el nombre en el select
        employeeSelect.appendChild(option);
      });
    }).catch((error) => {
      console.error("Error al cargar empleados: ", error);
    });
  };

  // Evento para habilitar/deshabilitar el campo de venta de producto
  document.getElementById("resetProductsSoldCheckbox").addEventListener("change", function () {
    const productSaleInput = document.getElementById("productSale");
    if (this.checked) {
      productSaleInput.disabled = false;
      productSaleInput.style.backgroundColor = "";
      productSaleInput.style.color = "";
    } else {
      productSaleInput.disabled = true;
      productSaleInput.style.backgroundColor = "#f0f0f0";
      productSaleInput.style.color = "#888";
      productSaleInput.value = ""; // Limpiar el valor cuando se desmarca
    }
  });

  // Función para cargar los productos vendidos por el empleado seleccionado
  const loadProductsSoldByEmployee = (employeeName) => {
    const productsSoldAmount = document.getElementById("productsSoldAmount");
    const productsSoldTimestamp = document.getElementById("productsSoldTimestamp");

    if (!employeeName) {
      productsSoldAmount.textContent = "0";
      productsSoldTimestamp.textContent = "";
      return;
    }

    db.collection("ventaproductos")
      .where("empleado", "==", employeeName)
      .get()
      .then((querySnapshot) => {
        let totalAmount = 0;
        let latestTimestamp = null;

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          totalAmount += parseFloat(data.monto) || 0;

          // Obtener el timestamp más reciente
          if (data.timestamp) {
            const docTimestamp = data.timestamp.toDate();
            if (!latestTimestamp || docTimestamp > latestTimestamp) {
              latestTimestamp = docTimestamp;
            }
          }
        });

        productsSoldAmount.textContent = `${totalAmount}`;

        // Mostrar la fecha y hora del timestamp más reciente
        if (latestTimestamp) {
          const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          };
          productsSoldTimestamp.textContent = `Último pago de incentivo por ventas: ${latestTimestamp.toLocaleDateString('es-DO', options)}`;
        } else {
          productsSoldTimestamp.textContent = "";
        }
      })
      .catch((error) => {
        console.error("Error al cargar productos vendidos:", error);
        productsSoldAmount.textContent = "Error";
        productsSoldTimestamp.textContent = "";
      });
  };

  // Modifica el evento change del select de empleados para cargar los productos vendidos
  document.getElementById("employeeName").addEventListener("change", function () {
    loadProductsSoldByEmployee(this.value);
  });

  // También llama a la función cuando se abre el modal para actualizar si ya hay un empleado seleccionado
  document.getElementById("addTransactionButton").addEventListener("click", () => {
    loadEmployeeNames();
    const employeeName = document.getElementById("employeeName").value;
    loadProductsSoldByEmployee(employeeName);
    addTransactionModal.style.display = "block";
  });

  // Evento para guardar cambios en la transacción
  saveTransactionButton.addEventListener("click", () => {
    const id = document.getElementById("editTransactionId").value;
    const type = document.getElementById("editTransactionType").value;
    const amount = parseFloat(document.getElementById("editTransactionAmount").value);
    const dateInput = document.getElementById("editTransactionDate").value;
    const timeInput = document.getElementById("editTransactionTime").value;
    const details = document.getElementById("editTransactionDetails").value;

    if (!isNaN(amount) && dateInput && timeInput) {
      const [year, month, day] = dateInput.split('-');
      const [hours, minutes] = timeInput.split(':');
      const timestamp = new Date(year, month - 1, day, hours, minutes);

      db.collection("transacciones").where("id", "==", id).get()
        .then((querySnapshot) => {
          if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            return doc.ref.update({
              type,
              amount,
              timestamp, // Asegúrate de que este campo sea correcto
              details
            });
          } else {
            throw new Error("No se encontró la transacción con el ID proporcionado.");
          }
        })
        .then(() => {
          alert("Transacción actualizada correctamente.");
          editTransactionModal.style.display = "none";
          loadTransactions(); // Recargar transacciones
        })
        .catch((error) => {
          console.error("Error al actualizar la transacción: ", error);
          alert("Hubo un problema al actualizar la transacción.");
        });
    } else {
      alert("Por favor, completa todos los campos correctamente.");
    }
  });

  // Evento para abrir el modal de agregar transacción
  document.getElementById("addTransactionButton").addEventListener("click", () => {
    addTransactionModal.style.display = "block";
  });

  submitTransactionButton.addEventListener("click", addTransaction);

  // Evento para cerrar el modal de agregar transacción
  closeModal.addEventListener("click", () => {
    addTransactionModal.style.display = "none";
  });

  // Evento para filtrar transacciones al cambiar el select de tipo
  document.getElementById("transactionTypeFilter").addEventListener("change", loadTransactions);

  // Código para mostrar/ocultar campos de Pago de Empleado
  document.getElementById("transactionType").addEventListener("change", function () {
    const employeePaymentFields = document.getElementById("employeePaymentFields");
    const normalTransactionFields = document.getElementById("normalTransactionFields");

    if (this.value === "employeePayment") {
      employeePaymentFields.style.display = "block"; // Mostrar campos de pago de empleado
      normalTransactionFields.style.display = "none"; // Ocultar campos de transacción normal
    } else {
      employeePaymentFields.style.display = "none"; // Ocultar campos de pago de empleado
      normalTransactionFields.style.display = "block"; // Mostrar campos de transacción normal
    }
  });

  // Función para calcular el total en tiempo real
  const calculateTotal = () => {
    const salaryPayment = parseFloat(document.getElementById("salaryPayment").value) || 0;
    const holidayPayment = parseFloat(document.getElementById("holidayPayment").value) || 0;
    const overtimePayment = parseFloat(document.getElementById("overtimePayment").value) || 0;
    const vacationPayment = parseFloat(document.getElementById("vacationPayment").value) || 0;
    const christmasPayment = parseFloat(document.getElementById("christmasPayment").value) || 0;
    const productSale = parseFloat(document.getElementById("productSale").value) || 0;
    const productionIncentive = parseFloat(document.getElementById("productionIncentive").value) || 0;
    const punctualityIncentive = parseFloat(document.getElementById("punctualityIncentive").value) || 0;
    const licenseDay = parseFloat(document.getElementById("licenseDay").value) || 0;
    const insurance = parseFloat(document.getElementById("insurance").value) || 0;

    const total = salaryPayment + holidayPayment + overtimePayment + vacationPayment + christmasPayment +
      productSale + productionIncentive + punctualityIncentive - licenseDay - insurance;

    document.getElementById("totalAmount").value = total.toFixed(2); // Actualizar el total
  };

  // Agregar eventos para calcular el total en tiempo real
  document.querySelectorAll("#employeePaymentFields input[type='number']").forEach(input => {
    input.addEventListener("input", calculateTotal);
  });

  // Evento para filtrar transacciones al hacer clic en el botón de filtrar
  filterButton.addEventListener("click", loadTransactions);

  // Función para contar las transacciones visibles y actualizar el resumen
  const countVisibleTransactionsAndUpdateSummary = () => {
    const combinedTransactionList = document.getElementById("combinedTransactionList");
    const rows = combinedTransactionList.getElementsByTagName("tr");
    let visibleCount = 0;
    let totalIncome = 0;
    let totalExpenses = 0;

    // Contar las filas visibles y calcular totales
    for (let i = 0; i < rows.length; i++) {
      const checkbox = rows[i].querySelector(".transaction-checkbox");
      if (rows[i].offsetParent !== null && checkbox.checked) { // Verifica si la fila es visible y el checkbox está marcado
        visibleCount++;
        const amount = parseFloat(rows[i].cells[4].textContent.replace('RD$', '').replace(',', ''));
        const type = rows[i].cells[2].textContent; // Tipo de transacción

        if (type === "Ingreso") {
          totalIncome += amount;
        } else {
          totalExpenses += amount;
        }
      }
    }

    // Actualizar el conteo en el DOM
    const visibleCountElement = document.getElementById("visibleTransactionCount");
    visibleCountElement.textContent = `Transacciones visibles: ${visibleCount}`;

    // Actualizar resumen
    updateSummary(totalIncome, totalExpenses);
  };

  // Función para buscar transacciones en tiempo real
  const searchTransactions = () => {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    const combinedTransactionList = document.getElementById("combinedTransactionList");
    const rows = combinedTransactionList.getElementsByTagName("tr");

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const id = row.cells[1].textContent.toLowerCase();
      const details = row.cells[3].textContent.toLowerCase();
      const amount = row.cells[4].textContent.toLowerCase();

      if (id.includes(searchTerm) || details.includes(searchTerm) || amount.includes(searchTerm)) {
        row.style.display = "";
        row.querySelector(".transaction-checkbox").checked = true;

        // Resaltar coincidencias
        row.cells[1].innerHTML = highlightMatches(row.cells[1].textContent, searchTerm);
        row.cells[3].innerHTML = highlightMatches(row.cells[3].textContent, searchTerm);
        row.cells[4].innerHTML = highlightMatches(row.cells[4].textContent, searchTerm);
      } else {
        row.style.display = "none";
        row.querySelector(".transaction-checkbox").checked = false;
      }
    }

    countVisibleTransactionsAndUpdateSummary();
  };

  // Evento para buscar transacciones al escribir en el input
  document.getElementById("searchInput").addEventListener("input", searchTransactions);

  const highlightMatches = (text, searchTerm) => {
    if (!searchTerm) return text;
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
  };

  // Función para abrir el modal de edición de pago de empleado
  const openEditEmployeePaymentModal = (payment) => {
    document.getElementById("editEmployeePaymentId").value = payment.id;
    document.getElementById("editEmployeePaymentName").value = payment.employeeName;
    document.getElementById("editSalaryPayment").value = payment.salaryPayment;
    document.getElementById("editHolidayPayment").value = payment.holidayPayment;
    document.getElementById("editOvertimePayment").value = payment.overtimePayment;
    document.getElementById("editVacationPayment").value = payment.vacationPayment;
    document.getElementById("editChristmasPayment").value = payment.christmasPayment;
    document.getElementById("editProductSale").value = payment.productSale;
    document.getElementById("editProductionIncentive").value = payment.productionIncentive;
    document.getElementById("editPunctualityIncentive").value = payment.punctualityIncentive;
    document.getElementById("editLicenseDay").value = payment.licenseDay;
    document.getElementById("editInsurance").value = payment.insurance;

    // Calcular total al abrir el modal
    calculateEditTotal();

    // Mostrar el modal
    document.getElementById("editEmployeePaymentModal").style.display = "block";
  };

  // Evento para cerrar el modal de edición
  document.getElementById("closeEditEmployeeModal").addEventListener("click", () => {
    document.getElementById("editEmployeePaymentModal").style.display = "none";
  });

  // Función para calcular el total en tiempo real en el modal de edición
  const calculateEditTotal = () => {
    const salaryPayment = parseFloat(document.getElementById("editSalaryPayment").value) || 0;
    const holidayPayment = parseFloat(document.getElementById("editHolidayPayment").value) || 0;
    const overtimePayment = parseFloat(document.getElementById("editOvertimePayment").value) || 0;
    const vacationPayment = parseFloat(document.getElementById("editVacationPayment").value) || 0;
    const christmasPayment = parseFloat(document.getElementById("editChristmasPayment").value) || 0;
    const productSale = parseFloat(document.getElementById("editProductSale").value) || 0;
    const productionIncentive = parseFloat(document.getElementById("editProductionIncentive").value) || 0;
    const punctualityIncentive = parseFloat(document.getElementById("editPunctualityIncentive").value) || 0;
    const licenseDay = parseFloat(document.getElementById("editLicenseDay").value) || 0;
    const insurance = parseFloat(document.getElementById("editInsurance").value) || 0;

    const total = salaryPayment + holidayPayment + overtimePayment + vacationPayment + christmasPayment +
      productSale + productionIncentive + punctualityIncentive - licenseDay - insurance;

    document.getElementById("editTotalAmount").value = total.toFixed(2); // Actualizar el total
  };

  // Agregar eventos para calcular el total en tiempo real en el modal de edición
  document.querySelectorAll("#editEmployeePaymentModal input[type='number']").forEach(input => {
    input.addEventListener("input", calculateEditTotal);
  });

  // Evento para guardar cambios en el pago de empleado
  document.getElementById("saveEmployeePaymentButton").addEventListener("click", () => {
    const id = document.getElementById("editEmployeePaymentId").value;
    const employeeName = document.getElementById("editEmployeePaymentName").value; // Usar el nuevo id
    const salaryPayment = parseFloat(document.getElementById("editSalaryPayment").value);
    const holidayPayment = parseFloat(document.getElementById("editHolidayPayment").value);
    const overtimePayment = parseFloat(document.getElementById("editOvertimePayment").value);
    const vacationPayment = parseFloat(document.getElementById("editVacationPayment").value);
    const christmasPayment = parseFloat(document.getElementById("editChristmasPayment").value);
    const productSale = parseFloat(document.getElementById("editProductSale").value);
    const productionIncentive = parseFloat(document.getElementById("editProductionIncentive").value);
    const punctualityIncentive = parseFloat(document.getElementById("editPunctualityIncentive").value);
    const licenseDay = parseFloat(document.getElementById("editLicenseDay").value);
    const insurance = parseFloat(document.getElementById("editInsurance").value);

    // Obtener la fecha y hora de pago
    const paymentDate = document.getElementById("editEmployeePaymentDate").value;
    const paymentTime = document.getElementById("editEmployeePaymentTime").value;

    // Validar que todos los campos sean correctos
    if (!isNaN(salaryPayment) && !isNaN(holidayPayment) && !isNaN(overtimePayment) &&
      !isNaN(vacationPayment) && !isNaN(christmasPayment) && !isNaN(productSale) &&
      !isNaN(productionIncentive) && !isNaN(punctualityIncentive) && !isNaN(licenseDay) &&
      !isNaN(insurance) && paymentDate && paymentTime) {

      // Crear objeto Date para la fecha y hora de pago
      const [year, month, day] = paymentDate.split('-');
      const [hours, minutes] = paymentTime.split(':');
      const paymentDateTime = new Date(year, month - 1, day, hours, minutes);

      // Actualizar el pago de empleado en Firestore
      db.collection("PagoEmpleado").where("id", "==", id).get()
        .then((querySnapshot) => {
          if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            return doc.ref.update({
              employeeName,
              salaryPayment,
              holidayPayment,
              overtimePayment,
              vacationPayment,
              christmasPayment,
              productSale,
              productionIncentive,
              punctualityIncentive,
              licenseDay,
              insurance,
              total: salaryPayment + holidayPayment + overtimePayment + vacationPayment + christmasPayment +
                productSale + productionIncentive + punctualityIncentive - licenseDay - insurance,
              timestamp: paymentDateTime // Asegúrate de usar 'timestamp' aquí
            });
          } else {
            throw new Error("No se encontró el pago de empleado con el ID proporcionado.");
          }
        })
        .then(() => {
          alert("Pago de empleado actualizado correctamente.");
          document.getElementById("editEmployeePaymentModal").style.display = "none";
          loadTransactions(); // Recargar transacciones
        })
        .catch((error) => {
          console.error("Error al actualizar el pago de empleado: ", error);
          alert("Hubo un problema al actualizar el pago de empleado.");
        });
    } else {
      alert("Por favor, completa todos los campos correctamente.");
    }
  });

  // Cargar datos del pago de empleado al abrir el modal
  const loadEmployeePaymentData = (id) => {
    db.collection("PagoEmpleado").where("id", "==", id).get()
      .then((querySnapshot) => {
        if (!querySnapshot.empty) {
          const payment = querySnapshot.docs[0].data();
          openEditEmployeePaymentModal({
            id: payment.id,
            employeeName: payment.employeeName,
            salaryPayment: payment.salaryPayment,
            holidayPayment: payment.holidayPayment,
            overtimePayment: payment.overtimePayment,
            vacationPayment: payment.vacationPayment,
            christmasPayment: payment.christmasPayment,
            productSale: payment.productSale,
            productionIncentive: payment.productionIncentive,
            punctualityIncentive: payment.punctualityIncentive,
            licenseDay: payment.licenseDay,
            insurance: payment.insurance,
            date: payment.timestamp.toDate() // Asegúrate de que esto esté en formato Date
          });

          // Llenar los campos de fecha y hora
          const paymentDate = payment.timestamp.toDate();

          // Obtener la fecha en formato local
          const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
          const localDate = paymentDate.toLocaleDateString('es-DO', options);

          // Cambiar el formato a YYYY-MM-DD
          const formattedDate = localDate.split('/').reverse().join('-'); // Cambia el formato a YYYY-MM-DD
          document.getElementById("editEmployeePaymentDate").value = formattedDate;

          // Establecer la hora
          document.getElementById("editEmployeePaymentTime").value = paymentDate.toTimeString().split(' ')[0].substring(0, 5);
        } else {
          alert("No se encontró el pago de empleado.");
        }
      })
      .catch((error) => {
        console.error("Error al cargar el pago de empleado: ", error);
      });
  };

  // Función para eliminar una transacción
  const deleteTransaction = (id) => {
    if (confirm("¿Estás seguro de que deseas eliminar esta transacción?")) {
      db.collection("transacciones").where("id", "==", id).get()
        .then((querySnapshot) => {
          if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            return doc.ref.delete(); // Eliminar el documento
          } else {
            throw new Error("No se encontró la transacción con el ID proporcionado.");
          }
        })
        .then(() => {
          alert("Transacción eliminada correctamente.");
          editTransactionModal.style.display = "none"; // Cerrar el modal
          loadTransactions(); // Recargar las transacciones
        })
        .catch((error) => {
          console.error("Error al eliminar la transacción: ", error);
          alert("Hubo un problema al eliminar la transacción.");
        });
    }
  };

  // Función para eliminar una factura
  const deleteInvoice = (id) => {
    if (confirm("¿Estás seguro de que deseas eliminar esta factura?")) {
      db.collection("facturas").where("id", "==", id).get()
        .then((querySnapshot) => {
          if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            return doc.ref.delete(); // Eliminar el documento
          } else {
            throw new Error("No se encontró la factura con el ID proporcionado.");
          }
        })
        .then(() => {
          alert("Factura eliminada correctamente.");
          editInvoiceModal.style.display = "none"; // Cerrar el modal
          loadTransactions(); // Recargar las transacciones
        })
        .catch((error) => {
          console.error("Error al eliminar la factura: ", error);
          alert("Hubo un problema al eliminar la factura.");
        });
    }
  };

  // Función para eliminar un pago de empleado
  const deleteEmployeePayment = (id) => {
    if (confirm("¿Estás seguro de que deseas eliminar este pago de empleado?")) {
      db.collection("PagoEmpleado").where("id", "==", id).get()
        .then((querySnapshot) => {
          if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            return doc.ref.delete(); // Eliminar el documento
          } else {
            throw new Error("No se encontró el pago de empleado con el ID proporcionado.");
          }
        })
        .then(() => {
          alert("Pago de empleado eliminado correctamente.");
          editEmployeePaymentModal.style.display = "none"; // Cerrar el modal
          loadTransactions(); // Recargar las transacciones
        })
        .catch((error) => {
          console.error("Error al eliminar el pago de empleado: ", error);
          alert("Hubo un problema al eliminar el pago de empleado.");
        });
    }
  };

  // Evento para eliminar la transacción
  document.getElementById("deleteTransactionButton").addEventListener("click", () => {
    const id = document.getElementById("editTransactionId").value; // Obtener el ID de la transacción
    deleteTransaction(id); // Llamar a la función de eliminación
  });

  // Evento para eliminar la factura
  document.getElementById("deleteInvoiceButton").addEventListener("click", () => {
    const id = document.getElementById("editInvoiceId").value; // Obtener el ID de la factura
    deleteInvoice(id); // Llamar a la función de eliminación
  });

  // Evento para eliminar el pago de empleado
  document.getElementById("deleteEmployeePaymentButton").addEventListener("click", () => {
    const id = document.getElementById("editEmployeePaymentId").value; // Obtener el ID del pago de empleado
    deleteEmployeePayment(id); // Llamar a la función de eliminación
  });

  // Cargar transacciones al inicio
  loadTransactions();
</script>

    <script src="./js/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</body>

</html>

<!-- 4 -->